<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>qepi. - Packing Planner</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%23CCE51D'/%3E%3Ctext x='50' y='72' font-family='Arial, sans-serif' font-size='65' font-weight='700' fill='white' text-anchor='middle'%3Eq%3C/text%3E%3C/svg%3E">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.cdnfonts.com/css/sugo-pro-display" rel="stylesheet">
    <style>
        :root {
            /* ===== MATERIAL DESIGN 3 TOKENS ===== */
            
            /* Typography Scale - Fluid & Responsive */
            --text-xs: clamp(0.625rem, 0.6rem + 0.15vw, 0.6875rem);   /* 10-11px */
            --text-sm: clamp(0.75rem, 0.72rem + 0.2vw, 0.8125rem);    /* 12-13px */
            --text-base: clamp(0.8125rem, 0.78rem + 0.2vw, 0.875rem); /* 13-14px */
            --text-lg: clamp(0.9375rem, 0.9rem + 0.25vw, 1.0625rem);  /* 15-17px */
            --text-xl: clamp(1.125rem, 1.05rem + 0.35vw, 1.375rem);   /* 18-22px */
            --text-2xl: clamp(1.5rem, 1.35rem + 0.75vw, 2rem);        /* 24-32px */
            --text-3xl: clamp(2rem, 1.75rem + 1.25vw, 2.75rem);       /* 32-44px */
            
            /* Fixed Typography for Specific Cases */
            --text-fixed-9: 9px;
            --text-fixed-10: 10px;
            --text-fixed-11: 11px;
            --text-fixed-12: 12px;
            --text-fixed-13: 13px;
            --text-fixed-14: 14px;
            --text-fixed-15: 15px;
            --text-fixed-16: 16px;
            --text-fixed-18: 18px;
            --text-fixed-20: 20px;
            --text-fixed-22: 22px;
            --text-fixed-24: 24px;
            --text-fixed-28: 28px;
            --text-fixed-32: 32px;
            --text-fixed-36: 36px;
            
            /* Spacing Scale (4px Grid System) */
            --spacing-0: 0;
            --spacing-1: 2px;
            --spacing-2: 4px;
            --spacing-3: 6px;
            --spacing-4: 8px;
            --spacing-6: 10px;
            --spacing-8: 12px;
            --spacing-10: 14px;
            --spacing-12: 16px;
            --spacing-14: 20px;
            --spacing-15: 22px;
            --spacing-16: 24px;
            --spacing-20: 25px;
            --spacing-24: 30px;
            --spacing-25: 32px;
            --spacing-28: 35px;
            --spacing-32: 40px;
            --spacing-40: 50px;
            --spacing-48: 55px;
            --spacing-56: 60px;
            
            /* Border Radius (Shape Scale) */
            --radius-none: 0;
            --radius-xs: 4px;
            --radius-sm: 8px;
            --radius-md: 10px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --radius-2xl: 20px;
            --radius-3xl: 24px;
            --radius-full: 50%;
            --radius-round: 9999px;
            
            /* Elevation (Box Shadows) */
            --shadow-none: none;
            --shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 2px 8px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 4px 15px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 10px 40px rgba(0, 0, 0, 0.15);
            --shadow-2xl: 0 10px 40px rgba(0, 0, 0, 0.1);
            --shadow-sidebar: 2px 0 10px rgba(0, 0, 0, 0.05);
            
            /* Accent-specific Shadows */
            --shadow-accent-sm: 0 3px 12px var(--accent-shadow);
            --shadow-accent-md: 0 4px 16px var(--accent-shadow);
            --shadow-accent-focus: 0 0 0 3px var(--accent-light);
            
            /* Motion & Transitions */
            --duration-instant: 0s;
            --duration-fast: 0.15s;
            --duration-normal: 0.2s;
            --duration-medium: 0.3s;
            --duration-slow: 0.3s;
            --easing-standard: ease;
            --easing-smooth: cubic-bezier(0.2, 0, 0, 1);
            
            /* Colors - Brand & Semantic */
            --accent-primary: #CCE51D;           /* Pear - primary accent */
            --accent-hover: #B8CC1A;             /* Pear darker (hover state) */
            --accent-light: #F5FADB;             /* Pear tint (light backgrounds) */
            --accent-shadow: rgba(204, 229, 29, 0.3);
            
            --accent-secondary: #0E6BA8;         /* Bice blue - secondary accent */
            --accent-secondary-hover: #0C5A8E;   /* Bice blue darker */
            --accent-secondary-light: #E6F1F8;   /* Bice blue tint */
            --accent-secondary-shadow: rgba(14, 107, 168, 0.3);
            
            --accent-tertiary: #FB4B4E;          /* Imperial red - tertiary/error */
            --accent-tertiary-hover: #E03D40;    /* Imperial red darker */
            --accent-tertiary-light: #FEECED;    /* Imperial red tint */
            --accent-tertiary-shadow: rgba(251, 75, 78, 0.3);
            
            --accent-quaternary: #EEE5E9;        /* Lavender blush - quaternary accent */
            --accent-quaternary-hover: #DDD0D5;  /* Lavender darker */
            --accent-quaternary-text: #8B6B7A;   /* Lavender text color */
            --accent-quaternary-shadow: rgba(238, 229, 233, 0.4);
            
            /* Neutral Colors */
            --color-white: #FFFFFF;
            --color-black: #000000;              /* Pure black for specific elements */
            --color-gray-50: #f8f9fa;
            --color-gray-100: #f5f7fa;           /* Subtle backgrounds */
            --color-gray-200: #f0f0f0;
            --color-gray-300: #e8e8e8;
            --color-gray-400: #e0e0e0;
            --color-gray-500: #ccc;
            --color-gray-600: #999;
            --color-gray-700: #666;
            --color-gray-800: #1a1a1a;           /* Keep for text */
            
            /* Semantic Colors */
            --color-error: #FB4B4E;              /* Imperial red */
            --color-error-bg: #FEECED;           /* Imperial red tint */
            --color-success: #CCE51D;            /* Pear */
            --color-info: #0E6BA8;               /* Bice blue */
            --color-warning: #FB4B4E;            /* Imperial red */
            
            /* Opacity Levels */
            --opacity-disabled: 0.4;
            --opacity-hover: 0.8;
            --opacity-overlay: 0.95;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--color-gray-100);
            min-height: 100vh;
            padding: var(--spacing-0);
            display: flex;
            font-size: var(--text-base);
        }

        .app-layout {
            display: flex;
            width: 100%;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: var(--color-white);
            padding: var(--spacing-24) var(--spacing-14);
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-lg);
            position: fixed;
            height: calc(100vh - var(--spacing-32));
            overflow-y: auto;
            margin: var(--spacing-12);
            border-radius: var(--radius-2xl);
        }

        .sidebar-logo {
            padding: var(--spacing-0) var(--spacing-0) var(--spacing-14) var(--spacing-0);
            margin-bottom: var(--spacing-14);
            border-bottom: 1px solid var(--color-gray-200);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: opacity var(--duration-medium) var(--easing-standard);
            font-family: 'Sugo Pro Display', sans-serif;
            font-size: 40px;
            font-weight: 900;
            color: var(--accent-primary);
            letter-spacing: -3px;
            text-transform: lowercase;
        }

        .sidebar-logo:hover {
            opacity: var(--opacity-hover);
        }

        .sidebar-logo svg {
            display: block;
        }

        .sidebar-profile {
            display: flex;
            align-items: center;
            gap: var(--spacing-8);
            margin-bottom: var(--spacing-20);
            padding-bottom: var(--spacing-14);
            border-bottom: 1px solid var(--color-gray-200);
        }

        .sidebar-profile-pic {
            width: clamp(40px, 10vw, 48px);
            height: clamp(40px, 10vw, 48px);
            border-radius: var(--radius-lg);
            overflow: hidden;
            background: var(--accent-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-white);
            font-weight: 600;
            font-size: var(--text-lg);
        }

        .sidebar-profile-info h3 {
            font-size: var(--text-base);
            color: var(--color-black);
            margin-bottom: var(--spacing-1);
        }

        .sidebar-profile-info p {
            font-size: var(--text-xs);
            color: var(--color-gray-600);
        }

        .sidebar-section {
            margin-bottom: var(--spacing-20);
        }

        .sidebar-section-title {
            font-size: var(--text-xs);
            color: var(--color-gray-600);
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: var(--spacing-8);
        }

        .sidebar-trips-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-4);
        }

        .sidebar-trip-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-8);
            padding: var(--spacing-6) var(--spacing-8);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--duration-normal) var(--easing-standard);
        }

        .sidebar-trip-item:hover {
            background: var(--color-gray-50);
        }

        .sidebar-trip-item.active {
            background: var(--accent-light);
            border-left: 3px solid var(--accent-primary);
        }

        .trip-flag {
            font-size: var(--text-lg);
        }

        .trip-info h4 {
            font-size: var(--text-sm);
            color: var(--color-black);
            margin-bottom: var(--spacing-1);
        }

        .trip-info p {
            font-size: var(--text-xs);
            color: var(--color-gray-600);
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-2);
            flex: 1;
        }

        .sidebar-nav-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-8);
            padding: var(--spacing-8) var(--spacing-10);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--duration-normal) var(--easing-standard);
            color: var(--color-gray-700);
            font-size: var(--text-sm);
            font-weight: 600;
        }

        .sidebar-nav-item:hover {
            background: var(--color-gray-50);
            color: var(--color-black);
        }

        .sidebar-nav-item.active {
            background: var(--accent-light);
            color: var(--accent-primary);
        }

        .sidebar-nav-item .icon {
            width: var(--spacing-14);
            text-align: center;
            font-size: var(--text-fixed-18);
        }

        .badge-new {
            background: var(--color-info);
            color: var(--color-white);
            font-size: var(--text-fixed-9);
            padding: var(--spacing-3) var(--spacing-4);
            border-radius: var(--radius-round);
            font-weight: 700;
            text-transform: uppercase;
            margin-left: auto;
        }

        .sidebar-language {
            margin-top: auto;
            padding-top: var(--spacing-15);
        }

        .lang-toggle {
            display: flex;
            align-items: center;
            background: var(--color-gray-100);
            border-radius: var(--radius-round);
            padding: var(--spacing-2);
            gap: var(--spacing-2);
            border: 1px solid var(--color-gray-300);
        }

        .lang-option {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-1);
            padding: var(--spacing-2) var(--spacing-4);
            background: transparent;
            border: none;
            border-radius: var(--radius-round);
            cursor: pointer;
            font-size: var(--text-fixed-10);
            font-weight: 600;
            color: var(--color-gray-600);
            transition: all var(--duration-normal) var(--easing-standard);
            position: relative;
        }

        .lang-option .flag {
            font-size: var(--text-fixed-14);
        }

        .lang-option .lang-code {
            font-size: var(--text-fixed-10);
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .lang-option:hover {
            color: var(--color-gray-800);
        }

        .lang-option.active {
            background: var(--color-white);
            color: var(--accent-primary);
            box-shadow: var(--shadow-sm);
        }

        .sidebar-logout {
            padding-top: var(--spacing-15);
            border-top: 1px solid var(--color-gray-200);
            margin-top: var(--spacing-15);
        }

        .logout-btn {
            display: flex;
            align-items: center;
            gap: var(--spacing-8);
            padding: var(--spacing-8) var(--spacing-10);
            background: transparent;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            color: var(--color-error);
            font-size: var(--text-sm);
            font-weight: 600;
            width: 100%;
            transition: all var(--duration-normal) var(--easing-standard);
        }

        .logout-btn:hover {
            background: var(--color-error-bg);
        }

        /* Main Content */
        .main-content {
            margin-left: 292px;
            flex: 1;
            padding: var(--spacing-32) var(--spacing-40);
            overflow-y: auto;
        }

        .container {
            max-width: 1200px;
        }

        /* Page Header */
        .page-header {
            margin-bottom: var(--spacing-25);
        }

        .greeting {
            font-size: var(--text-2xl);
            font-weight: 600;
            color: var(--color-black);
            margin-bottom: var(--spacing-3);
            letter-spacing: -0.5px;
        }

        .greeting-wave {
            display: inline-block;
        }

        .subheading {
            font-size: var(--text-base);
            color: var(--color-gray-600);
        }

        /* API Setup Banner */
        .api-banner {
            background: linear-gradient(135deg, var(--color-info) 0%, #764ba2 100%);
            color: var(--color-white);
            padding: var(--spacing-12) var(--spacing-16);
            border-radius: var(--radius-lg);
            margin-bottom: var(--spacing-20);
            display: flex;
            align-items: center;
            gap: var(--spacing-8);
            box-shadow: var(--shadow-lg);
        }

        .api-banner-icon {
            font-size: var(--text-fixed-24);
            flex-shrink: 0;
        }

        .api-banner-content {
            flex: 1;
        }

        .api-banner-content h4 {
            margin: var(--spacing-0) var(--spacing-0) var(--spacing-3) var(--spacing-0);
            font-size: var(--text-base);
            font-weight: 600;
        }

        .api-banner-content p {
            margin: var(--spacing-0);
            font-size: var(--text-sm);
            opacity: var(--opacity-overlay);
            line-height: 1.5;
        }

        .api-banner-link {
            color: var(--color-white);
            text-decoration: underline;
            font-weight: 600;
        }

        .api-banner-link:hover {
            opacity: var(--opacity-hover);
        }

        .api-banner-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: var(--color-white);
            width: var(--spacing-24);
            height: var(--spacing-24);
            border-radius: var(--radius-full);
            cursor: pointer;
            font-size: var(--text-fixed-18);
            line-height: 1;
            flex-shrink: 0;
            transition: all var(--duration-medium) var(--easing-standard);
        }

        .api-banner-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .top-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-24);
        }

        .action-buttons {
            display: flex;
            gap: var(--spacing-8);
        }

        .icon-btn {
            width: var(--spacing-32);
            height: var(--spacing-32);
            border-radius: var(--radius-full);
            background: var(--color-white);
            border: 1px solid var(--color-gray-400);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--duration-medium) var(--easing-standard);
            font-size: var(--text-fixed-16);
        }

        .icon-btn:hover {
            background: var(--color-gray-50);
            border-color: var(--accent-primary);
            transform: scale(1.05);
        }

        .lang-selector {
            padding: var(--spacing-4) var(--spacing-12);
            border: 1px solid var(--color-gray-400);
            border-radius: var(--radius-2xl);
            background: var(--color-white);
            color: var(--color-gray-700);
            cursor: pointer;
            font-size: var(--text-fixed-13);
            font-weight: 500;
            transition: all var(--duration-medium) var(--easing-standard);
        }

        .lang-selector:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .user-info {
            display: none;
        }

        /* Auth Screen */
        .auth-screen {
            max-width: 520px;
            margin: var(--spacing-56) auto;
            background: var(--color-white);
            padding: var(--spacing-56) var(--spacing-48);
            border-radius: var(--radius-3xl);
            box-shadow: var(--shadow-2xl);
            position: relative;
            z-index: 10;
        }

        .auth-logo {
            text-align: center;
            margin-bottom: var(--spacing-28);
            cursor: pointer;
            transition: opacity var(--duration-medium) var(--easing-standard);
        }

        .auth-logo:hover {
            opacity: var(--opacity-hover);
        }

        .auth-logo svg {
            filter: drop-shadow(0 4px 20px rgba(168, 208, 95, 0.25));
        }

        .auth-screen h2 {
            color: var(--color-black);
            margin-bottom: var(--spacing-28);
            text-align: center;
            font-size: var(--text-fixed-36);
            font-weight: 700;
        }

        .form-group {
            margin-bottom: var(--spacing-15);
        }

        .form-group label {
            display: block;
            margin-bottom: var(--spacing-6);
            color: var(--color-gray-700);
            font-weight: 500;
            font-size: var(--text-fixed-14);
        }

        .form-group input {
            width: 100%;
            padding: var(--spacing-10) var(--spacing-12);
            border: 1.5px solid var(--color-gray-400);
            border-radius: var(--radius-lg);
            font-size: var(--text-fixed-15);
            transition: all var(--duration-medium) var(--easing-standard);
            background: var(--color-white);
            color: var(--color-black);
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: var(--shadow-accent-focus);
        }

        .form-group input::placeholder {
            color: #bbb;
        }

        /* Autocomplete Suggestions */
        .autocomplete-container {
            position: relative;
        }

        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--color-white);
            border: 2px solid var(--color-gray-400);
            border-top: none;
            border-radius: var(--radius-none) var(--radius-none) var(--radius-lg) var(--radius-lg);
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: var(--shadow-lg);
            display: none;
        }

        .autocomplete-suggestions.active {
            display: block;
        }

        .autocomplete-item {
            padding: var(--spacing-8) var(--spacing-12);
            cursor: pointer;
            transition: all var(--duration-normal) var(--easing-standard);
            border-bottom: 1px solid #f5f5f5;
            display: flex;
            align-items: center;
            gap: var(--spacing-6);
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover {
            background: var(--color-gray-50);
        }

        .autocomplete-item-icon {
            font-size: var(--text-fixed-16);
            opacity: 0.6;
        }

        .autocomplete-item-text {
            flex: 1;
        }

        .autocomplete-item-name {
            color: var(--color-black);
            font-weight: 500;
            font-size: var(--text-fixed-14);
        }

        .autocomplete-item-region {
            color: var(--color-gray-600);
            font-size: var(--text-fixed-12);
            margin-top: var(--spacing-1);
        }

        .autocomplete-loading {
            padding: var(--spacing-8) var(--spacing-12);
            text-align: center;
            color: var(--color-gray-600);
            font-size: var(--text-fixed-13);
        }

        .autocomplete-no-results {
            padding: var(--spacing-8) var(--spacing-12);
            text-align: center;
            color: var(--color-gray-600);
            font-size: var(--text-fixed-13);
        }

        .btn {
            width: 100%;
            padding: var(--spacing-15) var(--spacing-14);
            background: var(--accent-primary);
            color: var(--color-white);
            border: none;
            border-radius: var(--radius-lg);
            cursor: pointer;
            font-size: var(--text-fixed-16);
            font-weight: 600;
            transition: all var(--duration-medium) var(--easing-standard);
            box-shadow: var(--shadow-md);
        }

        .btn:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-accent-md);
        }

        .btn-secondary {
            background: var(--color-white);
            color: var(--accent-primary);
            border: 2px solid var(--accent-primary);
            margin-top: var(--spacing-8);
            box-shadow: var(--shadow-none);
        }

        .btn-secondary:hover {
            background: var(--accent-light);
        }

        /* Password Reset Links */
        .reset-password-link {
            text-align: center;
            margin-top: var(--spacing-12);
            font-size: var(--text-fixed-14);
        }

        .reset-password-link a {
            color: var(--accent-primary);
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
        }

        .reset-password-link a:hover {
            text-decoration: underline;
        }

        .back-to-login {
            text-align: center;
            margin-top: var(--spacing-14);
            font-size: var(--text-fixed-14);
            color: var(--color-gray-700);
        }

        .back-to-login a {
            color: var(--accent-primary);
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
        }

        .back-to-login a:hover {
            text-decoration: underline;
        }

        /* Landing Page Heading - Removed, using page-header instead */

        /* New Trip CTA Button */
        .new-trip-cta {
            margin-bottom: var(--spacing-16);
            position: relative;
        }

        .new-trip-cta-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-12) var(--spacing-24);
            background: var(--accent-primary);
            color: var(--color-white);
            border: none;
            border-radius: var(--radius-xl);
            font-size: var(--text-fixed-16);
            font-weight: 700;
            cursor: pointer;
            box-shadow: var(--shadow-accent-md);
            transition: all var(--duration-normal) var(--easing-standard);
            width: 100%;
        }

        .new-trip-cta-btn:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-accent-sm);
        }

        .new-trip-cta-btn.active {
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
            box-shadow: none;
        }

        /* Trip Form */
        .trip-form {
            background: var(--color-white);
            padding: var(--spacing-24);
            border-radius: 0 0 var(--radius-2xl) var(--radius-2xl);
            box-shadow: var(--shadow-md);
            margin-bottom: var(--spacing-32);
            margin-top: calc(-1 * var(--spacing-16));
            overflow: hidden;
            max-height: 800px;
            transform: translateY(0);
            transition: max-height var(--duration-slow) var(--easing-smooth), 
                        opacity var(--duration-slow) var(--easing-smooth),
                        transform var(--duration-slow) var(--easing-smooth),
                        margin var(--duration-slow) var(--easing-smooth);
            opacity: 1;
        }

        .trip-form.hidden {
            max-height: 0;
            opacity: 0;
            transform: translateY(-20px);
            margin-bottom: 0;
            margin-top: calc(-1 * var(--spacing-16));
            padding-top: 0;
            padding-bottom: 0;
        }

        .trip-form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-20);
        }

        .trip-form-close {
            background: transparent;
            border: none;
            font-size: var(--text-fixed-32);
            color: var(--color-gray-600);
            cursor: pointer;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            transition: all var(--duration-normal) var(--easing-standard);
            line-height: 1;
            padding: 0;
        }

        .trip-form-close:hover {
            background: var(--color-gray-50);
            color: var(--color-gray-800);
        }

        .trip-form h2 {
            color: var(--color-black);
            margin-bottom: 0;
            font-size: var(--text-fixed-20);
            font-weight: 700;
        }

        .form-row {
            display: grid;
            grid-template-columns: 80px 1fr 1fr;
            gap: var(--spacing-15);
            margin-bottom: var(--spacing-14);
        }

        .form-group-emoji {
            width: 80px;
        }

        .form-group-name {
            flex: 1;
        }

        .form-group-dates {
            flex: 1;
        }

        /* Date Range Picker Button */
        .date-picker-button {
            width: 100%;
            padding: var(--spacing-10) var(--spacing-12);
            border: 2px solid var(--color-gray-400);
            border-radius: var(--radius-lg);
            background: var(--color-white);
            cursor: pointer;
            text-align: left;
            font-size: var(--text-fixed-14);
            color: #bbb;
            transition: all var(--duration-medium) var(--easing-standard);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .date-picker-button:hover {
            border-color: var(--accent-primary);
        }

        .date-picker-button.has-dates {
            color: var(--color-black);
            font-weight: 500;
        }

        /* Trip Creation Emoji Picker Button */
        .trip-emoji-button {
            width: 100%;
            padding: var(--spacing-6);
            border: 2px solid var(--color-gray-400);
            border-radius: var(--radius-lg);
            background: var(--color-gray-50);
            font-size: var(--text-fixed-24);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--duration-medium) var(--easing-standard);
            line-height: 1;
        }

        .trip-emoji-button:hover {
            border-color: var(--accent-primary);
            background: var(--accent-light);
            transform: scale(1.05);
        }

        /* Date Range Picker Modal */
        .date-range-picker {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--color-white);
            padding: var(--spacing-20);
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-xl);
            z-index: 1000;
            max-width: 400px;
            width: 90%;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-15);
        }

        .calendar-header button {
            background: var(--accent-primary);
            color: var(--color-white);
            border: none;
            border-radius: var(--radius-sm);
            padding: var(--spacing-4) var(--spacing-8);
            cursor: pointer;
            font-weight: 600;
            font-size: var(--text-fixed-16);
        }

        .calendar-header button:hover {
            background: var(--accent-hover);
        }

        .calendar-header h4 {
            color: var(--color-black);
            font-size: var(--text-fixed-16);
            margin: var(--spacing-0);
            font-weight: 700;
        }

        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: var(--spacing-2);
            margin-bottom: var(--spacing-4);
        }

        .calendar-weekday {
            text-align: center;
            font-size: var(--text-fixed-11);
            font-weight: 600;
            color: var(--color-gray-600);
            padding: var(--spacing-2);
        }

        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: var(--spacing-2);
            margin-bottom: var(--spacing-15);
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: var(--text-fixed-13);
            transition: all var(--duration-normal) var(--easing-standard);
            border: 2px solid transparent;
            color: var(--color-black);
        }

        .calendar-day:hover {
            background: var(--accent-light);
        }

        .calendar-day.disabled {
            color: #ddd;
            cursor: not-allowed;
            background: #f9f9f9;
            opacity: 0.5;
        }

        .calendar-day.disabled:hover {
            background: #f9f9f9;
        }

        .calendar-day.other-month {
            color: var(--color-gray-500);
        }

        .calendar-day.selected-start,
        .calendar-day.selected-end {
            background: var(--accent-primary);
            color: var(--color-white);
            font-weight: bold;
        }

        .calendar-day.in-range {
            background: var(--accent-light);
            color: var(--accent-primary);
        }

        .calendar-day.today {
            border: 2px solid var(--accent-primary);
        }

        .selected-dates-display {
            margin-top: var(--spacing-6);
            padding: var(--spacing-8);
            background: var(--color-gray-50);
            border-radius: var(--radius-lg);
            text-align: center;
        }

        .selected-dates-display p {
            margin: var(--spacing-2) var(--spacing-0);
            color: var(--color-black);
            font-weight: 600;
            font-size: var(--text-sm);
        }

        .selected-dates-display .date-range {
            font-size: var(--text-sm);
            color: var(--color-gray-700);
        }

        .calendar-close-btn {
            width: 100%;
            margin-top: var(--spacing-15);
        }

        /* Activity Date Picker Modal */
        .activity-date-picker {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--color-white);
            padding: var(--spacing-20);
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-xl);
            z-index: 1000;
            max-width: 380px;
            width: 90%;
        }

        .activity-date-picker .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-14);
        }

        .activity-date-picker .calendar-header h4 {
            color: var(--color-black);
            font-size: var(--text-lg);
            margin: var(--spacing-0);
            font-weight: 700;
        }

        .activity-date-picker .calendar-close-icon {
            background: none;
            border: none;
            font-size: var(--text-fixed-28);
            color: var(--color-gray-600);
            cursor: pointer;
            padding: var(--spacing-0);
            width: var(--spacing-25);
            height: var(--spacing-25);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-full);
            transition: all var(--duration-normal) var(--easing-standard);
        }

        .activity-date-picker .calendar-close-icon:hover {
            background: var(--color-gray-200);
            color: var(--color-gray-700);
        }

        .activity-date-picker .calendar-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-15);
        }

        .activity-date-picker .calendar-nav button {
            background: var(--accent-primary);
            color: var(--color-white);
            border: none;
            border-radius: var(--radius-sm);
            padding: var(--spacing-4) var(--spacing-12);
            cursor: pointer;
            font-weight: 600;
            font-size: var(--text-fixed-16);
            transition: all var(--duration-normal) var(--easing-standard);
        }

        .activity-date-picker .calendar-nav button:hover {
            background: var(--accent-hover);
            transform: scale(1.05);
        }

        .activity-date-picker .calendar-nav span {
            font-size: var(--text-base);
            font-weight: 700;
            color: var(--color-black);
        }

        .activity-date-picker .calendar-day.selected {
            background: var(--accent-primary);
            color: var(--color-white);
            font-weight: bold;
        }

        /* Trips Grid */
        .trips-section {
            margin-bottom: var(--spacing-32);
        }

        .trips-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-14);
        }

        .trips-section h2 {
            color: var(--accent-primary);
            font-size: var(--text-lg);
            font-weight: 600;
            letter-spacing: -0.3px;
            text-transform: capitalize;
        }

        .view-details-link {
            color: var(--accent-primary);
            font-size: var(--text-sm);
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
        }

        .view-details-link:hover {
            text-decoration: underline;
        }

        .trips-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: var(--spacing-14);
        }

        .trip-card {
            background: var(--color-white);
            padding: var(--spacing-25) var(--spacing-24);
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: all var(--duration-medium) var(--easing-standard);
            position: relative;
            border: 1px solid var(--color-gray-200);
            min-height: 180px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .trip-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
            border-color: var(--color-gray-400);
        }

        .trip-card-header {
            display: flex;
            gap: var(--spacing-12);
            align-items: flex-start;
            position: relative;
        }

        .trip-card-icon {
            width: 48px;
            height: 48px;
            min-width: 48px;
            background: #E3F2FD;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--text-fixed-24);
            font-weight: 400;
            color: var(--color-gray-700);
            line-height: 1;
        }

        .trip-card-main {
            flex: 1;
        }

        .trip-card h3 {
            color: var(--color-black);
            margin: var(--spacing-0) var(--spacing-0) var(--spacing-3) var(--spacing-0);
            font-size: var(--text-base);
            font-weight: 600;
            letter-spacing: -0.3px;
        }

        .trip-card-subtitle {
            color: var(--color-gray-600);
            font-size: var(--text-xs);
            margin: var(--spacing-0) var(--spacing-0) var(--spacing-6) var(--spacing-0);
        }

        .trip-card-dates {
            color: #888;
            font-size: var(--text-xs);
            margin: var(--spacing-0) var(--spacing-0) var(--spacing-10) var(--spacing-0);
            line-height: 1.5;
        }

        .trip-card-socket {
            color: var(--color-gray-700);
            font-size: var(--text-xs);
            margin: var(--spacing-0);
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
        }

        .trip-card-socket svg {
            flex-shrink: 0;
        }

        .trip-duration-badge-card {
            padding: var(--spacing-3) var(--spacing-10);
            background: var(--accent-primary);
            color: var(--color-white);
            border-radius: var(--radius-round);
            font-size: var(--text-xs);
            font-weight: 600;
            white-space: nowrap;
            letter-spacing: 0.3px;
        }

        .trip-countdown-badge {
            padding: var(--spacing-3) var(--spacing-10);
            background: var(--accent-quaternary);
            color: var(--accent-quaternary-text);
            border-radius: var(--radius-round);
            font-size: var(--text-xs);
            font-weight: 600;
            white-space: nowrap;
            letter-spacing: 0.3px;
            line-height: 1.2;
            display: inline-flex;
            align-items: center;
            margin-bottom: var(--spacing-4);
        }

        /* Past Trips */
        .past-trips-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: var(--spacing-14);
        }

        /* Trip Detail Page */
        .trip-detail {
            background: var(--color-white);
            padding: var(--spacing-32);
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-md);
            margin-bottom: var(--spacing-24);
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-4);
            padding: var(--spacing-6) var(--spacing-14);
            background: var(--color-white);
            color: var(--color-gray-700);
            border: 1px solid var(--color-gray-400);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: var(--text-base);
            font-weight: 600;
            margin-bottom: var(--spacing-14);
            transition: all var(--duration-medium) var(--easing-standard);
        }

        .back-btn:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            transform: translateX(-3px);
        }

        /* Trip Header Compact */
        .trip-header-compact {
            margin-bottom: var(--spacing-28);
            padding-bottom: var(--spacing-24);
            border-bottom: 1px solid var(--color-gray-200);
        }

        .trip-header-top {
            display: flex;
            align-items: center;
            gap: var(--spacing-12);
            margin-bottom: var(--spacing-8);
            flex-wrap: wrap;
        }

        .trip-icon {
            width: clamp(50px, 12vw, 60px);
            height: clamp(50px, 12vw, 60px);
            border-radius: var(--spacing-15);
            background: #E3F2FD;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
            font-size: var(--text-xl);
            font-weight: 700;
            flex-shrink: 0;
            transition: all var(--duration-medium) var(--easing-smooth);
            position: relative;
        }

        .trip-icon:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(100, 181, 246, 0.4);
        }

        .trip-icon:active {
            transform: scale(0.98);
        }

        .trip-name-inline {
            font-size: var(--text-xl);
            color: var(--color-black);
            border: none;
            background: transparent;
            padding: var(--spacing-0);
            font-weight: 700;
            flex: 1;
            min-width: 200px;
        }

        .trip-name-inline:focus {
            outline: none;
            border-bottom: 2px solid var(--accent-primary);
        }

        .trip-duration-badge {
            padding: var(--spacing-3) var(--spacing-12);
            background: var(--accent-primary);
            color: var(--color-white);
            border-radius: var(--radius-round);
            font-size: var(--text-xs);
            font-weight: 600;
            white-space: nowrap;
            letter-spacing: 0.3px;
            line-height: 1.2;
            display: inline-flex;
            align-items: center;
        }

        .trip-socket-inline {
            padding: clamp(6px, 2vw, 8px) clamp(14px, 4vw, 18px);
            background: var(--color-gray-50);
            color: var(--color-gray-700);
            border-radius: var(--radius-round);
            font-size: var(--text-sm);
            font-weight: 600;
            border: 1px solid var(--color-gray-400);
            line-height: 1.2;
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-2);
            flex-wrap: wrap;
        }

        .trip-socket-inline svg {
            flex-shrink: 0;
        }

        /* Tabs */
        .trip-tabs {
            display: flex;
            gap: var(--spacing-0);
            border-bottom: 2px solid var(--color-gray-400);
            margin: var(--spacing-24) var(--spacing-0) var(--spacing-0) var(--spacing-0);
        }

        .trip-tab {
            padding: var(--spacing-10) var(--spacing-24);
            background: transparent;
            border: none;
            font-size: var(--text-base);
            font-weight: 600;
            color: var(--color-gray-700);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all var(--duration-medium) var(--easing-smooth);
            position: relative;
            bottom: -2px;
        }

        .trip-tab:hover {
            color: var(--accent-primary);
            background: rgba(102, 126, 234, 0.05);
        }

        .trip-tab.active {
            color: var(--accent-primary);
            border-bottom-color: var(--accent-primary);
        }

        .trip-tab-content {
            display: none;
            padding-top: var(--spacing-24);
        }

        .trip-tab-content.active {
            display: block;
        }

        /* Itinerary Timeline */
        .itinerary-timeline {
            overflow-x: auto;
            margin: var(--spacing-14) var(--spacing-0);
        }

        .itinerary-grid {
            display: table;
            border: 1px solid var(--color-gray-400);
            border-radius: var(--radius-lg);
            overflow: hidden;
            min-width: 100%;
            border-collapse: collapse;
        }

        .itinerary-header-row {
            display: table-row;
        }

        .itinerary-header-row:last-of-type .itinerary-header-cell {
            border-bottom: 2px solid var(--color-info);
        }

        .itinerary-header-cell {
            display: table-cell;
            background: var(--color-gray-50);
            padding: var(--spacing-4) var(--spacing-8);
            border-right: 1px solid var(--color-gray-400);
            border-bottom: 1px solid var(--color-gray-400);
            text-align: center;
            font-size: var(--text-fixed-13);
            font-weight: 600;
            color: #333;
            min-width: 150px;
            vertical-align: middle;
            position: sticky;
            top: 0;
            z-index: 5;
        }

        .itinerary-header-cell.time-column {
            background: linear-gradient(135deg, var(--color-info) 0%, #764ba2 100%);
            color: var(--color-white);
            position: sticky;
            left: 0;
            z-index: 25;
            min-width: 100px;
            max-width: 100px;
            width: 100px;
        }

        .itinerary-header-cell.month-row {
            font-size: var(--text-fixed-14);
            font-weight: 700;
            background: #e3f2fd;
            top: 0;
        }

        .itinerary-header-cell.date-row {
            font-size: var(--text-fixed-16);
            font-weight: 700;
            top: 41px;
        }

        .itinerary-header-cell.day-row {
            font-size: var(--text-fixed-12);
            text-transform: uppercase;
            color: var(--color-gray-700);
            top: 82px;
        }

        .itinerary-header-cell.flag-row {
            font-size: var(--text-fixed-24);
            padding: var(--spacing-3);
            top: 123px;
        }

        .itinerary-header-cell.city-row {
            font-size: var(--text-fixed-12);
            font-weight: 500;
            color: #555;
            top: 164px;
        }

        .itinerary-body-row {
            display: table-row;
        }

        .itinerary-body-row:hover {
            background: rgba(102, 126, 234, 0.02);
        }

        .time-label {
            display: table-cell;
            background: var(--color-gray-50);
            padding: var(--spacing-8);
            border-right: 1px solid var(--color-gray-400);
            border-bottom: 1px solid var(--color-gray-400);
            font-size: var(--text-fixed-13);
            font-weight: 500;
            color: var(--color-gray-700);
            text-align: right;
            position: sticky;
            left: 0;
            z-index: 10;
            min-width: 100px;
            max-width: 100px;
            width: 100px;
            vertical-align: top;
        }

        .time-slot {
            display: table-cell;
            padding: var(--spacing-4);
            border-right: 1px solid var(--color-gray-400);
            border-bottom: 1px solid var(--color-gray-400);
            min-height: 50px;
            min-width: 150px;
            cursor: pointer;
            transition: background var(--duration-normal) var(--easing-standard);
            vertical-align: top;
        }

        .time-slot:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .time-slot.has-activity {
            background: rgba(102, 126, 234, 0.15);
        }

        .time-slot.has-transport {
            background: rgba(255, 152, 0, 0.15);
        }

        .time-slot-item {
            background: linear-gradient(135deg, var(--color-info) 0%, #764ba2 100%);
            color: var(--color-white);
            padding: var(--spacing-3) var(--spacing-6);
            border-radius: var(--radius-sm);
            font-size: var(--text-fixed-12);
            margin-bottom: var(--spacing-2);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
            cursor: pointer;
        }

        .time-slot-item.transport {
            background: linear-gradient(135deg, var(--color-warning) 0%, #F57C00 100%);
        }

        .time-slot-item-emoji {
            font-size: var(--text-fixed-14);
        }

        /* Itinerary Modal */
        .itinerary-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .itinerary-modal.hidden {
            display: none;
        }

        .itinerary-modal-content {
            background: var(--color-white);
            border-radius: var(--radius-xl);
            padding: var(--spacing-24);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .itinerary-type-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-8);
            margin-bottom: var(--spacing-16);
        }

        .itinerary-type-btn {
            padding: var(--spacing-12);
            border: 2px solid var(--color-gray-400);
            border-radius: var(--radius-lg);
            background: var(--color-white);
            cursor: pointer;
            transition: all var(--duration-medium) var(--easing-standard);
            font-size: var(--text-fixed-15);
            font-weight: 600;
        }

        .itinerary-type-btn:hover {
            border-color: var(--accent-primary);
            background: rgba(102, 126, 234, 0.05);
        }

        .itinerary-type-btn.active {
            border-color: var(--accent-primary);
            background: var(--accent-primary);
            color: var(--color-white);
        }

        .trip-action-buttons {
            display: flex;
            gap: var(--spacing-6);
            margin-left: auto;
        }

        .edit-trip-btn {
            padding: var(--spacing-4) var(--spacing-12);
            background: var(--color-white);
            color: var(--accent-primary);
            border: 1px solid var(--accent-primary);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: var(--text-fixed-14);
            font-weight: 500;
            transition: all var(--duration-medium) var(--easing-standard);
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
        }

        .edit-trip-btn:hover {
            background: var(--accent-light);
        }

        .delete-trip-btn {
            padding: var(--spacing-4) var(--spacing-12);
            background: var(--color-white);
            color: var(--color-gray-700);
            border: 1px solid var(--color-gray-400);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: var(--text-fixed-14);
            font-weight: 500;
            transition: all var(--duration-medium) var(--easing-standard);
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
        }

        .delete-trip-btn:hover {
            border-color: var(--color-error);
            color: var(--color-error);
            background: var(--color-error-bg);
        }

        .trip-subtitle-inline {
            color: var(--color-gray-600);
            font-size: var(--text-base);
            margin-left: clamp(0px, 10vw, 80px);
        }

        /* Notes Section */
        .notes-section {
            margin-bottom: var(--spacing-14);
        }

        .notes-section h3 {
            color: var(--color-gray-700);
            font-size: var(--text-base);
            font-weight: 600;
            margin-bottom: var(--spacing-6);
        }

        .trip-notes {
            width: 100%;
            min-height: 80px;
            padding: var(--spacing-8);
            border: 1.5px solid var(--color-gray-400);
            border-radius: var(--radius-md);
            font-size: var(--text-fixed-13);
            font-family: inherit;
            color: var(--color-black);
            background: var(--color-gray-50);
            resize: vertical;
            transition: all var(--duration-medium) var(--easing-standard);
        }

        .trip-notes:focus {
            outline: none;
            border-color: var(--accent-primary);
            background: var(--color-white);
        }

        .trip-notes::placeholder {
            color: #bbb;
        }

        /* Cities Section */
        .cities-section {
            margin-bottom: var(--spacing-28);
        }

        .cities-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-14);
        }

        .cities-section h3 {
            color: var(--color-black);
            font-size: var(--text-lg);
            font-weight: 700;
            margin: var(--spacing-0);
        }

        .add-city-link {
            background: transparent;
            color: var(--accent-primary);
            border: none;
            cursor: pointer;
            font-size: var(--text-sm);
            font-weight: 600;
            padding: var(--spacing-4) var(--spacing-12);
            border-radius: var(--radius-sm);
            transition: all var(--duration-normal) var(--easing-smooth);
        }

        .add-city-link:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #5566d6;
        }

        .cities-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-8);
        }

        .city-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: var(--radius-lg);
            padding: var(--spacing-10) var(--spacing-12);
            display: flex;
            align-items: center;
            gap: var(--spacing-8);
            transition: all var(--duration-medium) var(--easing-smooth);
            border: 2px solid transparent;
        }

        .city-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--color-info);
        }

        .city-card-emoji {
            font-size: var(--text-fixed-28);
            min-width: 40px;
            text-align: center;
        }

        .city-card-content {
            flex: 1;
        }

        .city-card-name {
            font-size: var(--text-fixed-16);
            font-weight: 600;
            color: var(--color-black);
            margin-bottom: var(--spacing-2);
        }

        .city-card-dates {
            font-size: var(--text-fixed-13);
            color: var(--color-gray-700);
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
        }

        .city-card-socket {
            font-size: var(--text-fixed-12);
            color: #888;
            margin-top: var(--spacing-3);
        }

        .city-card-actions {
            display: flex;
            gap: var(--spacing-3);
        }

        .city-card-actions button {
            background: rgba(255, 255, 255, 0.8);
            border: none;
            padding: var(--spacing-3) var(--spacing-6);
            border-radius: var(--radius-xs);
            cursor: pointer;
            font-size: var(--text-fixed-12);
            transition: all var(--duration-normal) var(--easing-smooth);
            font-weight: 500;
        }

        .city-card-actions button:hover {
            background: var(--color-white);
            transform: scale(1.05);
        }

        .no-cities {
            text-align: center;
            color: var(--color-gray-600);
            font-size: var(--text-sm);
            padding: var(--spacing-32) var(--spacing-14);
            background: #f9f9f9;
            border-radius: var(--radius-lg);
            border: 2px dashed var(--color-gray-400);
        }

        /* City Tag in Outfit Planner */
        .city-tag {
            background: linear-gradient(135deg, var(--color-info) 0%, #764ba2 100%);
            color: var(--color-white);
            padding: var(--spacing-2) var(--spacing-4);
            border-radius: var(--radius-lg);
            font-size: var(--text-fixed-11);
            font-weight: 600;
            text-align: center;
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-2);
            box-shadow: 0 1px 4px rgba(102, 126, 234, 0.25);
        }

        .city-tag.travel-tag {
            background: linear-gradient(135deg, var(--color-warning) 0%, #F57C00 100%);
            box-shadow: 0 1px 4px rgba(255, 152, 0, 0.25);
        }

        .city-tag-emoji {
            font-size: var(--text-fixed-13);
        }

        /* Activities */
        .activities-section {
            margin-bottom: var(--spacing-28);
        }

        .activities-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-14);
        }

        .activities-section h3 {
            color: var(--color-black);
            font-size: var(--text-lg);
            font-weight: 700;
            margin: var(--spacing-0);
        }

        .add-activity-link {
            background: transparent;
            color: var(--accent-primary);
            border: none;
            font-size: var(--text-sm);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--duration-medium) var(--easing-standard);
            text-decoration: none;
        }

        .add-activity-link:hover {
            color: var(--accent-hover);
            text-decoration: underline;
        }

        .activities-list {
            display: grid;
            gap: var(--spacing-8);
        }

        .no-activities {
            color: var(--color-gray-600);
            font-size: var(--text-sm);
            padding: var(--spacing-14);
            text-align: center;
            background: var(--color-gray-50);
            border-radius: var(--radius-lg);
            border: 1px dashed var(--color-gray-400);
        }

        .activity-item {
            display: grid;
            grid-template-columns: 50px 150px 1fr 190px 110px;
            gap: var(--spacing-8);
            align-items: center;
            padding: var(--spacing-15);
            background: var(--color-gray-50);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-gray-200);
        }

        .activity-emoji {
            font-size: var(--text-fixed-24);
            cursor: pointer;
            text-align: center;
            transition: transform var(--duration-normal) var(--easing-standard);
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-white);
            border-radius: var(--radius-lg);
            border: 2px solid var(--color-gray-400);
        }

        .activity-emoji:hover {
            transform: scale(1.1);
            border-color: var(--accent-primary);
        }

        .activity-item input[type="text"] {
            padding: var(--spacing-6) var(--spacing-10);
            border: 1px solid var(--color-gray-400);
            border-radius: var(--radius-sm);
            font-size: var(--text-sm);
            background: var(--color-white);
            color: var(--color-black);
            transition: all var(--duration-medium) var(--easing-standard);
            box-shadow: var(--shadow-xs);
        }

        .activity-item input[type="text"]:hover {
            border-color: var(--color-gray-500);
            box-shadow: var(--shadow-sm);
        }

        .activity-item input[readonly] {
            background: var(--color-white);
            cursor: pointer !important;
        }

        .activity-item input[readonly]:hover {
            border-color: var(--accent-primary);
            box-shadow: 0 2px 8px var(--accent-shadow);
        }

        .activity-item input[readonly]:focus {
            border-color: var(--accent-primary);
            box-shadow: var(--shadow-accent-focus);
        }

        .activity-item input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        /* Toggle Switch for Day/Night */
        .activity-type-toggle {
            display: inline-flex;
            align-items: center;
            background: var(--color-white);
            border-radius: var(--radius-2xl);
            padding: var(--spacing-2);
            border: 1px solid var(--color-gray-400);
            position: relative;
            height: 38px;
            box-shadow: var(--shadow-xs);
            transition: all var(--duration-medium) var(--easing-standard);
            gap: var(--spacing-2);
            width: fit-content;
            min-width: 180px;
        }

        .activity-type-toggle:hover {
            box-shadow: var(--shadow-sm);
        }

        .activity-type-option {
            flex: 1;
            padding: 7px var(--spacing-12);
            border-radius: var(--radius-xl);
            font-size: var(--text-xs);
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            transition: all var(--duration-normal) var(--easing-standard);
            color: var(--color-gray-600);
            z-index: 1;
            white-space: nowrap;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-2);
            min-width: 80px;
        }

        .activity-type-option.active {
            color: var(--color-white);
            background: var(--accent-primary);
            box-shadow: 0 2px 4px var(--accent-shadow);
        }

        .activity-type-option:not(.active):hover {
            color: var(--color-gray-700);
            background: #f5f5f5;
        }

        /* Activity Saved/View State */
        .activity-item.saved {
            background: var(--color-white);
            border: 1px solid var(--color-gray-300);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-12) var(--spacing-14);
        }

        .activity-saved-content {
            display: flex;
            align-items: center;
            gap: var(--spacing-8);
            flex: 1;
        }

        .activity-saved-emoji {
            font-size: var(--text-fixed-24);
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--accent-light);
            border-radius: var(--radius-lg);
        }

        .activity-saved-details {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-2);
        }

        .activity-saved-name {
            font-size: var(--text-base);
            font-weight: 600;
            color: var(--color-black);
        }

        .activity-saved-meta {
            display: flex;
            gap: var(--spacing-8);
            align-items: center;
            font-size: var(--text-xs);
            color: var(--color-gray-700);
        }

        .activity-saved-date {
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
        }

        .activity-saved-type {
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
            padding: var(--spacing-3) var(--spacing-6);
            background: var(--accent-light);
            color: var(--accent-primary);
            border-radius: var(--radius-lg);
            font-weight: 600;
        }

        .activity-actions {
            display: flex;
            gap: var(--spacing-4);
            align-items: center;
        }

        .edit-btn {
            background: var(--color-white);
            color: var(--accent-primary);
            border: 1px solid var(--accent-primary);
            border-radius: var(--radius-sm);
            padding: var(--spacing-4) var(--spacing-12);
            cursor: pointer;
            font-size: var(--text-xs);
            font-weight: 600;
            transition: all var(--duration-normal) var(--easing-standard);
        }

        .edit-btn:hover {
            background: var(--accent-primary);
            color: var(--color-white);
        }

        .save-btn {
            background: var(--accent-primary);
            color: var(--color-white);
            border: none;
            border-radius: var(--radius-sm);
            padding: var(--spacing-4) var(--spacing-12);
            cursor: pointer;
            font-size: var(--text-xs);
            font-weight: 600;
            transition: all var(--duration-normal) var(--easing-standard);
        }

        .save-btn:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px var(--accent-shadow);
        }

        .save-btn:disabled {
            opacity: var(--opacity-disabled);
            cursor: not-allowed;
            transform: none;
        }

        .delete-btn {
            background: var(--color-white);
            color: var(--color-error);
            border: 1px solid var(--color-error);
            border-radius: var(--radius-sm);
            padding: var(--spacing-4);
            cursor: pointer;
            font-size: var(--text-fixed-12);
            transition: all var(--duration-medium) var(--easing-standard);
        }

        .delete-btn:hover {
            background: var(--color-error);
            color: var(--color-white);
        }

        .add-btn {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-2);
            padding: var(--spacing-6) var(--spacing-14);
            background: var(--color-white);
            color: var(--accent-primary);
            border: 2px solid var(--accent-primary);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: var(--text-fixed-14);
            font-weight: 600;
            margin-top: var(--spacing-6);
            transition: all var(--duration-medium) var(--easing-standard);
        }

        .add-btn:hover {
            background: var(--accent-primary);
            color: var(--color-white);
        }

        /* Checklists */
        .checklists-header-section {
            display: flex;
            justify-content: flex-end;
            margin-bottom: var(--spacing-15);
        }

        .add-list-btn {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-2);
            padding: var(--spacing-6) var(--spacing-14);
            background: var(--color-white);
            border: 2px solid var(--color-success);
            border-radius: var(--radius-lg);
            color: var(--color-success);
            font-size: var(--text-fixed-14);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--duration-medium) var(--easing-standard);
        }

        .add-list-btn:hover {
            background: var(--color-success);
            color: var(--color-white);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 195, 74, 0.3);
        }

        .checklists-section {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-14);
            margin-bottom: var(--spacing-24);
            transition: grid-template-columns var(--duration-medium) var(--easing-smooth);
        }

        .checklists-section:not(:has(#customListColumn[style*="display: none"])) {
            grid-template-columns: repeat(3, 1fr);
        }

        .checklists-section:has(#customListColumn[style*="display: none"]) {
            grid-template-columns: repeat(2, 1fr);
        }

        .checklist-column {
            background: var(--color-white);
            padding: var(--spacing-20);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--color-gray-200);
        }

        .checklist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-15);
        }

        .checklist-column h3 {
            color: var(--color-black);
            font-size: 17px;
            font-weight: 700;
            margin-bottom: var(--spacing-15);
        }

        .checklist-column h3 input {
            border: none;
            background: transparent;
            color: var(--color-black);
            font-size: 17px;
            font-weight: 700;
            width: 100%;
        }

        .checklist-column h3 input:focus {
            outline: 2px solid var(--accent-primary);
            border-radius: var(--spacing-2);
        }

        .checklist-items {
            display: grid;
            gap: var(--spacing-4);
        }

        .checklist-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-6);
            padding: var(--spacing-6) var(--spacing-8);
            background: var(--color-gray-50);
            border-radius: var(--radius-sm);
            border: 1px solid transparent;
            transition: all var(--duration-medium) var(--easing-standard);
        }

        .checklist-item:hover {
            border-color: var(--color-gray-400);
        }

        .checklist-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--accent-primary);
        }

        .checklist-item input[type="text"] {
            flex: 1;
            border: none;
            background: transparent;
            font-size: var(--text-fixed-14);
            color: var(--color-black);
        }

        .checklist-item input[type="text"]::placeholder {
            color: #bbb;
        }

        .checklist-item.checked {
            opacity: 0.5;
        }

        .checklist-item.checked input[type="text"] {
            text-decoration: line-through;
            color: var(--color-gray-600);
        }

        /* Outfit Planner */
        .outfit-planner {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #f0f0f0;
        }

        .outfit-planner h3 {
            color: #1a1a1a;
            margin-bottom: 20px;
            font-size: 20px;
            font-weight: 700;
        }

        .week-row {
            margin-bottom: 30px;
        }

        .week-label {
            color: #1a1a1a;
            font-weight: 600;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .days-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }

        .day-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
            transition: all 0.3s;
            overflow: hidden;
            max-width: 100%;
        }

        .day-card:hover {
            border-color: var(--accent-primary);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.1);
        }

        .day-header {
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .day-date {
            color: #999;
            font-size: 12px;
            margin-bottom: 10px;
        }

        .weather-info {
            background: var(--accent-light);
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 12px;
            text-align: center;
            color: var(--accent-primary);
            border: 1px solid var(--accent-light);
        }

        .day-activities-section {
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid #f0f0f0;
        }

        .day-activities-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .day-activities-header h5 {
            font-size: 10px;
            color: #999;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin: 0;
        }

        .add-day-activity-btn {
            width: var(--spacing-14);
            height: var(--spacing-14);
            border-radius: var(--radius-full);
            background: var(--accent-primary);
            color: var(--color-white);
            border: none;
            font-size: var(--text-fixed-16);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            padding: var(--spacing-0);
            transition: all var(--duration-normal) var(--easing-standard);
        }

        .add-day-activity-btn:hover {
            background: var(--accent-hover);
            transform: scale(1.1);
        }

        .day-activities-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-3);
        }

        .day-activity-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
            padding: var(--spacing-3) var(--spacing-4);
            background: var(--accent-light);
            border-radius: var(--radius-xs);
            font-size: var(--text-xs);
        }

        .day-activity-icon {
            font-size: var(--text-fixed-14);
            flex-shrink: 0;
        }

        .day-activity-name {
            flex: 1;
            color: var(--color-black);
            font-weight: 500;
        }

        .remove-day-activity-btn {
            width: 18px;
            height: 18px;
            border-radius: var(--radius-full);
            background: transparent;
            color: var(--color-gray-600);
            border: none;
            font-size: var(--text-fixed-18);
            font-weight: 400;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            padding: var(--spacing-0);
            transition: all var(--duration-normal) var(--easing-standard);
            flex-shrink: 0;
        }

        .remove-day-activity-btn:hover {
            background: var(--color-white);
            color: var(--color-error);
            transform: scale(1.1);
        }

        .no-day-activities {
            font-size: var(--text-xs);
            color: #bbb;
            font-style: italic;
            text-align: center;
            padding: var(--spacing-6);
        }

        .activity-links {
            font-size: var(--text-fixed-11);
            color: var(--color-gray-600);
            margin-bottom: var(--spacing-6);
        }

        .outfit-section {
            margin-bottom: var(--spacing-12);
            padding-bottom: var(--spacing-8);
            width: 100%;
            max-width: 100%;
            overflow: hidden;
        }

        .outfit-section:not(:last-child) {
            border-bottom: 1px solid #f5f5f5;
        }

        .outfit-section h5 {
            font-size: var(--text-fixed-11);
            color: var(--color-gray-600);
            margin-bottom: var(--spacing-6);
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .outfit-items {
            display: grid;
            gap: var(--spacing-3);
            width: 100%;
            max-width: 100%;
        }

        .outfit-item {
            display: flex;
            gap: var(--spacing-4);
            font-size: var(--text-fixed-11);
            color: var(--color-gray-700);
            align-items: center;
            width: 100%;
            max-width: 100%;
            overflow: hidden;
        }

        .outfit-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            flex-shrink: 0;
            accent-color: var(--color-info);
        }

        .outfit-item-content {
            display: flex;
            gap: var(--spacing-4);
            flex: 1;
            min-width: 0;
            align-items: center;
            cursor: pointer;
            transition: opacity var(--duration-medium) var(--easing-standard);
        }

        .outfit-item-content.packed {
            opacity: 0.5;
        }

        .outfit-item-content.packed .outfit-input {
            text-decoration: line-through;
        }

        .outfit-label {
            min-width: 60px;
            flex-shrink: 0;
            white-space: nowrap;
        }

        .outfit-input {
            flex: 1;
            min-width: 0;
            max-width: 100%;
            padding: var(--spacing-3) var(--spacing-4);
            border: 1px solid var(--color-gray-400);
            border-radius: var(--radius-xs);
            font-size: var(--text-fixed-12);
            background: var(--color-white);
            color: var(--color-black);
            transition: all var(--duration-medium) var(--easing-standard);
            box-sizing: border-box;
        }

        .outfit-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }

        .outfit-item input::placeholder {
            color: #bbb;
        }

        .hidden {
            display: none;
        }

        .emoji-picker {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--color-white);
            padding: var(--spacing-20);
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-xl);
            z-index: 1000;
            max-width: 400px;
        }

        .emoji-picker h3 {
            color: var(--color-black);
            font-weight: 700;
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: var(--spacing-6);
            margin-bottom: var(--spacing-15);
        }

        .emoji-option {
            font-size: var(--text-fixed-24);
            cursor: pointer;
            text-align: center;
            padding: var(--spacing-6);
            border-radius: var(--radius-sm);
            transition: all var(--duration-normal) var(--easing-standard);
        }

        .emoji-option:hover {
            background: var(--color-gray-200);
            transform: scale(1.2);
        }

        .overlay {
            position: fixed;
            top: var(--spacing-0);
            left: var(--spacing-0);
            right: var(--spacing-0);
            bottom: var(--spacing-0);
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        /* Activity Modal */
        .activity-modal {
            position: fixed;
            top: var(--spacing-0);
            left: var(--spacing-0);
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: var(--spacing-14);
        }

        .activity-modal.hidden {
            display: none;
        }

        .activity-modal-content {
            background: var(--color-white);
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-2xl);
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .activity-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-14) var(--spacing-20);
            border-bottom: 1px solid var(--color-gray-200);
        }

        .activity-modal-header h3 {
            margin: var(--spacing-0);
            font-size: var(--text-lg);
            color: var(--color-black);
            font-weight: 700;
        }

        .activity-modal-close {
            background: transparent;
            border: none;
            font-size: var(--text-fixed-32);
            color: var(--color-gray-600);
            cursor: pointer;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            transition: all var(--duration-normal) var(--easing-standard);
            line-height: 1;
            padding: var(--spacing-0);
        }

        .activity-modal-close:hover {
            background: var(--color-gray-50);
            color: var(--color-gray-700);
        }

        .activity-modal-body {
            padding: var(--spacing-20);
            overflow-y: auto;
            flex: 1;
        }

        .activity-emoji-button {
            width: 80px;
            height: 80px;
            border: 2px solid var(--color-gray-400);
            border-radius: var(--radius-lg);
            background: var(--color-gray-50);
            font-size: var(--text-fixed-36);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--duration-medium) var(--easing-standard);
        }

        .activity-emoji-button:hover {
            border-color: var(--accent-primary);
            background: var(--accent-light);
            transform: scale(1.05);
        }

        .activity-date-button {
            width: 100%;
            padding: 11px var(--spacing-10);
            border: 1.5px solid var(--color-gray-400);
            border-radius: var(--radius-md);
            background: var(--color-white);
            font-size: var(--text-sm);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all var(--duration-medium) var(--easing-standard);
            color: var(--color-black);
        }

        .activity-date-button:hover {
            border-color: var(--accent-primary);
        }

        .activity-date-button:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: var(--shadow-accent-focus);
        }

        .activity-toggle {
            display: flex;
            gap: var(--spacing-6);
        }

        .activity-toggle-btn {
            flex: 1;
            padding: var(--spacing-8) var(--spacing-12);
            border: 2px solid var(--color-gray-400);
            border-radius: var(--radius-md);
            background: var(--color-white);
            font-size: var(--text-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-4);
            transition: all var(--duration-medium) var(--easing-standard);
            font-weight: 500;
        }

        .activity-toggle-btn:hover {
            border-color: var(--accent-primary);
            background: var(--accent-light);
        }

        .activity-toggle-btn.active {
            border-color: var(--accent-primary);
            background: var(--accent-primary);
            color: var(--color-white);
        }

        .activity-toggle-btn span:first-child {
            font-size: var(--text-fixed-18);
        }

        .activity-modal-footer {
            padding: var(--spacing-14) var(--spacing-20);
            border-top: 1px solid var(--color-gray-200);
            display: flex;
            gap: var(--spacing-8);
            justify-content: flex-end;
        }

        .activity-modal-footer .btn {
            width: auto;
            min-width: 120px;
        }

        /* Emoji Picker Modal */
        .emoji-picker-modal {
            position: fixed;
            top: var(--spacing-0);
            left: var(--spacing-0);
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            padding: var(--spacing-14);
        }

        .emoji-picker-modal.hidden {
            display: none;
        }

        .emoji-picker-content {
            background: var(--color-white);
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-2xl);
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .emoji-picker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-14) var(--spacing-20);
            border-bottom: 1px solid var(--color-gray-200);
        }

        .emoji-picker-header h3 {
            margin: var(--spacing-0);
            font-size: var(--text-lg);
            color: var(--color-black);
            font-weight: 700;
        }

        .emoji-picker-close {
            background: transparent;
            border: none;
            font-size: var(--text-fixed-32);
            color: var(--color-gray-600);
            cursor: pointer;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            transition: all var(--duration-normal) var(--easing-standard);
            line-height: 1;
            padding: var(--spacing-0);
        }

        .emoji-picker-close:hover {
            background: var(--color-gray-50);
            color: var(--color-gray-700);
        }

        .emoji-picker-search {
            padding: 15px 25px;
            border-bottom: 1px solid #f0f0f0;
        }

        .emoji-picker-search input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: var(--text-sm);
            transition: all 0.3s;
            font-family: inherit;
        }

        .emoji-picker-search input:focus {
            outline: none;
            border-color: var(--accent-primary);
            background: #fff;
        }

        .emoji-picker-categories {
            display: flex;
            gap: 8px;
            padding: 15px 25px;
            border-bottom: 1px solid #f0f0f0;
            overflow-x: auto;
            scrollbar-width: thin;
        }

        .emoji-picker-categories::-webkit-scrollbar {
            height: 6px;
        }

        .emoji-picker-categories::-webkit-scrollbar-track {
            background: #f0f0f0;
            border-radius: 3px;
        }

        .emoji-picker-categories::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 3px;
        }

        .emoji-category-btn {
            padding: var(--spacing-4) var(--spacing-10);
            border: 2px solid var(--color-gray-400);
            background: var(--color-white);
            border-radius: var(--radius-2xl);
            font-size: var(--text-xs);
            font-weight: 500;
            cursor: pointer;
            transition: all var(--duration-medium) var(--easing-standard);
            white-space: nowrap;
            color: var(--color-gray-700);
        }

        .emoji-category-btn:hover {
            border-color: var(--accent-primary);
            background: var(--accent-light);
            color: var(--accent-primary);
        }

        .emoji-category-btn.active {
            border-color: var(--accent-primary);
            background: var(--accent-primary);
            color: var(--color-white);
        }

        .emoji-picker-grid {
            padding: var(--spacing-14) var(--spacing-20);
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(45px, 1fr));
            gap: var(--spacing-4);
            overflow-y: auto;
            flex: 1;
            max-height: 400px;
        }

        .emoji-picker-grid::-webkit-scrollbar {
            width: var(--spacing-4);
        }

        .emoji-picker-grid::-webkit-scrollbar-track {
            background: var(--color-gray-200);
            border-radius: var(--spacing-2);
        }

        .emoji-picker-grid::-webkit-scrollbar-thumb {
            background: var(--color-gray-500);
            border-radius: var(--spacing-2);
        }

        .emoji-picker-grid::-webkit-scrollbar-thumb:hover {
            background: var(--color-gray-600);
        }

        .emoji-item {
            width: 100%;
            aspect-ratio: 1;
            border: none;
            background: transparent;
            font-size: var(--text-fixed-28);
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: all var(--duration-normal) var(--easing-standard);
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .emoji-item:hover {
            background: var(--color-gray-50);
            transform: scale(1.15);
        }

        .emoji-item:active {
            transform: scale(0.95);
        }

        .emoji-picker-empty {
            grid-column: 1 / -1;
            text-align: center;
            padding: var(--spacing-32) var(--spacing-14);
            color: var(--color-gray-600);
            font-size: var(--text-sm);
        }

        @media (max-width: 768px) {
            .emoji-picker-modal {
                padding: var(--spacing-6);
            }

            .emoji-picker-content {
                max-width: 100%;
                max-height: 85vh;
                border-radius: var(--radius-xl);
            }

            .emoji-picker-header {
                padding: var(--spacing-12) var(--spacing-14);
            }

            .emoji-picker-header h3 {
                font-size: var(--text-base);
            }

            .emoji-picker-search {
                padding: var(--spacing-8) var(--spacing-14);
            }

            .emoji-picker-categories {
                padding: var(--spacing-8) var(--spacing-14);
            }

            .emoji-picker-grid {
                padding: var(--spacing-15) var(--spacing-14);
                grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
                gap: var(--spacing-3);
            }

            .emoji-item {
                font-size: var(--text-fixed-24);
            }
        }

        @media (max-width: 1200px) {
            .trips-grid, .past-trips-grid {
                grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            }
        }

        @media (max-width: 1024px) {
            .sidebar {
                position: fixed;
                left: -292px;
                transition: left var(--duration-medium) var(--easing-standard);
                z-index: 100;
                margin: var(--spacing-12);
            }

            .sidebar.open {
                left: var(--spacing-0);
                margin-left: var(--spacing-12);
            }

            .main-content {
                margin-left: var(--spacing-0);
            }
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .trip-info-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .checklists-section {
                grid-template-columns: 1fr;
            }

            .days-grid {
                grid-template-columns: 1fr;
            }

            .trips-grid {
                grid-template-columns: 1fr;
            }

            .past-trips-grid {
                grid-template-columns: 1fr;
            }

            .trip-card {
                padding: var(--spacing-16) var(--spacing-14);
                min-height: 160px;
            }

            .trip-card-icon {
                width: 48px;
                height: 48px;
                min-width: 48px;
                font-size: var(--text-fixed-24);
            }

            .trip-duration-badge-card {
                font-size: var(--text-fixed-12);
                padding: var(--spacing-2) var(--spacing-8);
            }

            .trip-countdown-badge {
                font-size: var(--text-fixed-11);
                padding: var(--spacing-2) var(--spacing-6);
            }

            .main-content {
                padding: var(--spacing-14);
            }

            .greeting {
                font-size: var(--text-fixed-24);
            }

            .calendar-day {
                font-size: var(--text-fixed-12);
            }

            .trip-header-top {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--spacing-15);
            }

            .trip-name-inline {
                font-size: var(--text-fixed-24);
                width: 100%;
            }

            .trip-subtitle-inline {
                margin-left: var(--spacing-0);
            }

            .trip-action-buttons {
                margin-left: var(--spacing-0);
                width: 100%;
                flex-direction: column;
            }
            
            .edit-trip-btn, .delete-trip-btn {
                width: 100%;
                justify-content: center;
            }

            .activity-item {
                grid-template-columns: 1fr;
                gap: var(--spacing-6);
                padding: var(--spacing-8);
            }

            .activity-emoji {
                width: 45px;
                height: 45px;
                font-size: var(--text-fixed-22);
            }

            .activity-item input[type="text"],
            .activity-item input[readonly],
            .activity-type-toggle {
                grid-column: 1;
            }

            .activity-type-toggle {
                min-width: 160px;
                height: 36px;
            }
            
            .activity-type-option {
                font-size: var(--text-fixed-10);
                padding: var(--spacing-3) var(--spacing-8);
                min-width: 70px;
                gap: var(--spacing-3);
            }

            .activity-item.saved {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--spacing-15);
                padding: var(--spacing-15);
            }

            .activity-saved-content {
                width: 100%;
            }

            .activity-saved-emoji {
                width: 45px;
                height: 45px;
                font-size: var(--text-fixed-22);
            }

            .activity-saved-name {
                font-size: var(--text-sm);
            }

            .activity-saved-meta {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--spacing-3);
            }

            .activity-actions {
                width: 100%;
                justify-content: space-between;
            }

            .edit-btn, .save-btn {
                font-size: var(--text-fixed-11);
                padding: var(--spacing-3) var(--spacing-8);
            }
        }

        /* Utility Classes for Modal Forms */
        .modal-input, .modal-select {
            width: 100%;
            padding: var(--spacing-8);
            border: 1.5px solid var(--color-gray-400);
            border-radius: var(--radius-md);
            font-size: var(--text-fixed-15);
        }

        .modal-input:focus, .modal-select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: var(--shadow-accent-focus);
        }

        .modal-emoji-button {
            width: 80px;
            height: 80px;
            font-size: var(--text-fixed-36);
        }

        .modal-footer-buttons {
            display: flex;
            gap: var(--spacing-8);
            margin-top: var(--spacing-16);
        }

        .modal-footer-buttons .btn {
            flex: 1;
        }

        .modal-form-group-inline {
            margin-bottom: var(--spacing-12);
        }

        .modal-label-inline {
            font-size: var(--text-fixed-14);
            font-weight: 500;
            color: var(--color-gray-700);
            margin-bottom: var(--spacing-4);
            display: block;
        }

        .modal-title-inline {
            margin-bottom: var(--spacing-12);
            font-size: var(--text-fixed-20);
            font-weight: 700;
        }

        .modal-edit-btn-inline {
            flex: 1;
            padding: var(--spacing-8) var(--spacing-12);
            font-size: var(--text-fixed-15);
        }

        .modal-edit-btn-inline.btn-secondary {
            margin-top: var(--spacing-0);
        }

        .modal-actions-wrapper {
            display: flex;
            gap: var(--spacing-6);
            margin-top: var(--spacing-14);
        }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="authScreen" class="auth-screen">
        <div class="auth-logo" onclick="window.location.reload()">
            <svg width="180" height="60" viewBox="0 0 180 60" fill="none" xmlns="http://www.w3.org/2000/svg">
                <text x="0" y="48" font-family="'Sugo Pro Display', sans-serif" 
                      font-size="54" font-weight="900" fill="#CCE51D" letter-spacing="-3">
                    qepi.
                </text>
            </svg>
        </div>
        <h2 id="authTitle">Pack Smarter.</h2>
        <div class="form-group">
            <label id="nameLabel" for="name">Name</label>
            <input type="text" id="name" placeholder="Enter your name">
        </div>
        <div class="form-group">
            <label id="usernameLabel" for="username">Username</label>
            <input type="text" id="username" placeholder="Enter username">
        </div>
        <div class="form-group">
            <label id="passwordLabel" for="password">Password</label>
            <input type="password" id="password" placeholder="Enter password">
        </div>
        <button class="btn" id="loginBtn">Login</button>
        <button class="btn btn-secondary" id="registerBtn">Register</button>
        <div class="reset-password-link">
            <a href="#" id="forgotPasswordLink">Forgot Password?</a>
        </div>
        <div class="auth-lang-wrapper">
            <button class="lang-selector" onclick="toggleLanguage()">ES/EN</button>
        </div>
    </div>

    <!-- Reset Password Screen -->
    <div id="resetPasswordScreen" class="auth-screen hidden">
        <div class="auth-logo" onclick="window.location.reload()">
            <svg width="180" height="60" viewBox="0 0 180 60" fill="none" xmlns="http://www.w3.org/2000/svg">
                <text x="0" y="48" font-family="'Sugo Pro Display', sans-serif" 
                      font-size="54" font-weight="900" fill="#CCE51D" letter-spacing="-3">
                    qepi.
                </text>
            </svg>
        </div>
        <h2 id="resetPasswordTitle">Reset Password</h2>
        <div class="form-group">
            <label id="resetUsernameLabel" for="resetUsername">Username</label>
            <input type="text" id="resetUsername" placeholder="Enter your username">
        </div>
        <div class="form-group">
            <label id="resetNameLabel" for="resetName">Name</label>
            <input type="text" id="resetName" placeholder="Enter your name">
        </div>
        <div class="form-group">
            <label id="newPasswordLabel" for="newPassword">New Password</label>
            <input type="password" id="newPassword" placeholder="Enter new password">
        </div>
        <button class="btn" id="resetPasswordBtn">Reset Password</button>
        <div class="back-to-login">
            <a href="#" id="backToLoginLink">Back to Login</a>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="app-layout hidden">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-logo" onclick="showLandingPage()">
                qepi.
            </div>
            <div class="sidebar-profile">
                <div class="sidebar-profile-pic" id="sidebarProfilePic">👤</div>
                <div class="sidebar-profile-info">
                    <h3 id="currentUser"></h3>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-section-title" id="upcomingTripsSidebarTitle">UPCOMING TRIPS</div>
                <div class="sidebar-trips-list" id="sidebarTripsList"></div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-section-title" id="pastTripsSidebarTitle">PAST TRIPS</div>
                <div class="sidebar-trips-list" id="sidebarPastTripsList"></div>
            </div>

            <div class="sidebar-language">
                <div class="lang-toggle">
                    <button class="lang-option" data-lang="en" onclick="setLanguage('en')">
                        <span class="flag">🇺🇸</span>
                        <span class="lang-code">EN</span>
                    </button>
                    <button class="lang-option" data-lang="es" onclick="setLanguage('es')">
                        <span class="flag">🇪🇸</span>
                        <span class="lang-code">ES</span>
                    </button>
                </div>
            </div>

            <div class="sidebar-logout">
                <button class="logout-btn" id="logoutBtn">
                    <span class="icon">🚪</span>
                    <span id="logoutBtnText">Logout</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="container">
                <!-- Landing Page -->
                <div id="landingPage">
                    <!-- Page Header -->
                    <div class="page-header">
                        <h1 class="greeting"><span id="greetingText">Good Morning</span>, <span id="userFirstName">Traveler</span> <span class="greeting-wave">👋</span></h1>
                    </div>

                    <!-- API Setup Banner -->
                    <div id="apiBanner" class="api-banner hidden">
                        <div class="api-banner-icon">🌤️</div>
                        <div class="api-banner-content">
                            <h4 id="apiBannerTitle">Enable Real Weather Data</h4>
                            <p id="apiBannerText">Get a free API key from <a href="https://www.weatherapi.com/signup.aspx" target="_blank" class="api-banner-link">WeatherAPI.com</a> and add it to line 1731 of the code to see real weather forecasts for your trips!</p>
                        </div>
                        <button class="api-banner-close" onclick="closeApiBanner()" title="Dismiss">×</button>
                    </div>

                <!-- New Trip CTA Button -->
                <div class="new-trip-cta">
                    <button class="new-trip-cta-btn" onclick="toggleNewTripForm()">
                        <span id="newTripCtaText">New Trip</span>
                    </button>
                </div>

                <!-- New Trip Form -->
                <div class="trip-form hidden" id="tripForm">
                    <div class="trip-form-header">
                        <h2 id="createTripTitle">Create New Trip</h2>
                        <button type="button" class="trip-form-close" onclick="hideNewTripForm()" aria-label="Close">×</button>
                    </div>
                    <div class="form-row">
                        <div class="form-group form-group-emoji">
                            <label id="tripEmojiLabel">Emoji</label>
                            <button type="button" class="trip-emoji-button" id="tripEmojiButton" onclick="openTripCreationEmojiPicker()">
                                <span id="selectedTripEmoji">🌍</span>
                            </button>
                        </div>
                        <div class="form-group form-group-name">
                            <label id="tripNameLabel">Trip Name</label>
                            <input type="text" id="tripNameInput" placeholder="e.g., Europe Summer 2025" autocomplete="off">
                        </div>
                        <div class="form-group form-group-dates">
                            <label id="dateRangeLabel">Total Duration</label>
                            <button type="button" class="date-picker-button" id="datePickerButton" onclick="openCalendar()">
                                <span id="datePickerButtonText">Click to select dates</span>
                                <span>📅</span>
                            </button>
                        </div>
                    </div>
                    <button type="button" class="btn" id="createTripBtn">Create Trip</button>
                </div>

                    <!-- Upcoming Trips -->
                    <div class="trips-section">
                        <div class="trips-section-header">
                            <h2 id="upcomingTripsTitle">Upcoming trips</h2>
                            <a href="#" class="view-details-link" id="viewDetailsLink">Details</a>
                        </div>
                        <div class="trips-grid" id="upcomingTrips"></div>
                    </div>

                    <!-- Past Trips -->
                    <div class="trips-section">
                        <h2 id="pastTripsTitle">Past Trips</h2>
                        <div class="past-trips-grid" id="pastTrips"></div>
                    </div>
                </div>

            <!-- Trip Detail Page -->
            <div id="tripDetailPage" class="hidden">
                <div class="trip-detail">
                    <button class="back-btn" onclick="showLandingPage()">← <span id="backBtnText">Back to Trips</span></button>
                    
                    <!-- Trip Header -->
                    <div class="trip-header-compact">
                        <div class="trip-header-top">
                            <div class="trip-icon" id="tripIcon">T</div>
                            <input type="text" class="trip-name-inline" id="tripName" placeholder="Trip Name">
                            <div class="trip-duration-badge" id="tripDurationBadge">4 days</div>
                            <div class="trip-socket-inline" id="tripSocketInline">Type C/I • 220V</div>
                            <div class="trip-action-buttons">
                                <button class="edit-trip-btn" onclick="openEditTripModal()">✏️ <span id="editTripText">Edit</span></button>
                                <button class="delete-trip-btn" onclick="deleteTrip()">🗑️ <span id="deleteTripText">Delete</span></button>
                            </div>
                        </div>
                        <div class="trip-subtitle-inline" id="tripSubtitleInline"></div>
                    </div>

                    <!-- Cities Section -->
                    <div class="cities-section">
                        <div class="cities-header">
                            <h3 id="citiesTitle">Cities & Destinations</h3>
                            <button class="add-city-link" onclick="openAddCityModal()">+ <span id="addCityText">Add City</span></button>
                        </div>
                        <div class="cities-list" id="citiesList">
                            <p class="no-cities" id="noCitiesText">No cities added yet. Click "Add City" to start planning!</p>
                        </div>
                    </div>

                    <!-- Activities -->
                    <div class="activities-section">
                        <div class="activities-header">
                            <h3 id="activitiesTitle">Activities</h3>
                            <button class="add-activity-link" onclick="addActivity()"><span id="addActivityText">Add Activity</span></button>
                        </div>
                        <div class="activities-list" id="activitiesList">
                            <p class="no-activities" id="noActivitiesText">No activities yet.</p>
                        </div>
                    </div>

                    <!-- Notes Section -->
                    <div class="notes-section">
                        <h3 id="notesTitle">Notes</h3>
                        <textarea class="trip-notes" id="tripNotes" placeholder="Quick trip notes..." oninput="saveCurrentTrip()"></textarea>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="trip-tabs">
                    <button class="trip-tab active" onclick="switchTripTab('itinerary')" id="itineraryTab">
                        <span id="itineraryTabLabel">Itinerary</span>
                    </button>
                    <button class="trip-tab" onclick="switchTripTab('packing')" id="packingTab">
                        <span id="packingTabLabel">Packing</span>
                    </button>
                </div>

                <!-- Tab Content: Itinerary -->
                <div class="trip-tab-content active" id="itineraryTabContent">
                    <div class="itinerary-timeline">
                        <div class="itinerary-grid" id="itineraryGrid">
                            <!-- Generated dynamically -->
                        </div>
                    </div>
                </div>

                <!-- Tab Content: Packing -->
                <div class="trip-tab-content" id="packingTabContent">

                <!-- Checklists -->
                <div class="checklists-header-section">
                    <button class="add-list-btn" id="addCustomListBtn" onclick="toggleCustomList()">
                        + <span id="addListBtnText">Add List</span>
                    </button>
                </div>
                <div class="checklists-section" id="checklistsSection">
                    <div class="checklist-column">
                        <div class="checklist-header">
                            <h3 id="essentialsTitle">Essentials</h3>
                        </div>
                        <div class="checklist-items" id="essentialsList"></div>
                        <button class="add-btn" onclick="addChecklistItem('essentials')">+ <span id="addItemText1">Add Item</span></button>
                    </div>

                    <div class="checklist-column">
                        <div class="checklist-header">
                            <h3 id="toiletriesTitle">Toiletries & Wellness</h3>
                        </div>
                        <div class="checklist-items" id="toiletriesList"></div>
                        <button class="add-btn" onclick="addChecklistItem('toiletries')">+ <span id="addItemText2">Add Item</span></button>
                    </div>

                    <div class="checklist-column hidden" id="customListColumn">
                        <div class="checklist-header">
                            <h3><input type="text" id="customListName" placeholder="Custom List" oninput="saveCurrentTrip()"></h3>
                        </div>
                        <div class="checklist-items" id="customList"></div>
                        <button class="add-btn" onclick="addChecklistItem('custom')">+ <span id="addItemText3">Add Item</span></button>
                    </div>
                </div>

                <!-- Outfit Planner -->
                <div class="outfit-planner">
                    <h3 id="outfitPlannerTitle">Outfit Planner</h3>
                    <div id="outfitPlannerContent"></div>
                </div>

                </div> <!-- End packingTabContent -->
            </div>
        </div>

                </div>
            </main>
        </div>

        <!-- Itinerary Add/Edit Modal -->
        <div id="itineraryModal" class="itinerary-modal hidden">
            <div class="itinerary-modal-content">
                <h3 id="itineraryModalTitle">Add to Itinerary</h3>
                
                <!-- Type Selector -->
                <div class="itinerary-type-selector">
                    <button class="itinerary-type-btn active" onclick="selectItineraryType('activity')" id="activityTypeBtn">
                        🎯 <span id="activityTypeText">Activity</span>
                    </button>
                    <button class="itinerary-type-btn" onclick="selectItineraryType('transport')" id="transportTypeBtn">
                        ✈️ <span id="transportTypeText">Transport</span>
                    </button>
                </div>

                <!-- Activity Form -->
                <div id="activityForm">
                    <div class="form-group">
                        <label id="activityNameLabel">Activity Name</label>
                        <input type="text" id="itineraryActivityName" placeholder="What are you doing?" class="modal-input">
                    </div>
                    <div class="form-group">
                        <label id="activityEmojiLabel">Emoji</label>
                        <button type="button" class="trip-emoji-button modal-emoji-button" id="itineraryActivityEmoji" onclick="openItineraryEmojiPicker()">🎯</button>
                    </div>
                    <div class="form-group">
                        <label id="activityStartTimeLabel">Start Time</label>
                        <input type="time" id="itineraryActivityStartTime" class="modal-input">
                    </div>
                    <div class="form-group">
                        <label id="activityEndTimeLabel">End Time</label>
                        <input type="time" id="itineraryActivityEndTime" class="modal-input">
                    </div>
                    <div class="form-group">
                        <label id="activityTypeLabel">Time of Day</label>
                        <select id="itineraryActivityType" class="modal-select">
                            <option value="day">☀️ Day</option>
                            <option value="night">🌙 Night</option>
                        </select>
                    </div>
                </div>

                <!-- Transport Form -->
                <div id="transportForm" class="hidden">
                    <div class="form-group">
                        <label id="transportTypeLabel">Transport Type</label>
                        <select id="itineraryTransportType" class="modal-select">
                            <option value="flight">✈️ Flight</option>
                            <option value="train">🚄 Train</option>
                            <option value="bus">🚌 Bus</option>
                            <option value="car">🚗 Car</option>
                            <option value="ferry">⛴️ Ferry</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label id="transportStartTimeLabel">Departure Time</label>
                        <input type="time" id="itineraryTransportStartTime" class="modal-input">
                    </div>
                    <div class="form-group">
                        <label id="transportEndTimeLabel">Arrival Time</label>
                        <input type="time" id="itineraryTransportEndTime" class="modal-input">
                    </div>
                    <div class="form-group">
                        <label id="transportNameLabel">Details</label>
                        <input type="text" id="itineraryTransportName" placeholder="Flight number / Route" class="modal-input">
                    </div>
                    <div class="form-group">
                        <label id="transportFromLabel">From</label>
                        <input type="text" id="itineraryTransportFrom" placeholder="Departure city" class="modal-input">
                    </div>
                    <div class="form-group">
                        <label id="transportToLabel">To</label>
                        <input type="text" id="itineraryTransportTo" placeholder="Arrival city" class="modal-input">
                    </div>
                    <div class="form-group">
                        <label id="transportCostLabel">Cost (Optional)</label>
                        <input type="number" id="itineraryTransportCost" placeholder="0.00" class="modal-input">
                    </div>
                </div>

                <div class="modal-footer-buttons">
                    <button class="btn" onclick="saveItineraryItem()">
                        <span id="saveItineraryText">Save</span>
                    </button>
                    <button class="btn btn-secondary" onclick="closeItineraryModal()">
                        <span id="cancelItineraryText">Cancel</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Date Range Picker Modal -->
        <div id="dateRangePicker" class="date-range-picker hidden">
            <div class="calendar-header">
                <button type="button" onclick="changeMonth(-1)">←</button>
                <h4 id="calendarMonth"></h4>
                <button type="button" onclick="changeMonth(1)">→</button>
            </div>
            <div class="calendar-weekdays" id="calendarWeekdays"></div>
            <div class="calendar-days" id="calendarDays"></div>
            <div class="selected-dates-display">
                <p id="selectedDatesText">Select start and end dates</p>
                <p class="date-range" id="selectedDatesRange"></p>
            </div>
            <button class="btn calendar-close-btn" id="calendarDoneBtn" onclick="closeCalendar()">Done</button>
        </div>

        <!-- Edit Trip Modal -->
        <div id="editTripModal" class="date-range-picker hidden">
            <h3 id="editTripModalTitle" class="modal-title-inline">Edit Trip</h3>
            <div class="form-group modal-form-group-inline">
                <label id="editDestinationLabel" class="modal-label-inline">Destination</label>
                <input type="text" id="editDestination" placeholder="Enter destination" class="modal-input">
            </div>
            <div class="form-group modal-form-group-inline">
                <label id="editDatesLabel" class="modal-label-inline">Travel Dates</label>
                <button type="button" class="date-picker-button" id="editDatePickerButton" onclick="openEditTripCalendar()">
                    <span id="editDatePickerButtonText">Click to select dates</span>
                    <span>📅</span>
                </button>
            </div>
            <div class="modal-actions-wrapper">
                <button class="btn modal-edit-btn-inline" onclick="saveEditedTrip()">
                    <span id="saveEditTripText">Save Changes</span>
                </button>
                <button class="btn btn-secondary modal-edit-btn-inline" onclick="closeEditTripModal()">
                    <span id="cancelEditTripText">Cancel</span>
                </button>
            </div>
        </div>

        <!-- Edit Trip Calendar -->
        <div id="editTripCalendar" class="date-range-picker hidden">
            <div class="calendar-header">
                <button type="button" onclick="changeEditTripMonth(-1)">←</button>
                <h4 id="editCalendarMonth"></h4>
                <button type="button" onclick="changeEditTripMonth(1)">→</button>
            </div>
            <div class="calendar-weekdays" id="editCalendarWeekdays"></div>
            <div class="calendar-days" id="editCalendarDays"></div>
            <div class="selected-dates-display">
                <p id="editSelectedDatesText">Select start and end dates</p>
                <p class="date-range" id="editSelectedDatesRange"></p>
            </div>
            <button class="btn calendar-close-btn" onclick="closeEditTripCalendar()">Done</button>
        </div>

        <!-- Add City Modal -->
        <div id="addCityModal" class="date-range-picker hidden">
            <h3 id="addCityModalTitle" class="modal-title-inline">Add City</h3>
            <div class="form-group modal-form-group-inline">
                <label id="cityDestinationLabel" class="modal-label-inline">City</label>
                <div class="autocomplete-container">
                    <input type="text" id="cityDestination" placeholder="e.g., Paris, France" autocomplete="off" class="modal-input">
                    <div id="citySuggestions" class="autocomplete-suggestions"></div>
                </div>
            </div>
            <div class="form-group modal-form-group-inline">
                <label id="cityDatesLabel" class="modal-label-inline">Dates in this city</label>
                <button type="button" class="date-picker-button" id="cityDatePickerButton" onclick="openCityCalendar()">
                    <span id="cityDatePickerButtonText">Click to select dates</span>
                    <span>📅</span>
                </button>
            </div>
            <div class="modal-actions-wrapper">
                <button class="btn modal-edit-btn-inline" onclick="saveCityToTrip()">
                    <span id="saveCityText">Add City</span>
                </button>
                <button class="btn btn-secondary modal-edit-btn-inline" onclick="closeAddCityModal()">
                    <span id="cancelCityText">Cancel</span>
                </button>
            </div>
        </div>

        <!-- City Calendar Picker -->
        <div id="cityCalendar" class="date-range-picker hidden">
            <div class="calendar-header">
                <button type="button" onclick="changeCityMonth(-1)">←</button>
                <h4 id="cityCalendarMonth"></h4>
                <button type="button" onclick="changeCityMonth(1)">→</button>
            </div>
            <div class="calendar-weekdays" id="cityCalendarWeekdays"></div>
            <div class="calendar-days" id="cityCalendarDays"></div>
            <div class="selected-dates-display">
                <p id="citySelectedDatesText">Select start and end dates</p>
                <p class="date-range" id="citySelectedDatesRange"></p>
            </div>
            <button class="btn calendar-close-btn" onclick="closeCityCalendar()">Done</button>
        </div>

        <!-- Emoji Picker -->
        <div id="emojiPicker" class="emoji-picker hidden">
            <h3 style="margin-bottom: 15px;">Select Emoji</h3>
            <div class="emoji-grid" id="emojiGrid"></div>
            <button class="btn" onclick="closeEmojiPicker()">Close</button>
        </div>
        <div id="overlay" class="overlay hidden" onclick="closeOverlay()"></div>

        <!-- Activity Modal -->
        <div id="activityModal" class="activity-modal hidden">
            <div class="activity-modal-content">
                <div class="activity-modal-header">
                    <h3 id="activityModalTitle">Add Activity</h3>
                    <button class="activity-modal-close" onclick="closeActivityModal()">×</button>
                </div>
                
                <div class="activity-modal-body">
                    <div class="form-group">
                        <label id="activityNameLabel">Activity Name</label>
                        <input type="text" id="activityNameInput" placeholder="Enter activity name">
                    </div>
                    
                    <div class="form-group">
                        <label id="activityEmojiLabel">Emoji</label>
                        <button type="button" class="activity-emoji-button" id="activityEmojiButton" onclick="openEmojiPickerForActivity()">
                            <span id="activityEmojiDisplay">🎯</span>
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label id="activityDateLabel">Date</label>
                        <button type="button" class="activity-date-button" id="activityDateButton" onclick="openCalendarForActivity()">
                            <span id="activityDateDisplay">Select date</span>
                            <span>📅</span>
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label id="activityTypeLabel">Time of Day</label>
                        <div class="activity-toggle">
                            <button class="activity-toggle-btn active" data-type="day" onclick="selectActivityType('day')">
                                <span>☀️</span>
                                <span id="activityDayLabel">Day</span>
                            </button>
                            <button class="activity-toggle-btn" data-type="night" onclick="selectActivityType('night')">
                                <span>🌙</span>
                                <span id="activityNightLabel">Night</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="activity-modal-footer">
                    <button class="btn btn-secondary" onclick="closeActivityModal()" id="activityCancelBtn">Cancel</button>
                    <button class="btn" onclick="saveActivityFromModal()" id="activitySaveBtn">Add Activity</button>
                </div>
            </div>
        </div>

        <!-- Emoji Picker Modal -->
        <div id="emojiPickerModal" class="emoji-picker-modal hidden">
            <div class="emoji-picker-content">
                <div class="emoji-picker-header">
                    <h3 id="emojiPickerTitle">Choose an Emoji</h3>
                    <button class="emoji-picker-close" onclick="closeEmojiPicker()">×</button>
                </div>
                <div class="emoji-picker-search">
                    <input type="text" id="emojiSearchInput" placeholder="Search emojis..." oninput="searchEmojis(this.value)">
                </div>
                <div class="emoji-picker-categories">
                    <button class="emoji-category-btn active" data-category="all" onclick="filterEmojiCategory('all')">🌟 All</button>
                    <button class="emoji-category-btn" data-category="smileys" onclick="filterEmojiCategory('smileys')">😀 Smileys</button>
                    <button class="emoji-category-btn" data-category="animals" onclick="filterEmojiCategory('animals')">🐶 Animals</button>
                    <button class="emoji-category-btn" data-category="food" onclick="filterEmojiCategory('food')">🍕 Food</button>
                    <button class="emoji-category-btn" data-category="activities" onclick="filterEmojiCategory('activities')">⚽ Activities</button>
                    <button class="emoji-category-btn" data-category="travel" onclick="filterEmojiCategory('travel')">✈️ Travel</button>
                    <button class="emoji-category-btn" data-category="objects" onclick="filterEmojiCategory('objects')">💡 Objects</button>
                    <button class="emoji-category-btn" data-category="symbols" onclick="filterEmojiCategory('symbols')">❤️ Symbols</button>
                    <button class="emoji-category-btn" data-category="flags" onclick="filterEmojiCategory('flags')">🏁 Flags</button>
                </div>
                <div class="emoji-picker-grid" id="emojiPickerGrid">
                    <!-- Emojis will be populated here -->
                </div>
            </div>
        </div>

        <!-- Activity Date Picker Modal -->
        <div id="activityDatePicker" class="activity-date-picker hidden">
            <div class="calendar-header">
                <h4 id="activityDatePickerTitle">Select Date</h4>
                <button class="calendar-close-icon" onclick="closeActivityDatePicker()">×</button>
            </div>
            <div class="calendar-nav">
                <button onclick="changeActivityMonth(-1)">←</button>
                <span id="activityMonthYear"></span>
                <button onclick="changeActivityMonth(1)">→</button>
            </div>
            <div class="calendar-weekdays">
                <div class="calendar-weekday">S</div>
                <div class="calendar-weekday">M</div>
                <div class="calendar-weekday">T</div>
                <div class="calendar-weekday">W</div>
                <div class="calendar-weekday">T</div>
                <div class="calendar-weekday">F</div>
                <div class="calendar-weekday">S</div>
            </div>
            <div class="calendar-days" id="activityCalendarDays">
                <!-- Days will be populated here -->
            </div>
        </div>
    </div>

    <script>
        // Language translations
        const translations = {
            en: {
                authTitle: "Pack Smarter.",
                nameLabel: "Name",
                namePlaceholder: "Enter your name",
                usernameLabel: "Username",
                usernamePlaceholder: "Enter username",
                passwordLabel: "Password",
                passwordPlaceholder: "Enter password",
                loginBtn: "Login",
                registerBtn: "Register",
                forgotPasswordLink: "Forgot Password?",
                resetPasswordTitle: "Reset Password",
                resetUsernameLabel: "Username",
                resetNameLabel: "Name",
                newPasswordLabel: "New Password",
                resetPasswordBtn: "Reset Password",
                backToLoginLink: "Back to Login",
                editTripText: "Edit",
                deleteTripText: "Delete",
                editTripModalTitle: "Edit Trip",
                editDestinationLabel: "Destination",
                editDatesLabel: "Travel Dates",
                saveEditTripText: "Save Changes",
                cancelEditTripText: "Cancel",
                logoutBtn: "Logout",
                appTitle: "🧳 Packing Planner",
                createTripTitle: "Create New Trip",
                tripNameLabel: "Trip Name",
                tripEmojiLabel: "Emoji",
                destinationLabel: "Destination",
                startDateLabel: "Start Date",
                endDateLabel: "End Date",
                createTripBtn: "Create Trip",
                citiesTitle: "Cities & Destinations",
                addCityText: "Add City",
                noCitiesText: "No cities added yet. Click \"Add City\" to start planning!",
                addCityModalTitle: "Add City",
                cityDestinationLabel: "City",
                cityDatesLabel: "Dates in this city",
                saveCityText: "Add City",
                cancelCityText: "Cancel",
                citySelectedDatesText: "Select start and end dates",
                editCityText: "Edit",
                deleteCityText: "Delete",
                upcomingTripsTitle: "Upcoming trips",
                pastTripsTitle: "Past trips",
                backBtnText: "Back to Trips",
                startLabel: "Start Date",
                endLabel: "End Date",
                durationLabel: "Duration",
                socketLabel: "Socket Type",
                activitiesTitle: "Activities",
                addActivityText: "Add Activity",
                essentialsTitle: "Essentials",
                toiletriesTitle: "Toiletries & Wellness",
                addItemText1: "Add Item",
                addItemText2: "Add Item",
                addItemText3: "Add Item",
                addListBtnText: "Add List",
                outfitPlannerTitle: "Outfit Planner",
                dateRangeLabel: "Select Travel Dates",
                selectDatesPrompt: "Select start and end dates",
                clickToSelectDates: "Click to select dates",
                calendarDoneBtn: "Done",
                subheadingText: "Plan your itinerary with us",
                viewDetailsLink: "Details",
                notesTitle: "Notes",
                deleteTripText: "Delete",
                noActivitiesText: "No activities yet.",
                dayActivity: "Day",
                nightActivity: "Night",
                days: "days",
                daysLeft: "days left",
                dayOutfit: "Day Outfit",
                nightOutfit: "Night Outfit",
                top: "Top",
                bottom: "Bottom",
                jacket: "Jacket",
                accessory: "Accessory",
                shoes: "Shoes",
                weather: "Weather",
                activities: "Activities",
                week: "Week",
                apiBannerTitle: "Enable Real Weather Data",
                apiBannerText: "Get a free API key from WeatherAPI.com and add it to line 1731 of the code to see real weather forecasts for your trips!",
                upcomingTripsSidebarTitle: "UPCOMING TRIPS",
                pastTripsSidebarTitle: "PAST TRIPS",
                newTripCtaText: "New Trip",
                langBtnText: "ES / EN",
                logoutBtnText: "Logout",
                itineraryTabLabel: "Itinerary",
                packingTabLabel: "Packing",
                activityTypeText: "Activity",
                transportTypeText: "Transport",
                activityNameLabel: "Activity Name",
                activityStartTimeLabel: "Start Time",
                activityEndTimeLabel: "End Time",
                transportTypeLabel: "Transport Type",
                transportStartTimeLabel: "Departure Time",
                transportEndTimeLabel: "Arrival Time",
                transportNameLabel: "Details",
                transportFromLabel: "From",
                transportToLabel: "To",
                transportCostLabel: "Cost (Optional)",
                saveItineraryText: "Save",
                cancelItineraryText: "Cancel"
            },
            es: {
                authTitle: "Empaca Mejor.",
                nameLabel: "Nombre",
                namePlaceholder: "Ingresa tu nombre",
                usernameLabel: "Usuario",
                usernamePlaceholder: "Ingresa tu usuario",
                passwordLabel: "Contraseña",
                passwordPlaceholder: "Ingresa tu contraseña",
                loginBtn: "Iniciar Sesión",
                registerBtn: "Registrarse",
                forgotPasswordLink: "¿Olvidaste tu Contraseña?",
                resetPasswordTitle: "Restablecer Contraseña",
                resetUsernameLabel: "Usuario",
                resetNameLabel: "Nombre",
                newPasswordLabel: "Nueva Contraseña",
                resetPasswordBtn: "Restablecer Contraseña",
                backToLoginLink: "Volver al Inicio de Sesión",
                editTripText: "Editar",
                deleteTripText: "Eliminar",
                editTripModalTitle: "Editar Viaje",
                editDestinationLabel: "Destino",
                editDatesLabel: "Fechas de Viaje",
                saveEditTripText: "Guardar Cambios",
                cancelEditTripText: "Cancelar",
                logoutBtn: "Cerrar Sesión",
                appTitle: "🧳 Planificador de Maletas",
                createTripTitle: "Crear Nuevo Viaje",
                tripNameLabel: "Nombre del Viaje",
                tripEmojiLabel: "Emoji",
                destinationLabel: "Destino",
                startDateLabel: "Fecha de Inicio",
                endDateLabel: "Fecha de Fin",
                createTripBtn: "Crear Viaje",
                citiesTitle: "Ciudades y Destinos",
                addCityText: "Agregar Ciudad",
                noCitiesText: "Aún no hay ciudades. ¡Haz clic en \"Agregar Ciudad\" para comenzar a planificar!",
                addCityModalTitle: "Agregar Ciudad",
                cityDestinationLabel: "Ciudad",
                cityDatesLabel: "Fechas en esta ciudad",
                saveCityText: "Agregar Ciudad",
                cancelCityText: "Cancelar",
                citySelectedDatesText: "Selecciona fechas de inicio y fin",
                editCityText: "Editar",
                deleteCityText: "Eliminar",
                upcomingTripsTitle: "Próximos viajes",
                pastTripsTitle: "Viajes pasados",
                backBtnText: "Volver a Viajes",
                startLabel: "Fecha Inicio",
                endLabel: "Fecha Fin",
                durationLabel: "Duración",
                socketLabel: "Tipo de Enchufe",
                activitiesTitle: "Actividades",
                addActivityText: "Añadir Actividad",
                essentialsTitle: "Esenciales",
                toiletriesTitle: "Aseo y Bienestar",
                addItemText1: "Añadir Artículo",
                addItemText2: "Añadir Artículo",
                addItemText3: "Añadir Artículo",
                addListBtnText: "Añadir Lista",
                outfitPlannerTitle: "Planificador de Ropa",
                dateRangeLabel: "Seleccionar Fechas de Viaje",
                selectDatesPrompt: "Seleccione fechas de inicio y fin",
                clickToSelectDates: "Haga clic para seleccionar fechas",
                calendarDoneBtn: "Listo",
                subheadingText: "Planifica tu itinerario con nosotros",
                viewDetailsLink: "Detalles",
                notesTitle: "Notas",
                deleteTripText: "Eliminar",
                noActivitiesText: "No hay actividades aún.",
                dayActivity: "Día",
                nightActivity: "Noche",
                days: "días",
                daysLeft: "días restantes",
                dayOutfit: "Outfit de Día",
                nightOutfit: "Outfit de Noche",
                top: "Superior",
                bottom: "Inferior",
                jacket: "Chaqueta",
                accessory: "Accesorio",
                shoes: "Zapatos",
                weather: "Clima",
                activities: "Actividades",
                week: "Semana",
                apiBannerTitle: "Activar Datos Meteorológicos Reales",
                apiBannerText: "Obtenga una clave API gratuita de WeatherAPI.com y agréguela en la línea 1731 del código para ver pronósticos meteorológicos reales para sus viajes!",
                upcomingTripsSidebarTitle: "PRÓXIMOS VIAJES",
                pastTripsSidebarTitle: "VIAJES PASADOS",
                newTripCtaText: "Nuevo Viaje",
                langBtnText: "ES / EN",
                logoutBtnText: "Cerrar Sesión",
                itineraryTabLabel: "Itinerario",
                packingTabLabel: "Empaque",
                activityTypeText: "Actividad",
                transportTypeText: "Transporte",
                activityNameLabel: "Nombre de Actividad",
                activityStartTimeLabel: "Hora de Inicio",
                activityEndTimeLabel: "Hora de Fin",
                transportTypeLabel: "Tipo de Transporte",
                transportStartTimeLabel: "Hora de Salida",
                transportEndTimeLabel: "Hora de Llegada",
                transportNameLabel: "Detalles",
                transportFromLabel: "Desde",
                transportToLabel: "Hasta",
                transportCostLabel: "Costo (Opcional)",
                saveItineraryText: "Guardar",
                cancelItineraryText: "Cancelar"
            }
        };

        let currentLanguage = localStorage.getItem('language') || 'en';
        let currentUser = null;
        let currentTrip = null;
        let selectedActivityIndex = null;
        let selectedActivityDate = '';
        let selectedActivityType = 'day';
        let selectedActivityEmoji = '🎯';
        let activityModalSource = ''; // 'planner' or 'info'
        let isActivityCalendarOpen = false;
        let emojiPickerContext = null; // 'trip', 'activity', 'activityModal', or 'tripCreation'
        let tripCreationEmoji = '🌍'; // Default emoji for new trip
        let selectedStartDate = null;
        let selectedEndDate = null;
        let currentCalendarMonth = new Date();
        let isSelectingRange = false;
        let activityDatePickerMonth = new Date();
        let selectedActivityIndexForDate = null;
        let selectedActivityDateValue = null;

        // Socket types by country/region (legacy, kept for reference)
        const socketTypes = {
            'usa': 'Type A/B',
            'uk': 'Type G',
            'europe': 'Type C/F',
            'australia': 'Type I',
            'china': 'Type A/I',
            'japan': 'Type A/B',
            'india': 'Type D/M',
            'default': 'Type C/F'
        };

        // Get country flag emoji based on destination
        function getCountryFlagEmoji(destination) {
            if (!destination) {
                return '🌍';
            }
            
            const dest = destination.toLowerCase();
            
            // Country name to flag emoji mapping
            const flagMap = {
                // North America
                'usa': '🇺🇸', 'united states': '🇺🇸', 'america': '🇺🇸',
                'canada': '🇨🇦',
                'mexico': '🇲🇽',
                'costa rica': '🇨🇷',
                'panama': '🇵🇦',
                'jamaica': '🇯🇲',
                'bahamas': '🇧🇸',
                'barbados': '🇧🇧',
                
                // Europe
                'uk': '🇬🇧', 'united kingdom': '🇬🇧', 'england': '🇬🇧', 'scotland': '🇬🇧', 'wales': '🇬🇧',
                'france': '🇫🇷', 'paris': '🇫🇷',
                'spain': '🇪🇸', 'madrid': '🇪🇸', 'barcelona': '🇪🇸',
                'italy': '🇮🇹', 'rome': '🇮🇹', 'milan': '🇮🇹', 'venice': '🇮🇹',
                'germany': '🇩🇪', 'berlin': '🇩🇪', 'munich': '🇩🇪',
                'portugal': '🇵🇹', 'lisbon': '🇵🇹',
                'netherlands': '🇳🇱', 'amsterdam': '🇳🇱',
                'belgium': '🇧🇪', 'brussels': '🇧🇪',
                'switzerland': '🇨🇭',
                'austria': '🇦🇹', 'vienna': '🇦🇹',
                'greece': '🇬🇷', 'athens': '🇬🇷',
                'ireland': '🇮🇪', 'dublin': '🇮🇪',
                'poland': '🇵🇱',
                'czech': '🇨🇿', 'prague': '🇨🇿',
                'sweden': '🇸🇪', 'stockholm': '🇸🇪',
                'norway': '🇳🇴', 'oslo': '🇳🇴',
                'denmark': '🇩🇰', 'copenhagen': '🇩🇰',
                'finland': '🇫🇮', 'helsinki': '🇫🇮',
                'iceland': '🇮🇸', 'reykjavik': '🇮🇸',
                'croatia': '🇭🇷',
                'hungary': '🇭🇺', 'budapest': '🇭🇺',
                'romania': '🇷🇴',
                'turkey': '🇹🇷', 'istanbul': '🇹🇷',
                
                // South America
                'brazil': '🇧🇷', 'sao paulo': '🇧🇷', 'rio': '🇧🇷',
                'argentina': '🇦🇷', 'buenos aires': '🇦🇷',
                'chile': '🇨🇱', 'santiago': '🇨🇱',
                'peru': '🇵🇪', 'lima': '🇵🇪',
                'colombia': '🇨🇴', 'bogota': '🇨🇴',
                'ecuador': '🇪🇨', 'quito': '🇪🇨',
                'bolivia': '🇧🇴',
                'uruguay': '🇺🇾', 'montevideo': '🇺🇾',
                'venezuela': '🇻🇪', 'caracas': '🇻🇪',
                'paraguay': '🇵🇾',
                
                // Asia
                'japan': '🇯🇵', 'tokyo': '🇯🇵', 'osaka': '🇯🇵', 'kyoto': '🇯🇵',
                'china': '🇨🇳', 'beijing': '🇨🇳', 'shanghai': '🇨🇳',
                'south korea': '🇰🇷', 'korea': '🇰🇷', 'seoul': '🇰🇷',
                'india': '🇮🇳', 'delhi': '🇮🇳', 'mumbai': '🇮🇳', 'bangalore': '🇮🇳',
                'thailand': '🇹🇭', 'bangkok': '🇹🇭',
                'vietnam': '🇻🇳', 'hanoi': '🇻🇳', 'ho chi minh': '🇻🇳',
                'singapore': '🇸🇬',
                'malaysia': '🇲🇾', 'kuala lumpur': '🇲🇾',
                'indonesia': '🇮🇩', 'bali': '🇮🇩', 'jakarta': '🇮🇩',
                'philippines': '🇵🇭', 'manila': '🇵🇭',
                'hong kong': '🇭🇰',
                'taiwan': '🇹🇼', 'taipei': '🇹🇼',
                
                // Middle East
                'dubai': '🇦🇪', 'uae': '🇦🇪', 'emirates': '🇦🇪',
                'qatar': '🇶🇦', 'doha': '🇶🇦',
                'saudi': '🇸🇦', 'riyadh': '🇸🇦',
                'israel': '🇮🇱', 'tel aviv': '🇮🇱', 'jerusalem': '🇮🇱',
                'kuwait': '🇰🇼',
                'bahrain': '🇧🇭',
                'oman': '🇴🇲',
                
                // Oceania
                'australia': '🇦🇺', 'sydney': '🇦🇺', 'melbourne': '🇦🇺',
                'new zealand': '🇳🇿', 'auckland': '🇳🇿', 'wellington': '🇳🇿',
                
                // Africa
                'south africa': '🇿🇦', 'cape town': '🇿🇦', 'johannesburg': '🇿🇦',
                'egypt': '🇪🇬', 'cairo': '🇪🇬',
                'morocco': '🇲🇦', 'marrakech': '🇲🇦',
                'kenya': '🇰🇪', 'nairobi': '🇰🇪',
                'tanzania': '🇹🇿',
                'nigeria': '🇳🇬'
            };
            
            // Check for exact or partial matches
            for (let key in flagMap) {
                if (dest.includes(key)) {
                    return flagMap[key];
                }
            }
            
            // Default to world emoji if no match
            return '🌍';
        }

        // Get voltage by socket type
        function getVoltage(socketType) {
            if (socketType.includes('A/B') && socketType.includes('110')) return '110V';
            if (socketType.includes('A/B')) return '100-110V';
            if (socketType.includes('G')) return '230V';
            if (socketType.includes('C/F')) return '220-230V';
            if (socketType.includes('C/I')) return '220V';
            if (socketType.includes('I')) return '230V';
            if (socketType.includes('A/I')) return '220V';
            if (socketType.includes('D/M')) return '230V';
            if (socketType.includes('A/C')) return '220V';
            if (socketType.includes('C/G')) return '220-240V';
            if (socketType.includes('M')) return '230V';
            if (socketType.includes('C/H')) return '230V';
            return '220V';
        }

        // Get SVG icon for socket type
        function getSocketSVG(socketType) {
            const svgStyle = 'display: inline-block; vertical-align: middle; margin-right: 6px;';
            
            // Type A/B - North American (flat parallel blades)
            if (socketType.includes('A/B')) {
                return `<svg width="18" height="18" viewBox="0 0 24 24" style="${svgStyle}" fill="none">
                    <rect x="5" y="3" width="14" height="18" rx="2" fill="#666" stroke="#444" stroke-width="1"/>
                    <rect x="9" y="7" width="2" height="6" rx="0.5" fill="#FFD700"/>
                    <rect x="13" y="7" width="2" height="6" rx="0.5" fill="#FFD700"/>
                    <circle cx="12" cy="16" r="1.5" fill="#888"/>
                </svg>`;
            }
            
            // Type C/F - European (two round pins)
            if (socketType.includes('C/F')) {
                return `<svg width="18" height="18" viewBox="0 0 24 24" style="${svgStyle}" fill="none">
                    <rect x="5" y="3" width="14" height="18" rx="2" fill="#666" stroke="#444" stroke-width="1"/>
                    <circle cx="9.5" cy="11" r="2" fill="#FFD700"/>
                    <circle cx="14.5" cy="11" r="2" fill="#FFD700"/>
                    <rect x="6" y="16" width="12" height="3" rx="1" fill="#888"/>
                </svg>`;
            }
            
            // Type G - UK (three rectangular pins)
            if (socketType.includes('G')) {
                return `<svg width="18" height="18" viewBox="0 0 24 24" style="${svgStyle}" fill="none">
                    <rect x="5" y="3" width="14" height="18" rx="2" fill="#666" stroke="#444" stroke-width="1"/>
                    <rect x="9" y="6" width="1.5" height="5" rx="0.5" fill="#FFD700"/>
                    <rect x="13.5" y="6" width="1.5" height="5" rx="0.5" fill="#FFD700"/>
                    <rect x="10.75" y="13" width="2.5" height="6" rx="0.5" fill="#FFD700"/>
                </svg>`;
            }
            
            // Type I - Australian (angled flat pins)
            if (socketType.includes('I')) {
                return `<svg width="18" height="18" viewBox="0 0 24 24" style="${svgStyle}" fill="none">
                    <rect x="5" y="3" width="14" height="18" rx="2" fill="#666" stroke="#444" stroke-width="1"/>
                    <rect x="8" y="8" width="2.5" height="5" rx="0.5" fill="#FFD700" transform="rotate(-15 9.25 10.5)"/>
                    <rect x="13.5" y="8" width="2.5" height="5" rx="0.5" fill="#FFD700" transform="rotate(15 14.75 10.5)"/>
                    <circle cx="12" cy="16" r="1.5" fill="#888"/>
                </svg>`;
            }
            
            // Type C/I - South American (mix)
            if (socketType.includes('C/I')) {
                return `<svg width="18" height="18" viewBox="0 0 24 24" style="${svgStyle}" fill="none">
                    <rect x="5" y="3" width="14" height="18" rx="2" fill="#666" stroke="#444" stroke-width="1"/>
                    <circle cx="9.5" cy="10" r="1.8" fill="#FFD700"/>
                    <circle cx="14.5" cy="10" r="1.8" fill="#FFD700"/>
                    <circle cx="12" cy="15" r="1.5" fill="#FFD700"/>
                </svg>`;
            }
            
            // Type D/M - Indian (three round pins)
            if (socketType.includes('D/M')) {
                return `<svg width="18" height="18" viewBox="0 0 24 24" style="${svgStyle}" fill="none">
                    <rect x="5" y="3" width="14" height="18" rx="2" fill="#666" stroke="#444" stroke-width="1"/>
                    <circle cx="8" cy="11" r="1.8" fill="#FFD700"/>
                    <circle cx="16" cy="11" r="1.8" fill="#FFD700"/>
                    <circle cx="12" cy="15" r="1.8" fill="#FFD700"/>
                </svg>`;
            }
            
            // Type A/C - Southeast Asian (mixed)
            if (socketType.includes('A/C')) {
                return `<svg width="18" height="18" viewBox="0 0 24 24" style="${svgStyle}" fill="none">
                    <rect x="5" y="3" width="14" height="18" rx="2" fill="#666" stroke="#444" stroke-width="1"/>
                    <rect x="9" y="8" width="2" height="5" rx="0.5" fill="#FFD700"/>
                    <circle cx="14" cy="10.5" r="1.8" fill="#FFD700"/>
                    <circle cx="12" cy="16" r="1.5" fill="#888"/>
                </svg>`;
            }
            
            // Type C/G - Middle East (hybrid)
            if (socketType.includes('C/G')) {
                return `<svg width="18" height="18" viewBox="0 0 24 24" style="${svgStyle}" fill="none">
                    <rect x="5" y="3" width="14" height="18" rx="2" fill="#666" stroke="#444" stroke-width="1"/>
                    <circle cx="9.5" cy="9" r="1.8" fill="#FFD700"/>
                    <circle cx="14.5" cy="9" r="1.8" fill="#FFD700"/>
                    <rect x="10.5" y="14" width="3" height="5" rx="0.5" fill="#FFD700"/>
                </svg>`;
            }
            
            // Type M - South African (large round pins)
            if (socketType.includes('M')) {
                return `<svg width="18" height="18" viewBox="0 0 24 24" style="${svgStyle}" fill="none">
                    <rect x="5" y="3" width="14" height="18" rx="2" fill="#666" stroke="#444" stroke-width="1"/>
                    <circle cx="8.5" cy="10" r="2.2" fill="#FFD700"/>
                    <circle cx="15.5" cy="10" r="2.2" fill="#FFD700"/>
                    <circle cx="12" cy="16" r="2" fill="#FFD700"/>
                </svg>`;
            }
            
            // Type C/H - Israeli
            if (socketType.includes('C/H')) {
                return `<svg width="18" height="18" viewBox="0 0 24 24" style="${svgStyle}" fill="none">
                    <rect x="5" y="3" width="14" height="18" rx="2" fill="#666" stroke="#444" stroke-width="1"/>
                    <circle cx="9.5" cy="10" r="1.8" fill="#FFD700"/>
                    <circle cx="14.5" cy="10" r="1.8" fill="#FFD700"/>
                    <rect x="10.5" y="14" width="3" height="4" rx="0.5" fill="#FFD700"/>
                </svg>`;
            }
            
            // Default - Generic plug icon
            return `<svg width="18" height="18" viewBox="0 0 24 24" style="${svgStyle}" fill="none">
                <rect x="5" y="3" width="14" height="18" rx="2" fill="#666" stroke="#444" stroke-width="1"/>
                <circle cx="9.5" cy="11" r="2" fill="#FFD700"/>
                <circle cx="14.5" cy="11" r="2" fill="#FFD700"/>
            </svg>`;
        }

        // API Configuration
        // Get your free API key from: https://www.weatherapi.com/signup.aspx
        const WEATHER_API_KEY = '5cbc52962baf424c9ec174311252310'; // Your WeatherAPI.com API key
        const WEATHER_API_URL = 'https://api.weatherapi.com/v1/forecast.json';

        // Async function to fetch country data for socket information
        async function fetchCountryData(destination) {
            try {
                // Try to extract country name from destination
                const countryQuery = destination.split(',').pop().trim();
                const response = await fetch(`https://restcountries.com/v3.1/name/${countryQuery}?fields=name,cca2,voltage,plugs`);
                
                if (!response.ok) {
                    throw new Error('Country not found');
                }
                
                const data = await response.json();
                if (data && data.length > 0) {
                    const country = data[0];
                    return {
                        countryCode: country.cca2,
                        voltage: country.voltage || 'Unknown',
                        plugTypes: country.plugs ? country.plugs.join('/') : 'Check local'
                    };
                }
            } catch (error) {
                console.log('Could not fetch country data:', error);
            }
            return null;
        }

        // Async function to fetch weather forecast
        async function fetchWeatherForecast(destination, startDate, endDate) {
            if (!WEATHER_API_KEY || WEATHER_API_KEY === 'YOUR_WEATHER_API_KEY_HERE') {
                console.log('Weather API key not configured. Using mock data.');
                return null;
            }

            try {
                const start = new Date(startDate);
                const end = new Date(endDate);
                const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                
                // WeatherAPI.com free tier allows up to 3 days forecast
                const forecastDays = Math.min(days, 3);
                
                const response = await fetch(
                    `${WEATHER_API_URL}?key=${WEATHER_API_KEY}&q=${encodeURIComponent(destination)}&days=${forecastDays}&aqi=no&alerts=no`
                );
                
                if (!response.ok) {
                    throw new Error('Weather fetch failed');
                }
                
                const data = await response.json();
                return data;
            } catch (error) {
                console.log('Could not fetch weather data:', error);
                return null;
            }
        }

        // Helper function to get weather icon emoji
        function getWeatherEmoji(condition) {
            // Safety check
            if (!condition) return '☀️';
            
            const text = condition.toLowerCase();
            if (text.includes('sun') || text.includes('clear')) return '☀️';
            if (text.includes('cloud')) return '☁️';
            if (text.includes('rain')) return '🌧️';
            if (text.includes('storm') || text.includes('thunder')) return '⛈️';
            if (text.includes('snow')) return '❄️';
            if (text.includes('fog') || text.includes('mist')) return '🌫️';
            if (text.includes('wind')) return '💨';
            return '🌤️';
        }

        // Helper function to format weather data
        function formatWeatherData(weatherData, dateStr) {
            if (!weatherData || !weatherData.forecast || !weatherData.forecast.forecastday) {
                return '☀️ 72°F';
            }

            const forecastDay = weatherData.forecast.forecastday.find(day => day.date === dateStr);
            if (!forecastDay) {
                // Use the last available forecast day as fallback
                const lastDay = weatherData.forecast.forecastday[weatherData.forecast.forecastday.length - 1];
                if (lastDay) {
                    const emoji = getWeatherEmoji(lastDay.day.condition.text);
                    const tempF = Math.round(lastDay.day.avgtemp_f);
                    const tempC = Math.round(lastDay.day.avgtemp_c);
                    return `${emoji} ${tempF}°F / ${tempC}°C`;
                }
                return '☀️ 72°F';
            }

            const emoji = getWeatherEmoji(forecastDay.day.condition.text);
            const tempF = Math.round(forecastDay.day.avgtemp_f);
            const tempC = Math.round(forecastDay.day.avgtemp_c);
            return `${emoji} ${tempF}°F / ${tempC}°C`;
        }

        // Autocomplete functionality
        let autocompleteTimer = null;
        let currentSuggestions = [];
        let selectedSuggestionIndex = -1;

        async function fetchCitySuggestions(query) {
            if (!query || query.length < 3) {
                return [];
            }

            try {
                const response = await fetch(
                    `https://api.weatherapi.com/v1/search.json?key=${WEATHER_API_KEY}&q=${encodeURIComponent(query)}`
                );
                
                if (!response.ok) {
                    throw new Error('Failed to fetch suggestions');
                }
                
                const data = await response.json();
                return data;
            } catch (error) {
                console.log('Could not fetch city suggestions:', error);
                return [];
            }
        }

        function handleDestinationInput(e) {
            const query = e.target.value.trim();
            
            // Clear previous timer
            if (autocompleteTimer) {
                clearTimeout(autocompleteTimer);
            }
            
            // Hide suggestions if query is too short
            if (query.length < 3) {
                hideAutocompleteSuggestions();
                return;
            }
            
            // Show loading state
            showAutocompleteSuggestions([{ loading: true }]);
            
            // Debounce API calls (wait 300ms after user stops typing)
            autocompleteTimer = setTimeout(async () => {
                const suggestions = await fetchCitySuggestions(query);
                currentSuggestions = suggestions;
                showAutocompleteSuggestions(suggestions);
            }, 300);
        }

        function handleDestinationFocus(e) {
            const query = e.target.value.trim();
            if (query.length >= 3 && currentSuggestions.length > 0) {
                showAutocompleteSuggestions(currentSuggestions);
            }
        }

        function handleDestinationKeydown(e) {
            const container = document.getElementById('autocompleteSuggestions');
            const items = container.querySelectorAll('.autocomplete-item');
            
            if (items.length === 0) return;
            
            // Arrow Down
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, items.length - 1);
                updateSelectedSuggestion(items);
            }
            // Arrow Up
            else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
                updateSelectedSuggestion(items);
            }
            // Enter
            else if (e.key === 'Enter' && selectedSuggestionIndex >= 0) {
                e.preventDefault();
                const selectedItem = items[selectedSuggestionIndex];
                selectCity(selectedItem.dataset.name, selectedItem.dataset.region, selectedItem.dataset.country);
            }
            // Escape
            else if (e.key === 'Escape') {
                hideAutocompleteSuggestions();
            }
        }

        function updateSelectedSuggestion(items) {
            items.forEach((item, index) => {
                if (index === selectedSuggestionIndex) {
                    item.style.background = '#f8f9fa';
                    item.scrollIntoView({ block: 'nearest' });
                } else {
                    item.style.background = '';
                }
            });
        }

        function showAutocompleteSuggestions(suggestions) {
            const container = document.getElementById('autocompleteSuggestions');
            
            // Reset selection index
            selectedSuggestionIndex = -1;
            
            if (!suggestions || suggestions.length === 0) {
                container.innerHTML = `
                    <div class="autocomplete-no-results">
                        ${currentLanguage === 'en' ? 'No cities found' : 'No se encontraron ciudades'}
                    </div>
                `;
                container.classList.add('active');
                return;
            }
            
            if (suggestions[0].loading) {
                container.innerHTML = `
                    <div class="autocomplete-loading">
                        ${currentLanguage === 'en' ? 'Searching...' : 'Buscando...'}
                    </div>
                `;
                container.classList.add('active');
                return;
            }
            
            // Clear previous content
            container.innerHTML = '';
            
            // Add each suggestion as a clickable element
            suggestions.forEach(city => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                item.innerHTML = `
                    <div class="autocomplete-item-icon">📍</div>
                    <div class="autocomplete-item-text">
                        <div class="autocomplete-item-name">${city.name}</div>
                        <div class="autocomplete-item-region">${city.region ? city.region + ', ' : ''}${city.country}</div>
                    </div>
                `;
                
                // Store city data as properties
                item.dataset.name = city.name;
                item.dataset.region = city.region || '';
                item.dataset.country = city.country;
                
                // Add click handler
                item.addEventListener('click', function() {
                    selectCity(this.dataset.name, this.dataset.region, this.dataset.country);
                });
                
                container.appendChild(item);
            });
            
            container.classList.add('active');
        }

        function hideAutocompleteSuggestions() {
            const container = document.getElementById('autocompleteSuggestions');
            container.classList.remove('active');
        }

        function selectCity(name, region, country) {
            // Don't include region if it's the same as the city name (e.g., Lima, Lima, Peru)
            const includeRegion = region && region !== name;
            const fullName = includeRegion ? `${name}, ${region}, ${country}` : `${name}, ${country}`;
            document.getElementById('destination').value = fullName;
            hideAutocompleteSuggestions();
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            updateLanguage();
            checkAuth();
            setupEventListeners();
            initializeEmojiPicker();
        });

        function setupEventListeners() {
            document.getElementById('loginBtn').addEventListener('click', login);
            document.getElementById('registerBtn').addEventListener('click', register);
            document.getElementById('logoutBtn').addEventListener('click', logout);
            document.getElementById('forgotPasswordLink').addEventListener('click', showResetPasswordScreen);
            document.getElementById('resetPasswordBtn').addEventListener('click', resetPassword);
            document.getElementById('backToLoginLink').addEventListener('click', showLoginScreen);
        }

        function checkAuth() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = savedUser;
                showMainApp();
            }
        }

        function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;

            if (!username || !password) {
                alert(currentLanguage === 'en' ? 'Please enter username and password' : 'Por favor ingrese usuario y contraseña');
                return;
            }

            const users = JSON.parse(localStorage.getItem('users') || '{}');
            
            if (users[username] && users[username].password === password) {
                currentUser = username;
                localStorage.setItem('currentUser', username);
                showMainApp();
            } else {
                alert(currentLanguage === 'en' ? 'Invalid credentials' : 'Credenciales inválidas');
            }
            
            // Clear the name field after login
            document.getElementById('name').value = '';
        }

        function register() {
            const name = document.getElementById('name').value.trim();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;

            if (!name || !username || !password) {
                alert(currentLanguage === 'en' ? 'Please enter name, username and password' : 'Por favor ingrese nombre, usuario y contraseña');
                return;
            }

            const users = JSON.parse(localStorage.getItem('users') || '{}');
            
            if (users[username]) {
                alert(currentLanguage === 'en' ? 'Username already exists' : 'El usuario ya existe');
                return;
            }

            users[username] = { name: name, password: password, trips: [] };
            localStorage.setItem('users', JSON.stringify(users));
            
            alert(currentLanguage === 'en' ? 'Registration successful! Please login.' : '¡Registro exitoso! Por favor inicie sesión.');
            
            // Clear form fields after successful registration
            document.getElementById('name').value = '';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            document.getElementById('authScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('name').value = '';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        function showResetPasswordScreen(e) {
            e.preventDefault();
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('resetPasswordScreen').classList.remove('hidden');
            
            // Clear form fields
            document.getElementById('resetUsername').value = '';
            document.getElementById('resetName').value = '';
            document.getElementById('newPassword').value = '';
        }

        function showLoginScreen(e) {
            e.preventDefault();
            document.getElementById('resetPasswordScreen').classList.add('hidden');
            document.getElementById('authScreen').classList.remove('hidden');
            
            // Clear form fields
            document.getElementById('resetUsername').value = '';
            document.getElementById('resetName').value = '';
            document.getElementById('newPassword').value = '';
        }

        function resetPassword() {
            const username = document.getElementById('resetUsername').value.trim();
            const name = document.getElementById('resetName').value.trim();
            const newPassword = document.getElementById('newPassword').value;

            if (!username || !name || !newPassword) {
                alert(currentLanguage === 'en' 
                    ? 'Please fill in all fields' 
                    : 'Por favor completa todos los campos');
                return;
            }

            const users = JSON.parse(localStorage.getItem('users') || '{}');
            
            // Check if user exists
            if (!users[username]) {
                alert(currentLanguage === 'en' 
                    ? 'Username not found' 
                    : 'Usuario no encontrado');
                return;
            }

            // Verify name matches
            if (users[username].name !== name) {
                alert(currentLanguage === 'en' 
                    ? 'Name does not match our records' 
                    : 'El nombre no coincide con nuestros registros');
                return;
            }

            // Update password
            users[username].password = newPassword;
            localStorage.setItem('users', JSON.stringify(users));
            
            alert(currentLanguage === 'en' 
                ? 'Password reset successful! You can now login with your new password.' 
                : '¡Contraseña restablecida exitosamente! Ahora puedes iniciar sesión con tu nueva contraseña.');
            
            // Go back to login screen
            showLoginScreen({ preventDefault: () => {} });
        }

        function showMainApp() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('currentUser').textContent = currentUser;
            
            // Get user's stored name
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            const userName = users[currentUser]?.name || currentUser;
            
            // Set profile pictures with user initials from name
            const initials = userName.substring(0, 2).toUpperCase();
            document.getElementById('sidebarProfilePic').textContent = initials;
            
            // Set first name in greeting
            const firstName = userName.split(' ')[0] || userName;
            document.getElementById('userFirstName').textContent = firstName;
            
            // Setup event listeners for main app elements (now that they're visible)
            setupMainAppEventListeners();
            
            initCalendar();
            loadTrips();
            loadSidebarTrips();
            checkApiSetup();
            initLanguageToggle();
        }

        function setupMainAppEventListeners() {
            // Setup create trip button (landing page)
            const createTripBtn = document.getElementById('createTripBtn');
            if (createTripBtn) {
                createTripBtn.onclick = createTrip;
            }
            
            // Setup trip name input (trip detail page)
            const tripNameInput = document.getElementById('tripName');
            if (tripNameInput) {
                tripNameInput.oninput = saveCurrentTrip;
            }
        }

        function checkApiSetup() {
            // Check if API banner has been dismissed
            const bannerDismissed = localStorage.getItem('apiBannerDismissed');
            const apiKeyConfigured = WEATHER_API_KEY && WEATHER_API_KEY !== 'YOUR_WEATHER_API_KEY_HERE';
            
            // Show banner if API key is not configured and banner wasn't dismissed
            if (!apiKeyConfigured && !bannerDismissed) {
                document.getElementById('apiBanner').style.display = 'flex';
            }
        }

        function closeApiBanner() {
            document.getElementById('apiBanner').style.display = 'none';
            localStorage.setItem('apiBannerDismissed', 'true');
        }

        function showNewTripForm() {
            showLandingPage();
            const tripForm = document.getElementById('tripForm');
            const ctaBtn = document.querySelector('.new-trip-cta-btn');
            if (tripForm) {
                tripForm.classList.remove('hidden');
                if (ctaBtn) {
                    ctaBtn.classList.add('active');
                }
                // Smooth scroll to form
                setTimeout(() => {
                    tripForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            }
        }

        function hideNewTripForm() {
            const tripForm = document.getElementById('tripForm');
            const ctaBtn = document.querySelector('.new-trip-cta-btn');
            if (tripForm) {
                tripForm.classList.add('hidden');
                if (ctaBtn) {
                    ctaBtn.classList.remove('active');
                }
            }
        }

        function toggleNewTripForm() {
            const tripForm = document.getElementById('tripForm');
            if (tripForm) {
                if (tripForm.classList.contains('hidden')) {
                    showNewTripForm();
                } else {
                    hideNewTripForm();
                }
            }
        }

        function loadSidebarTrips() {
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            const trips = users[currentUser]?.trips || [];
            
            // Get today as YYYY-MM-DD string for comparison
            const today = new Date();
            const todayStr = dateToString(today);

            // Load upcoming trips (trips that haven't ended yet)
            const upcomingContainer = document.getElementById('sidebarTripsList');
            upcomingContainer.innerHTML = '';
            
            // Compare date strings directly to avoid timezone issues
            const upcoming = trips.filter(t => t.endDate >= todayStr)
                .sort((a, b) => a.startDate.localeCompare(b.startDate))
                .slice(0, 4);

            upcoming.forEach(trip => {
                const duration = Math.ceil((new Date(trip.endDate) - new Date(trip.startDate)) / (1000 * 60 * 60 * 24)) + 1;
                // Parse date in local time to avoid timezone shift
                const [year, month, day] = trip.startDate.split('-').map(Number);
                const startDate = new Date(year, month - 1, day);
                const dateStr = `${duration} ${translations[currentLanguage].days}, ${startDate.getDate()} ${startDate.toLocaleDateString(currentLanguage === 'en' ? 'en-US' : 'es-ES', { month: 'short', year: 'numeric' })}`;
                
                const tripEmoji = trip.emoji || (trip.cities && trip.cities.length > 0 ? trip.cities[0].emoji : '🌍');
                const tripName = trip.name || trip.destination || 'Untitled Trip';
                
                const div = document.createElement('div');
                div.className = 'sidebar-trip-item';
                div.onclick = () => openTrip(trip.id);
                div.innerHTML = `
                    <div class="trip-flag">${tripEmoji}</div>
                    <div class="trip-info">
                        <h4>${tripName}</h4>
                        <p>${dateStr}</p>
                    </div>
                `;
                upcomingContainer.appendChild(div);
            });

            if (upcoming.length === 0) {
                upcomingContainer.innerHTML = `<p style="color: #999; font-size: 12px; padding: 10px;">${currentLanguage === 'en' ? 'No upcoming trips' : 'No hay viajes próximos'}</p>`;
            }

            // Load past trips (trips where the end date has passed)
            const pastContainer = document.getElementById('sidebarPastTripsList');
            pastContainer.innerHTML = '';
            
            // Compare date strings directly to avoid timezone issues
            const past = trips.filter(t => t.endDate < todayStr)
                .sort((a, b) => b.endDate.localeCompare(a.endDate))
                .slice(0, 4);

            past.forEach(trip => {
                // Parse date in local time to avoid timezone shift
                const [year, month, day] = trip.startDate.split('-').map(Number);
                const startDate = new Date(year, month - 1, day);
                const dateStr = startDate.toLocaleDateString(currentLanguage === 'en' ? 'en-US' : 'es-ES', { month: 'short', year: 'numeric' });
                
                const tripEmoji = trip.emoji || (trip.cities && trip.cities.length > 0 ? trip.cities[0].emoji : '🌍');
                const tripName = trip.name || trip.destination || 'Untitled Trip';
                
                const div = document.createElement('div');
                div.className = 'sidebar-trip-item';
                div.onclick = () => openTrip(trip.id);
                div.innerHTML = `
                    <div class="trip-flag" style="opacity: 0.5;">${tripEmoji}</div>
                    <div class="trip-info">
                        <h4>${tripName}</h4>
                        <p>${dateStr}</p>
                    </div>
                `;
                pastContainer.appendChild(div);
            });

            if (past.length === 0) {
                pastContainer.innerHTML = `<p style="color: #999; font-size: 12px; padding: 10px;">${currentLanguage === 'en' ? 'No past trips' : 'No hay viajes pasados'}</p>`;
            }
        }

        // Calendar Functions
        function initCalendar() {
            currentCalendarMonth = new Date();
            selectedStartDate = null;
            selectedEndDate = null;
            isSelectingRange = false;
            renderCalendar();
            renderWeekdays();
            updateDatePickerButton();
        }

        function openCalendar() {
            document.getElementById('dateRangePicker').classList.remove('hidden');
            document.getElementById('overlay').classList.remove('hidden');
            renderCalendar();
        }

        function closeCalendar() {
            document.getElementById('dateRangePicker').classList.add('hidden');
            document.getElementById('overlay').classList.add('hidden');
            updateDatePickerButton();
        }

        function updateDatePickerButton() {
            const button = document.getElementById('datePickerButton');
            const buttonText = document.getElementById('datePickerButtonText');
            
            if (!buttonText) return;

            if (selectedStartDate && selectedEndDate) {
                const duration = Math.ceil((new Date(selectedEndDate) - new Date(selectedStartDate)) / (1000 * 60 * 60 * 24)) + 1;
                buttonText.textContent = `${formatDate(selectedStartDate)} → ${formatDate(selectedEndDate)} (${duration} ${translations[currentLanguage].days})`;
                button.classList.add('has-dates');
            } else if (selectedStartDate) {
                buttonText.textContent = formatDate(selectedStartDate);
                button.classList.add('has-dates');
            } else {
                buttonText.textContent = translations[currentLanguage].clickToSelectDates;
                button.classList.remove('has-dates');
            }
        }

        function renderWeekdays() {
            const weekdays = currentLanguage === 'en' 
                ? ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']
                : ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
            
            const container = document.getElementById('calendarWeekdays');
            container.innerHTML = weekdays.map(day => 
                `<div class="calendar-weekday">${day}</div>`
            ).join('');
        }

        function renderCalendar() {
            const year = currentCalendarMonth.getFullYear();
            const month = currentCalendarMonth.getMonth();
            
            // Update month display
            const monthNames = currentLanguage === 'en'
                ? ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December']
                : ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            document.getElementById('calendarMonth').textContent = `${monthNames[month]} ${year}`;

            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const prevLastDay = new Date(year, month, 0);
            
            const firstDayOfWeek = firstDay.getDay();
            const daysInMonth = lastDay.getDate();
            const daysInPrevMonth = prevLastDay.getDate();

            const container = document.getElementById('calendarDays');
            container.innerHTML = '';

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Previous month's days
            for (let i = firstDayOfWeek - 1; i >= 0; i--) {
                const day = daysInPrevMonth - i;
                const date = new Date(year, month - 1, day);
                container.appendChild(createDayElement(day, date, true));
            }

            // Current month's days
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                container.appendChild(createDayElement(day, date, false));
            }

            // Next month's days to fill the grid
            const totalCells = container.children.length;
            const remainingCells = Math.ceil(totalCells / 7) * 7 - totalCells;
            for (let day = 1; day <= remainingCells; day++) {
                const date = new Date(year, month + 1, day);
                container.appendChild(createDayElement(day, date, true));
            }

            updateSelectedDatesDisplay();
        }

        function createDayElement(day, date, isOtherMonth) {
            const div = document.createElement('div');
            div.className = 'calendar-day';
            div.textContent = day;
            
            if (isOtherMonth) {
                div.classList.add('other-month');
            }

            // Check if it's today
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            if (date.getTime() === today.getTime()) {
                div.classList.add('today');
            }

            // Check if it's selected start or end
            const dateStr = dateToString(date);
            if (selectedStartDate && dateStr === selectedStartDate) {
                div.classList.add('selected-start');
            }
            if (selectedEndDate && dateStr === selectedEndDate) {
                div.classList.add('selected-end');
            }

            // Check if it's in range (compare date strings to avoid timezone issues)
            if (selectedStartDate && selectedEndDate) {
                if (dateStr > selectedStartDate && dateStr < selectedEndDate) {
                    div.classList.add('in-range');
                }
            }

            div.onclick = () => selectDate(dateStr);

            return div;
        }

        function selectDate(dateStr) {
            if (!selectedStartDate || (selectedStartDate && selectedEndDate)) {
                // Start a new selection
                selectedStartDate = dateStr;
                selectedEndDate = null;
                isSelectingRange = true;
            } else if (selectedStartDate && !selectedEndDate) {
                // Complete the selection
                // Compare dates as strings (YYYY-MM-DD format) to avoid timezone issues
                if (dateStr < selectedStartDate) {
                    // If selected date is before start date, swap them
                    selectedEndDate = selectedStartDate;
                    selectedStartDate = dateStr;
                } else {
                    selectedEndDate = dateStr;
                }
                isSelectingRange = false;
            }

            renderCalendar();
            updateDatePickerButton();
        }

        function updateSelectedDatesDisplay() {
            const textElement = document.getElementById('selectedDatesText');
            const rangeElement = document.getElementById('selectedDatesRange');

            if (!selectedStartDate) {
                textElement.textContent = translations[currentLanguage].selectDatesPrompt;
                rangeElement.textContent = '';
            } else if (selectedStartDate && !selectedEndDate) {
                textElement.textContent = currentLanguage === 'en' 
                    ? 'Select end date' 
                    : 'Seleccione fecha de fin';
                rangeElement.textContent = formatDate(selectedStartDate);
            } else if (selectedStartDate && selectedEndDate) {
                const duration = Math.ceil((new Date(selectedEndDate) - new Date(selectedStartDate)) / (1000 * 60 * 60 * 24)) + 1;
                textElement.textContent = currentLanguage === 'en' 
                    ? `${duration} days trip` 
                    : `Viaje de ${duration} días`;
                rangeElement.textContent = `${formatDate(selectedStartDate)} → ${formatDate(selectedEndDate)}`;
            }
        }

        function changeMonth(direction) {
            currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() + direction);
            renderCalendar();
        }

        function setLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('language', currentLanguage);
            updateLanguage();
            updateGreeting();
            
            // Update active state on toggle buttons
            document.querySelectorAll('.lang-option').forEach(btn => {
                if (btn.dataset.lang === lang) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // Re-render calendar with new language
            if (document.getElementById('calendarWeekdays')) {
                renderWeekdays();
                renderCalendar();
            }
            
            // Reload sidebar trips
            if (currentUser && document.getElementById('sidebarTripsList')) {
                loadSidebarTrips();
            }
            
            // Reload current view if in trip detail
            if (currentTrip) {
                renderTripDetail(currentTrip);
            } else if (document.getElementById('upcomingTrips')) {
                loadTrips();
            }
        }

        function toggleLanguage() {
            // Keep for backward compatibility
            const newLang = currentLanguage === 'en' ? 'es' : 'en';
            setLanguage(newLang);
        }

        function initLanguageToggle() {
            const langButtons = document.querySelectorAll('.lang-option');
            langButtons.forEach(btn => {
                if (btn.dataset.lang === currentLanguage) {
                    btn.classList.add('active');
                }
            });
        }

        function updateLanguage() {
            const t = translations[currentLanguage];
            
            // Update all text elements
            const elements = [
                'authTitle', 'nameLabel', 'usernameLabel', 'passwordLabel', 'loginBtn', 'registerBtn',
                'forgotPasswordLink', 'resetPasswordTitle', 'resetUsernameLabel', 'resetNameLabel', 
                'newPasswordLabel', 'resetPasswordBtn', 'backToLoginLink',
                'editTripText', 'deleteTripText', 'editTripModalTitle', 'editDestinationLabel', 
                'editDatesLabel', 'saveEditTripText', 'cancelEditTripText',
                'createTripTitle', 'tripNameLabel', 'tripEmojiLabel', 'destinationLabel',
                'dateRangeLabel', 'createTripBtn', 'upcomingTripsTitle',
                'pastTripsTitle', 'backBtnText', 'startLabel', 'endLabel', 'durationLabel',
                'socketLabel', 'activitiesTitle', 'addActivityText', 'essentialsTitle',
                'toiletriesTitle', 'addItemText1', 'addItemText2', 'addItemText3',
                'addListBtnText',
                'citiesTitle', 'addCityText', 'noCitiesText', 'addCityModalTitle',
                'cityDestinationLabel', 'cityDatesLabel', 'saveCityText', 'cancelCityText',
                'citySelectedDatesText',
                'outfitPlannerTitle', 'calendarDoneBtn', 'subheadingText', 'viewDetailsLink',
                'notesTitle', 'deleteTripText', 'apiBannerTitle',
                'upcomingTripsSidebarTitle', 'pastTripsSidebarTitle', 'newTripCtaText',
                'langBtnText', 'logoutBtnText', 'itineraryTabLabel', 'packingTabLabel',
                'activityTypeText', 'transportTypeText', 'activityNameLabel', 'activityStartTimeLabel',
                'activityEndTimeLabel', 'transportTypeLabel', 'transportStartTimeLabel', 'transportEndTimeLabel',
                'transportNameLabel', 'transportFromLabel', 'transportToLabel', 'transportCostLabel',
                'saveItineraryText', 'cancelItineraryText'
            ];

            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element && t[id]) {
                    if (element.tagName === 'INPUT' || element.tagName === 'BUTTON') {
                        if (element.hasAttribute('placeholder')) {
                            element.placeholder = t[id];
                        } else {
                            element.textContent = t[id];
                        }
                    } else {
                        element.textContent = t[id];
                    }
                }
            });

            // Update API banner text (contains HTML link)
            const apiBannerText = document.getElementById('apiBannerText');
            if (apiBannerText) {
                const linkHtml = '<a href="https://www.weatherapi.com/signup.aspx" target="_blank" class="api-banner-link">WeatherAPI.com</a>';
                if (currentLanguage === 'en') {
                    apiBannerText.innerHTML = `Get a free API key from ${linkHtml} and add it to line 1731 of the code to see real weather forecasts for your trips!`;
                } else {
                    apiBannerText.innerHTML = `Obtenga una clave API gratuita de ${linkHtml} y agréguela en la línea 1731 del código para ver pronósticos meteorológicos reales para sus viajes!`;
                }
            }

            // Update placeholders
            const nameInput = document.getElementById('name');
            if (nameInput) {
                nameInput.placeholder = t.namePlaceholder;
            }
            
            const usernameInput = document.getElementById('username');
            if (usernameInput) {
                usernameInput.placeholder = t.usernamePlaceholder;
            }
            
            const passwordInput = document.getElementById('password');
            if (passwordInput) {
                passwordInput.placeholder = t.passwordPlaceholder;
            }
            
            // Reset password form placeholders
            const resetUsernameInput = document.getElementById('resetUsername');
            if (resetUsernameInput) {
                resetUsernameInput.placeholder = t.usernamePlaceholder;
            }
            
            const resetNameInput = document.getElementById('resetName');
            if (resetNameInput) {
                resetNameInput.placeholder = t.namePlaceholder;
            }
            
            const newPasswordInput = document.getElementById('newPassword');
            if (newPasswordInput) {
                newPasswordInput.placeholder = currentLanguage === 'en' ? 'Enter new password' : 'Ingresa nueva contraseña';
            }
            
            const tripNameInput = document.getElementById('tripNameInput');
            if (tripNameInput) {
                tripNameInput.placeholder = currentLanguage === 'en' ? 'e.g., Europe Summer 2025' : 'ej., Verano Europeo 2025';
            }
            
            const cityDestInput = document.getElementById('cityDestination');
            if (cityDestInput) {
                cityDestInput.placeholder = currentLanguage === 'en' ? 'e.g., Paris, France' : 'ej., París, Francia';
            }

            // Update date picker button
            updateDatePickerButton();

            // Update calendar texts
            const selectedDatesText = document.getElementById('selectedDatesText');
            if (selectedDatesText && !selectedStartDate) {
                selectedDatesText.textContent = translations[currentLanguage].selectDatesPrompt;
            }
        }

        function createTrip() {
            // Prevent multiple clicks
            const createBtn = document.getElementById('createTripBtn');
            if (createBtn.disabled) return;
            createBtn.disabled = true;
            
            const tripNameInput = document.getElementById('tripNameInput');
            const tripName = tripNameInput ? tripNameInput.value.trim() : '';
            const startDate = selectedStartDate;
            const endDate = selectedEndDate;

            if (!tripName) {
                alert(currentLanguage === 'en' ? 'Please enter a trip name' : 'Por favor ingrese un nombre para el viaje');
                createBtn.disabled = false;
                return;
            }

            if (!startDate || !endDate) {
                alert(currentLanguage === 'en' ? 'Please select start and end dates' : 'Por favor seleccione fechas de inicio y fin');
                createBtn.disabled = false;
                return;
            }

            const users = JSON.parse(localStorage.getItem('users') || '{}');
            const trip = {
                id: Date.now(),
                name: tripName,
                emoji: tripCreationEmoji,
                startDate: startDate,
                endDate: endDate,
                cities: [],
                notes: '',
                activities: [],
                transport: [],
                checklists: {
                    essentials: getDefaultEssentials(),
                    toiletries: getDefaultToiletries(),
                    custom: [],
                    customName: currentLanguage === 'en' ? 'Custom Items' : 'Artículos Personalizados'
                },
                outfits: {}
            };

            users[currentUser].trips.push(trip);
            localStorage.setItem('users', JSON.stringify(users));

            // Clear form
            tripNameInput.value = '';
            tripCreationEmoji = '🌍'; // Reset to default emoji
            document.getElementById('selectedTripEmoji').textContent = '🌍';
            selectedStartDate = null;
            selectedEndDate = null;
            renderCalendar();
            updateDatePickerButton();

            // Update sidebar
            loadSidebarTrips();

            // Open the trip
            openTrip(trip.id);
            
            // Re-enable button
            createBtn.disabled = false;
        }

        function getSocketType(destination) {
            if (!destination) {
                return 'Type C';
            }
            
            const dest = destination.toLowerCase();
            
            // North America - Type A/B (110V)
            if (dest.includes('usa') || dest.includes('united states') || dest.includes('america') || 
                dest.includes('canada') || dest.includes('mexico') || dest.includes('bahamas') ||
                dest.includes('barbados') || dest.includes('jamaica') || dest.includes('costa rica') ||
                dest.includes('panama')) {
                return 'Type A/B';
            }
            
            // UK & Ireland - Type G (230V)
            if (dest.includes('uk') || dest.includes('united kingdom') || dest.includes('england') || 
                dest.includes('london') || dest.includes('scotland') || dest.includes('wales') ||
                dest.includes('ireland') || dest.includes('dublin') || dest.includes('belfast') ||
                dest.includes('manchester') || dest.includes('edinburgh')) {
                return 'Type G';
            }
            
            // Europe (Continental) - Type C/F (230V)
            if (dest.includes('spain') || dest.includes('france') || dest.includes('germany') || 
                dest.includes('italy') || dest.includes('portugal') || dest.includes('netherlands') || 
                dest.includes('belgium') || dest.includes('greece') || dest.includes('austria') || 
                dest.includes('switzerland') || dest.includes('poland') || dest.includes('czech') ||
                dest.includes('sweden') || dest.includes('norway') || dest.includes('denmark') || 
                dest.includes('finland') || dest.includes('hungary') || dest.includes('croatia') ||
                dest.includes('romania') || dest.includes('iceland') || dest.includes('luxembourg') ||
                dest.includes('monaco') || dest.includes('paris') || dest.includes('madrid') ||
                dest.includes('rome') || dest.includes('berlin') || dest.includes('amsterdam') ||
                dest.includes('barcelona') || dest.includes('lisbon') || dest.includes('vienna') ||
                dest.includes('prague') || dest.includes('budapest') || dest.includes('europe')) {
                return 'Type C/F';
            }
            
            // South America - Type C/I (220V)
            if (dest.includes('brazil') || dest.includes('argentina') || dest.includes('chile') || 
                dest.includes('peru') || dest.includes('colombia') || dest.includes('ecuador') || 
                dest.includes('bolivia') || dest.includes('uruguay') || dest.includes('venezuela') ||
                dest.includes('paraguay') || dest.includes('guyana') || dest.includes('suriname') ||
                dest.includes('buenos aires') || dest.includes('sao paulo') || dest.includes('rio') ||
                dest.includes('bogota') || dest.includes('lima') || dest.includes('santiago') ||
                dest.includes('quito') || dest.includes('montevideo') || dest.includes('caracas')) {
                return 'Type C/I';
            }
            
            // Australia & New Zealand - Type I (230V)
            if (dest.includes('australia') || dest.includes('sydney') || dest.includes('melbourne') || 
                dest.includes('brisbane') || dest.includes('perth') || dest.includes('adelaide') ||
                dest.includes('new zealand') || dest.includes('auckland') || dest.includes('wellington')) {
                return 'Type I';
            }
            
            // China - Type A/I (220V)
            if (dest.includes('china') || dest.includes('beijing') || dest.includes('shanghai') ||
                dest.includes('hong kong') || dest.includes('guangzhou') || dest.includes('shenzhen')) {
                return 'Type A/I';
            }
            
            // Japan - Type A/B (100V)
            if (dest.includes('japan') || dest.includes('tokyo') || dest.includes('osaka') ||
                dest.includes('kyoto') || dest.includes('hiroshima') || dest.includes('nagoya')) {
                return 'Type A/B';
            }
            
            // India - Type D/M (230V)
            if (dest.includes('india') || dest.includes('delhi') || dest.includes('mumbai') ||
                dest.includes('bangalore') || dest.includes('calcutta') || dest.includes('chennai') ||
                dest.includes('hyderabad') || dest.includes('pune')) {
                return 'Type D/M';
            }
            
            // Southeast Asia - Type A/C (220V)
            if (dest.includes('thailand') || dest.includes('bangkok') || dest.includes('vietnam') || 
                dest.includes('hanoi') || dest.includes('ho chi minh') || dest.includes('singapore') || 
                dest.includes('malaysia') || dest.includes('kuala lumpur') || dest.includes('indonesia') ||
                dest.includes('bali') || dest.includes('jakarta') || dest.includes('philippines') ||
                dest.includes('manila')) {
                return 'Type A/C';
            }
            
            // South Korea - Type C/F (220V)
            if (dest.includes('korea') || dest.includes('seoul') || dest.includes('busan')) {
                return 'Type C/F';
            }
            
            // Middle East - Type C/D/G (220V)
            if (dest.includes('dubai') || dest.includes('uae') || dest.includes('emirates') ||
                dest.includes('qatar') || dest.includes('doha') || dest.includes('saudi') ||
                dest.includes('riyadh') || dest.includes('jeddah') || dest.includes('kuwait') ||
                dest.includes('bahrain') || dest.includes('oman')) {
                return 'Type C/G';
            }
            
            // Turkey - Type C/F (230V)
            if (dest.includes('turkey') || dest.includes('istanbul') || dest.includes('ankara')) {
                return 'Type C/F';
            }
            
            // South Africa - Type M (230V)
            if (dest.includes('south africa') || dest.includes('cape town') || 
                dest.includes('johannesburg') || dest.includes('durban')) {
                return 'Type M';
            }
            
            // Israel - Type C/H (230V)
            if (dest.includes('israel') || dest.includes('tel aviv') || dest.includes('jerusalem')) {
                return 'Type C/H';
            }
            
            // Default to most common European standard
            return 'Type C/F';
        }

        function getDefaultEssentials() {
            return [
                { text: 'Passport', checked: false },
                { text: 'Phone charger', checked: false },
                { text: 'Laptop charger', checked: false },
                { text: 'Travel adapter', checked: false },
                { text: 'Sunglasses', checked: false },
                { text: 'Wallet', checked: false },
                { text: 'Keys', checked: false },
                { text: 'Headphones', checked: false }
            ];
        }

        function getDefaultToiletries() {
            return [
                { text: 'Toothbrush', checked: false },
                { text: 'Toothpaste', checked: false },
                { text: 'Shampoo', checked: false },
                { text: 'Soap', checked: false },
                { text: 'Deodorant', checked: false },
                { text: 'Sunscreen', checked: false },
                { text: 'Medicine', checked: false },
                { text: 'First aid kit', checked: false }
            ];
        }

        function updateGreeting() {
            const hour = new Date().getHours();
            const greetingElement = document.getElementById('greetingText');
            
            if (!greetingElement) return;
            
            let greeting;
            if (currentLanguage === 'en') {
                if (hour >= 5 && hour < 12) {
                    greeting = 'Good Morning';
                } else if (hour >= 12 && hour < 18) {
                    greeting = 'Good Afternoon';
                } else {
                    greeting = 'Good Evening';
                }
            } else {
                if (hour >= 5 && hour < 12) {
                    greeting = 'Buenos Días';
                } else if (hour >= 12 && hour < 18) {
                    greeting = 'Buenas Tardes';
                } else {
                    greeting = 'Buenas Noches';
                }
            }
            
            greetingElement.textContent = greeting;
        }

        function loadTrips() {
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            const trips = users[currentUser]?.trips || [];

            // Get today as YYYY-MM-DD string for comparison
            const today = new Date();
            const todayStr = dateToString(today);

            // Update greeting based on time of day
            updateGreeting();

            // Upcoming trips: trips that haven't ended yet (endDate >= today)
            // Compare date strings directly to avoid timezone issues
            const upcoming = trips.filter(t => t.endDate >= todayStr)
                .sort((a, b) => a.startDate.localeCompare(b.startDate));
            
            // Past trips: trips where the end date has passed (endDate < today)
            const past = trips.filter(t => t.endDate < todayStr)
                .sort((a, b) => b.endDate.localeCompare(a.endDate));

            renderUpcomingTrips(upcoming);
            renderPastTrips(past);
        }

        function renderUpcomingTrips(trips) {
            const container = document.getElementById('upcomingTrips');
            container.innerHTML = '';

            // Get today's date as YYYY-MM-DD string
            const today = new Date();
            const todayStr = dateToString(today);

            trips.forEach(trip => {
                const duration = Math.ceil((new Date(trip.endDate) - new Date(trip.startDate)) / (1000 * 60 * 60 * 24)) + 1;
                // Parse dates in local time to avoid timezone shift
                const [startYear, startMonth, startDay] = trip.startDate.split('-').map(Number);
                const [endYear, endMonth, endDay] = trip.endDate.split('-').map(Number);
                const startDate = new Date(startYear, startMonth - 1, startDay);
                const endDate = new Date(endYear, endMonth - 1, endDay);
                
                // Calculate days until trip starts
                const todayDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                const daysUntilTrip = Math.ceil((startDate - todayDate) / (1000 * 60 * 60 * 24));
                
                // Format dates
                const startFormatted = startDate.toLocaleDateString(currentLanguage === 'en' ? 'en-US' : 'es-ES', { month: 'short', day: 'numeric' });
                const endFormatted = endDate.toLocaleDateString(currentLanguage === 'en' ? 'en-US' : 'es-ES', { month: 'short', day: 'numeric' });
                
                // Updated date
                const updatedDate = new Date(trip.id).toLocaleDateString(currentLanguage === 'en' ? 'en-US' : 'es-ES', { month: 'numeric', day: 'numeric', year: 'numeric' });
                
                // Get emoji for icon (use saved emoji or generate from destination)
                const tripEmoji = trip.emoji || (trip.cities && trip.cities.length > 0 ? trip.cities[0].emoji : '🌍');
                const tripDestination = trip.destination || (trip.cities && trip.cities.length > 0 ? trip.cities.map(c => c.name).join(', ') : '');
                const tripSocketInfo = trip.socketType ? `<p class="trip-card-socket">${trip.socketIcon || getSocketSVG(trip.socketType)}${trip.socketType}</p>` : '';
                
                // Create countdown badge HTML if trip is in the future
                let countdownBadge = '';
                if (daysUntilTrip > 0) {
                    countdownBadge = `<div class="trip-countdown-badge">${currentLanguage === 'en' ? `In ${daysUntilTrip} ${daysUntilTrip === 1 ? 'day' : 'days'}` : `En ${daysUntilTrip} ${daysUntilTrip === 1 ? 'día' : 'días'}`}</div>`;
                } else if (daysUntilTrip === 0) {
                    countdownBadge = `<div class="trip-countdown-badge">${currentLanguage === 'en' ? 'Today!' : '¡Hoy!'}</div>`;
                }
                
                const card = document.createElement('div');
                card.className = 'trip-card';
                card.onclick = () => openTrip(trip.id);
                card.innerHTML = `
                    <div class="trip-card-header">
                        <div class="trip-card-icon">${tripEmoji}</div>
                        <div class="trip-card-main">
                            <h3>${trip.name}</h3>
                            ${tripDestination ? `<p class="trip-card-subtitle">${tripDestination}</p>` : ''}
                            <p class="trip-card-dates">${startFormatted} - ${endFormatted} · ${duration} ${translations[currentLanguage].days} · ${currentLanguage === 'en' ? 'Updated' : 'Actualizado'} ${updatedDate}</p>
                            ${tripSocketInfo}
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: flex-end;">
                            ${countdownBadge}
                            <div class="trip-duration-badge-card">${duration} ${translations[currentLanguage].days}</div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });

            if (trips.length === 0) {
                container.innerHTML = `<p style="color: #999; text-align: center; width: 100%;">${currentLanguage === 'en' ? 'No upcoming trips' : 'No hay viajes próximos'}</p>`;
            }
        }

        function renderPastTrips(trips) {
            const container = document.getElementById('pastTrips');
            container.innerHTML = '';

            trips.forEach(trip => {
                const duration = Math.ceil((new Date(trip.endDate) - new Date(trip.startDate)) / (1000 * 60 * 60 * 24)) + 1;
                // Parse dates in local time to avoid timezone shift
                const [startYear, startMonth, startDay] = trip.startDate.split('-').map(Number);
                const [endYear, endMonth, endDay] = trip.endDate.split('-').map(Number);
                const startDate = new Date(startYear, startMonth - 1, startDay);
                const endDate = new Date(endYear, endMonth - 1, endDay);
                
                // Format dates
                const startFormatted = startDate.toLocaleDateString(currentLanguage === 'en' ? 'en-US' : 'es-ES', { month: 'short', day: 'numeric' });
                const endFormatted = endDate.toLocaleDateString(currentLanguage === 'en' ? 'en-US' : 'es-ES', { month: 'short', day: 'numeric' });
                
                // Get emoji for icon (use saved emoji or generate from destination)
                const tripEmoji = trip.emoji || (trip.cities && trip.cities.length > 0 ? trip.cities[0].emoji : '🌍');
                const tripDestination = trip.destination || (trip.cities && trip.cities.length > 0 ? trip.cities.map(c => c.name).join(', ') : '');
                const subtitleText = tripDestination ? `${tripDestination} · ${startFormatted} - ${endFormatted}` : `${startFormatted} - ${endFormatted}`;
                
                const card = document.createElement('div');
                card.className = 'trip-card';
                card.onclick = () => openTrip(trip.id);
                card.innerHTML = `
                    <div class="trip-card-header">
                        <div class="trip-card-icon">${tripEmoji}</div>
                        <div class="trip-card-main">
                            <h3>${trip.name}</h3>
                            <p class="trip-card-subtitle">${subtitleText}</p>
                        </div>
                        <div class="trip-duration-badge-card">${duration} ${translations[currentLanguage].days}</div>
                    </div>
                `;
                container.appendChild(card);
            });

            if (trips.length === 0) {
                container.innerHTML = `<p style="color: #999; text-align: center; width: 100%;">${currentLanguage === 'en' ? 'No past trips' : 'No hay viajes pasados'}</p>`;
            }
        }

        function formatDate(dateString) {
            // Parse YYYY-MM-DD as local date, not UTC (to avoid timezone shift)
            const [year, month, day] = dateString.split('-').map(Number);
            const date = new Date(year, month - 1, day);
            return date.toLocaleDateString(currentLanguage === 'en' ? 'en-US' : 'es-ES', { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric' 
            });
        }

        // Helper function to convert Date object to YYYY-MM-DD without timezone issues
        function dateToString(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function openTrip(tripId) {
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            const trip = users[currentUser].trips.find(t => t.id === tripId);
            
            if (trip) {
                currentTrip = trip;
                renderTripDetail(trip);
                document.getElementById('landingPage').classList.add('hidden');
                document.getElementById('tripDetailPage').classList.remove('hidden');
            }
        }

        function showLandingPage() {
            currentTrip = null;
            document.getElementById('tripDetailPage').classList.add('hidden');
            document.getElementById('landingPage').classList.remove('hidden');
            selectedStartDate = null;
            selectedEndDate = null;
            renderCalendar();
            updateDatePickerButton();
            loadTrips();
            loadSidebarTrips(); // Update sidebar when returning to landing page
        }

        function renderTripDetail(trip) {
            // Ensure required arrays exist
            if (!trip.cities) trip.cities = [];
            if (!trip.activities) trip.activities = [];
            
            const duration = Math.ceil((new Date(trip.endDate) - new Date(trip.startDate)) / (1000 * 60 * 60 * 24)) + 1;

            // Set trip icon (emoji) - prefer trip.emoji, then first city's emoji, then default
            const tripEmoji = trip.emoji || (trip.cities.length > 0 ? trip.cities[0].emoji : '🌍');
            const tripIconEl = document.getElementById('tripIcon');
            tripIconEl.textContent = tripEmoji;
            tripIconEl.style.cursor = 'pointer';
            tripIconEl.title = currentLanguage === 'en' ? 'Click to change emoji' : 'Clic para cambiar emoji';
            tripIconEl.onclick = () => changeEmoji();

            // Set trip name
            document.getElementById('tripName').value = trip.name;

            // Set duration badge
            document.getElementById('tripDurationBadge').textContent = `${duration} ${duration === 1 ? (currentLanguage === 'en' ? 'day' : 'día') : translations[currentLanguage].days}`;

            // Calculate days until trip starts and add countdown badge if needed
            const today = new Date();
            const todayDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            const [startYear, startMonth, startDay] = trip.startDate.split('-').map(Number);
            const tripStartDate = new Date(startYear, startMonth - 1, startDay);
            const daysUntilTrip = Math.ceil((tripStartDate - todayDate) / (1000 * 60 * 60 * 24));
            
            // Remove existing countdown badge if any
            const existingCountdown = document.getElementById('tripCountdownBadge');
            if (existingCountdown) {
                existingCountdown.remove();
            }
            
            // Add countdown badge if trip hasn't started yet
            if (daysUntilTrip >= 0) {
                const countdownBadge = document.createElement('div');
                countdownBadge.id = 'tripCountdownBadge';
                countdownBadge.className = 'trip-countdown-badge';
                
                if (daysUntilTrip > 0) {
                    countdownBadge.textContent = currentLanguage === 'en' 
                        ? `In ${daysUntilTrip} ${daysUntilTrip === 1 ? 'day' : 'days'}`
                        : `En ${daysUntilTrip} ${daysUntilTrip === 1 ? 'día' : 'días'}`;
                } else if (daysUntilTrip === 0) {
                    countdownBadge.textContent = currentLanguage === 'en' ? 'Today!' : '¡Hoy!';
                }
                
                const durationBadge = document.getElementById('tripDurationBadge');
                durationBadge.parentNode.insertBefore(countdownBadge, durationBadge);
            }

            // Set socket info - collect all unique socket types from all cities
            const socketInfo = document.getElementById('tripSocketInline');
            if (trip.cities.length > 0) {
                // Get unique socket types from all cities
                const uniqueSockets = new Map();
                trip.cities.forEach(city => {
                    if (city.socketType && !uniqueSockets.has(city.socketType)) {
                        uniqueSockets.set(city.socketType, city.socketIcon);
                    }
                });
                
                if (uniqueSockets.size > 0) {
                    // Create HTML for all unique socket types
                    const socketElements = Array.from(uniqueSockets.entries())
                        .map(([type, icon]) => `${icon}${type}`)
                        .join(' • ');
                    
                    socketInfo.innerHTML = socketElements;
                    socketInfo.style.display = 'inline-flex';
                } else {
                    socketInfo.style.display = 'none';
                }
            } else {
                socketInfo.style.display = 'none';
            }

            // Set subtitle with dates and duration
            const startDate = formatDate(trip.startDate);
            const endDate = formatDate(trip.endDate);
            // Parse dates in local time to avoid timezone shift
            const [endYear, endMonth, endDay] = trip.endDate.split('-').map(Number);
            const monthStart = new Date(startYear, startMonth - 1, startDay).toLocaleDateString(currentLanguage === 'en' ? 'en-US' : 'es-ES', { month: 'short', day: 'numeric' });
            const monthEnd = new Date(endYear, endMonth - 1, endDay).toLocaleDateString(currentLanguage === 'en' ? 'en-US' : 'es-ES', { month: 'short', day: 'numeric' });
            
            // Show cities count in subtitle
            const citiesText = trip.cities.length > 0 
                ? ` • ${trip.cities.length} ${trip.cities.length === 1 ? (currentLanguage === 'en' ? 'city' : 'ciudad') : (currentLanguage === 'en' ? 'cities' : 'ciudades')}`
                : '';
            document.getElementById('tripSubtitleInline').textContent = `${monthStart} – ${monthEnd} • ${duration} ${translations[currentLanguage].days}${citiesText}`;

            // Set notes
            document.getElementById('tripNotes').value = trip.notes || '';

            renderCities();
            renderActivities(trip);
            renderChecklists(trip);
            renderOutfitPlanner(trip);
            renderItineraryTimeline(trip);
        }

        function renderActivities(trip) {
            // Ensure activities array exists
            if (!trip.activities) {
                trip.activities = [];
            }
            
            // Ensure all activities have IDs (migration for old data)
            trip.activities.forEach(activity => {
                if (!activity.id) {
                    activity.id = Date.now() + Math.random();
                }
            });
            
            const container = document.getElementById('activitiesList');
            const noActivitiesMsg = document.getElementById('noActivitiesText');
            
            if (trip.activities.length === 0) {
                container.innerHTML = `<p class="no-activities" id="noActivitiesText">${currentLanguage === 'en' ? 'No activities yet.' : 'No hay actividades aún.'}</p>`;
                return;
            }

            container.innerHTML = '';

            trip.activities.forEach((activity, index) => {
                const div = document.createElement('div');
                
                // Ensure activity has all required fields
                if (!activity.date) activity.date = trip.startDate;
                if (!activity.type) activity.type = 'day';
                if (!activity.emoji) activity.emoji = '🎯';
                if (!activity.name) activity.name = '';
                if (activity.isEditing === undefined) activity.isEditing = false;
                
                // Format date for display (parse as local time to avoid timezone shift)
                let dateDisplay = '';
                if (activity.date) {
                    const [year, month, day] = activity.date.split('-').map(Number);
                    const date = new Date(year, month - 1, day);
                    dateDisplay = date.toLocaleDateString(currentLanguage === 'en' ? 'en-US' : 'es-ES', { 
                        month: 'short', 
                        day: 'numeric', 
                        year: 'numeric' 
                    });
                }
                
                const typeIcon = activity.type === 'day' ? '☀️' : '🌙';
                const typeText = activity.type === 'day' ? translations[currentLanguage].dayActivity : translations[currentLanguage].nightActivity;
                
                if (activity.isEditing) {
                    // Edit Mode
                    div.className = 'activity-item';
                    div.innerHTML = `
                        <div class="activity-emoji" onclick="openActivityEmojiPicker(${index})">${activity.emoji}</div>
                        <input type="text" 
                               id="activityDate${index}"
                               value="${dateDisplay}" 
                               readonly
                               onclick="openActivityDatePicker(${index})"
                               placeholder="${currentLanguage === 'en' ? 'Select date' : 'Seleccionar fecha'}"
                               style="cursor: pointer;">
                        <input type="text" value="${activity.name}" placeholder="${currentLanguage === 'en' ? 'Activity name' : 'Nombre de actividad'}" oninput="updateActivity(${index}, 'name', this.value)">
                        <div class="activity-type-toggle">
                            <div class="activity-type-option ${activity.type === 'day' ? 'active' : ''}" onclick="updateActivity(${index}, 'type', 'day')">
                                ☀️ ${translations[currentLanguage].dayActivity}
                            </div>
                            <div class="activity-type-option ${activity.type === 'night' ? 'active' : ''}" onclick="updateActivity(${index}, 'type', 'night')">
                                🌙 ${translations[currentLanguage].nightActivity}
                            </div>
                        </div>
                        <div class="activity-actions">
                            <button class="save-btn" onclick="saveActivity(${index})" ${!activity.name ? 'disabled' : ''}>
                                ${currentLanguage === 'en' ? '✓ Save' : '✓ Guardar'}
                            </button>
                            <button class="delete-btn" onclick="deleteActivity(${index})">✕</button>
                        </div>
                    `;
                } else {
                    // Saved/View Mode
                    div.className = 'activity-item saved';
                    div.innerHTML = `
                        <div class="activity-saved-content">
                            <div class="activity-saved-emoji">${activity.emoji}</div>
                            <div class="activity-saved-details">
                                <div class="activity-saved-name">${activity.name}</div>
                                <div class="activity-saved-meta">
                                    <div class="activity-saved-date">
                                        📅 ${dateDisplay}
                                    </div>
                                    <div class="activity-saved-type">
                                        ${typeIcon} ${typeText}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="activity-actions">
                            <button class="edit-btn" onclick="editActivity(${index})">
                                ${currentLanguage === 'en' ? '✎ Edit' : '✎ Editar'}
                            </button>
                            <button class="delete-btn" onclick="deleteActivity(${index})">✕</button>
                        </div>
                    `;
                }
                
                container.appendChild(div);
            });
        }

        function addActivity() {
            if (!currentTrip) return;
            
            // Ensure activities array exists
            if (!currentTrip.activities) {
                currentTrip.activities = [];
            }

            currentTrip.activities.push({
                id: Date.now(),
                name: '',
                date: currentTrip.startDate,
                startTime: null,
                endTime: null,
                type: 'day',
                emoji: '🎯',
                isEditing: true
            });

            saveCurrentTrip();
            renderActivities(currentTrip);
            renderOutfitPlanner(currentTrip);
        }

        function updateActivity(index, field, value) {
            if (!currentTrip) return;
            
            // Ensure activities array exists
            if (!currentTrip.activities) {
                currentTrip.activities = [];
            }
            
            // Ensure the activity at this index exists
            if (!currentTrip.activities[index]) return;
            
            // Validate and format date properly
            if (field === 'date' && value) {
                // Ensure date is in YYYY-MM-DD format
                const date = new Date(value);
                if (!isNaN(date.getTime())) {
                    currentTrip.activities[index][field] = value;
                } else {
                    console.error('Invalid date:', value);
                    return;
                }
            } else {
                currentTrip.activities[index][field] = value;
            }
            
            saveCurrentTrip();
            
            // Re-render activities only if type changed to update toggle visual state
            // DON'T re-render for name changes to prevent losing focus while typing
            if (field === 'type') {
                renderActivities(currentTrip);
            }
            
            // Update outfit planner for date and type changes
            if (field === 'date' || field === 'type') {
                renderOutfitPlanner(currentTrip);
            }
        }

        function saveActivity(index) {
            if (!currentTrip) return;
            const activity = currentTrip.activities[index];
            
            // Validate that activity has a name
            if (!activity.name || activity.name.trim() === '') {
                alert(currentLanguage === 'en' ? 'Please enter an activity name' : 'Por favor ingrese un nombre de actividad');
                return;
            }
            
            // Set editing to false to save the activity
            activity.isEditing = false;
            saveCurrentTrip();
            renderActivities(currentTrip);
            renderOutfitPlanner(currentTrip); // Update outfit planner to show the saved activity
        }

        function editActivity(index) {
            if (!currentTrip) return;
            
            // Set editing to true to edit the activity
            currentTrip.activities[index].isEditing = true;
            saveCurrentTrip();
            renderActivities(currentTrip);
            renderOutfitPlanner(currentTrip); // Update outfit planner to hide the activity being edited
        }

        function deleteActivity(index) {
            if (!currentTrip) return;
            
            const confirmMsg = currentLanguage === 'en' 
                ? 'Are you sure you want to delete this activity?' 
                : '¿Estás seguro de que quieres eliminar esta actividad?';
            
            if (!confirm(confirmMsg)) return;
            
            currentTrip.activities.splice(index, 1);
            saveCurrentTrip();
            renderActivities(currentTrip);
            renderOutfitPlanner(currentTrip);
        }

        // Activity Emoji Picker Functions
        function openActivityEmojiPicker(activityIndex) {
            selectedActivityIndex = activityIndex;
            emojiPickerContext = 'activity'; // Set context to activity
            
            // Ensure emojis are initialized
            if (allEmojis.length === 0) {
                allEmojis = Object.values(emojiData).flat();
            }
            
            // Initialize the modern emoji picker with all emojis
            filterEmojiCategory('all');
            
            // Show the modern emoji picker modal
            document.getElementById('emojiPickerModal').classList.remove('hidden');
        }

        function openEmojiPickerForActivity() {
            // This is called from the activity modal
            // Ensure emojis are initialized
            if (allEmojis.length === 0) {
                allEmojis = Object.values(emojiData).flat();
            }
            
            emojiPickerContext = 'activityModal'; // Set context to activity modal
            
            const modal = document.getElementById('emojiPickerModal');
            modal.classList.remove('hidden');
            
            // Update title based on language
            document.getElementById('emojiPickerTitle').textContent = currentLanguage === 'en' ? 'Choose Activity Emoji' : 'Elige Emoji de Actividad';
            document.getElementById('emojiSearchInput').placeholder = currentLanguage === 'en' ? 'Search emojis...' : 'Buscar emojis...';
            
            // Reset and render
            currentCategory = 'all';
            document.getElementById('emojiSearchInput').value = '';
            updateCategoryButtons();
            renderEmojis(allEmojis);
        }

        function selectActivityEmoji(emoji) {
            if (selectedActivityIndex !== null && currentTrip) {
                currentTrip.activities[selectedActivityIndex].emoji = emoji;
                saveCurrentTrip();
                renderActivities(currentTrip);
                renderOutfitPlanner(currentTrip);
            }
            closeEmojiPicker();
        }

        function closeEmojiPicker() {
            document.getElementById('emojiPickerModal').classList.add('hidden');
            document.getElementById('emojiPicker').classList.add('hidden');
            document.getElementById('overlay').classList.add('hidden');
            selectedActivityIndex = null;
            emojiPickerContext = null;
        }

        function closeOverlay() {
            // Close whichever modal is open
            if (!document.getElementById('dateRangePicker').classList.contains('hidden')) {
                closeCalendar();
            }
            if (!document.getElementById('emojiPicker').classList.contains('hidden')) {
                closeEmojiPicker();
            }
            if (!document.getElementById('activityDatePicker').classList.contains('hidden')) {
                closeActivityDatePicker();
            }
        }

        // Activity Date Picker Functions
        function openActivityDatePicker(activityIndex) {
            if (!currentTrip) return;
            
            selectedActivityIndexForDate = activityIndex;
            const activity = currentTrip.activities[activityIndex];
            selectedActivityDateValue = activity.date;
            
            // Initialize the month to show the activity's current date or trip start date (parse as local time)
            if (activity.date) {
                const [year, month, day] = activity.date.split('-').map(Number);
                activityDatePickerMonth = new Date(year, month - 1, day);
            } else {
                const [year, month, day] = currentTrip.startDate.split('-').map(Number);
                activityDatePickerMonth = new Date(year, month - 1, day);
            }
            
            // Update title based on language
            document.getElementById('activityDatePickerTitle').textContent = 
                currentLanguage === 'en' ? 'Select Date' : 'Seleccionar Fecha';
            
            // Render the calendar
            renderActivityCalendar();
            
            // Show the modal and overlay
            document.getElementById('activityDatePicker').classList.remove('hidden');
            document.getElementById('overlay').classList.remove('hidden');
        }

        function closeActivityDatePicker() {
            document.getElementById('activityDatePicker').classList.add('hidden');
            document.getElementById('overlay').classList.add('hidden');
            selectedActivityIndexForDate = null;
            selectedActivityDateValue = null;
        }

        function changeActivityMonth(direction) {
            activityDatePickerMonth.setMonth(activityDatePickerMonth.getMonth() + direction);
            renderActivityCalendar();
        }

        function renderActivityCalendar() {
            const year = activityDatePickerMonth.getFullYear();
            const month = activityDatePickerMonth.getMonth();
            
            // Update month/year display
            const monthNames = currentLanguage === 'en' 
                ? ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December']
                : ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            document.getElementById('activityMonthYear').textContent = `${monthNames[month]} ${year}`;
            
            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();
            
            // Build calendar
            const calendarDays = document.getElementById('activityCalendarDays');
            calendarDays.innerHTML = '';
            
            // Get trip date range for validation (parse as local time to avoid timezone shift)
            const [startYear, startMonth, startDay] = currentTrip.startDate.split('-').map(Number);
            const [endYear, endMonth, endDay] = currentTrip.endDate.split('-').map(Number);
            const tripStart = new Date(startYear, startMonth - 1, startDay);
            const tripEnd = new Date(endYear, endMonth - 1, endDay);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Previous month's trailing days
            for (let i = firstDay - 1; i >= 0; i--) {
                const day = daysInPrevMonth - i;
                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day other-month';
                dayDiv.textContent = day;
                calendarDays.appendChild(dayDiv);
            }
            
            // Current month's days
            for (let day = 1; day <= daysInMonth; day++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day';
                dayDiv.textContent = day;
                
                const currentDate = new Date(year, month, day);
                const dateStr = dateToString(currentDate);
                
                // Check if it's today
                if (currentDate.getTime() === today.getTime()) {
                    dayDiv.classList.add('today');
                }
                
                // Check if it's the selected date
                if (dateStr === selectedActivityDateValue) {
                    dayDiv.classList.add('selected');
                }
                
                // Check if date is within trip range
                if (currentDate >= tripStart && currentDate <= tripEnd) {
                    dayDiv.style.cursor = 'pointer';
                    dayDiv.onclick = () => selectActivityDate(dateStr);
                } else {
                    dayDiv.classList.add('other-month');
                    dayDiv.style.cursor = 'not-allowed';
                }
                
                calendarDays.appendChild(dayDiv);
            }
            
            // Next month's leading days
            const totalCells = calendarDays.children.length;
            const remainingCells = 42 - totalCells; // 6 rows of 7 days
            for (let day = 1; day <= remainingCells; day++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day other-month';
                dayDiv.textContent = day;
                calendarDays.appendChild(dayDiv);
            }
        }

        function selectActivityDate(dateStr) {
            if (selectedActivityIndexForDate !== null && currentTrip) {
                updateActivity(selectedActivityIndexForDate, 'date', dateStr);
                closeActivityDatePicker();
            }
        }

        function renderChecklists(trip) {
            renderChecklistItems('essentials', trip.checklists.essentials);
            renderChecklistItems('toiletries', trip.checklists.toiletries);
            renderChecklistItems('custom', trip.checklists.custom);
            document.getElementById('customListName').value = trip.checklists.customName || '';
            
            // Restore custom list visibility
            const customColumn = document.getElementById('customListColumn');
            const addListBtn = document.getElementById('addCustomListBtn');
            
            if (trip.showCustomList) {
                customColumn.style.display = 'block';
                addListBtn.style.display = 'none';
            } else {
                customColumn.style.display = 'none';
                addListBtn.style.display = 'inline-flex';
            }
        }

        function renderChecklistItems(listType, items) {
            const container = document.getElementById(`${listType}List`);
            container.innerHTML = '';

            items.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = `checklist-item ${item.checked ? 'checked' : ''}`;
                div.innerHTML = `
                    <input type="checkbox" ${item.checked ? 'checked' : ''} onchange="toggleChecklistItem('${listType}', ${index})">
                    <input type="text" value="${item.text}" oninput="updateChecklistItem('${listType}', ${index}, this.value)">
                    <button class="delete-btn" onclick="deleteChecklistItem('${listType}', ${index})">✕</button>
                `;
                container.appendChild(div);
            });
        }

        function addChecklistItem(listType) {
            if (!currentTrip) return;
            currentTrip.checklists[listType].push({ text: '', checked: false });
            saveCurrentTrip();
            renderChecklistItems(listType, currentTrip.checklists[listType]);
        }

        function updateChecklistItem(listType, index, value) {
            if (!currentTrip) return;
            currentTrip.checklists[listType][index].text = value;
            saveCurrentTrip();
        }

        function toggleChecklistItem(listType, index) {
            if (!currentTrip) return;
            currentTrip.checklists[listType][index].checked = !currentTrip.checklists[listType][index].checked;
            saveCurrentTrip();
            renderChecklistItems(listType, currentTrip.checklists[listType]);
        }

        function toggleCustomList() {
            const customColumn = document.getElementById('customListColumn');
            const addListBtn = document.getElementById('addCustomListBtn');
            
            if (customColumn.style.display === 'none') {
                // Show custom list
                customColumn.style.display = 'block';
                addListBtn.style.display = 'none';
                
                // Save state
                if (currentTrip) {
                    currentTrip.showCustomList = true;
                    saveCurrentTrip();
                }
            } else {
                // Hide custom list
                customColumn.style.display = 'none';
                addListBtn.style.display = 'inline-flex';
                
                // Save state
                if (currentTrip) {
                    currentTrip.showCustomList = false;
                    saveCurrentTrip();
                }
            }
        }

        function deleteChecklistItem(listType, index) {
            if (!currentTrip) return;
            currentTrip.checklists[listType].splice(index, 1);
            saveCurrentTrip();
            renderChecklistItems(listType, currentTrip.checklists[listType]);
        }

        function renderOutfitPlanner(trip) {
            const container = document.getElementById('outfitPlannerContent');
            container.innerHTML = '';
            
            // Ensure activities array exists
            if (!trip.activities) {
                trip.activities = [];
            }

            // Calculate total number of days (inclusive)
            const startDate = new Date(trip.startDate);
            const endDate = new Date(trip.endDate);
            const totalDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
            
            const days = [];

            // Generate days array by adding days one by one (parse as local time to avoid timezone shift)
            const [startYear, startMonth, startDay] = trip.startDate.split('-').map(Number);
            for (let i = 0; i < totalDays; i++) {
                const day = new Date(startYear, startMonth - 1, startDay + i);
                days.push(day);
            }

            // Group by weeks
            const weeks = [];
            let currentWeek = [];
            
            days.forEach((day, index) => {
                currentWeek.push(day);
                if (currentWeek.length === 7 || index === days.length - 1) {
                    weeks.push([...currentWeek]);
                    currentWeek = [];
                }
            });

            weeks.forEach((week, weekIndex) => {
                const weekDiv = document.createElement('div');
                weekDiv.className = 'week-row';
                weekDiv.innerHTML = `<div class="week-label">${translations[currentLanguage].week} ${weekIndex + 1}</div>`;
                
                const daysGrid = document.createElement('div');
                daysGrid.className = 'days-grid';

                week.forEach((day, dayIndex) => {
                    const dateStr = dateToString(day);
                    const dayOfWeek = day.toLocaleDateString(currentLanguage === 'en' ? 'en-US' : 'es-ES', { weekday: 'short' });
                    const dayNum = day.getDate();

                    // Determine which city/cities the user is in on this day (can be multiple on travel days!)
                    const citiesForDay = getCityForDate(trip.cities, dateStr);
                    
                    // Only show weather if there's a city for this day
                    let weatherDisplay = '';
                    if (citiesForDay.length > 0) {
                        // Get real weather data from the first city
                        weatherDisplay = citiesForDay[0].weatherData
                            ? formatWeatherData(citiesForDay[0].weatherData, dateStr)
                            : '☀️ 72°F'; // Default if city has no weather data
                    } else {
                        // No city selected for this day
                        weatherDisplay = currentLanguage === 'en' ? 'No city selected' : 'No hay ciudad';
                    }

                    if (!trip.outfits[dateStr]) {
                        trip.outfits[dateStr] = {
                            day: { top: '', bottom: '', jacket: '', accessory: '', shoes: '' },
                            night: { top: '', bottom: '', jacket: '', accessory: '', shoes: '' },
                            weather: weatherDisplay
                        };
                    } else {
                        // Update weather if we have new data
                        trip.outfits[dateStr].weather = weatherDisplay;
                    }

                    const outfit = trip.outfits[dateStr];
                    // Only show saved activities (not in edit mode)
                    const dayActivities = (trip.activities || []).filter(a => a.date === dateStr && !a.isEditing);
                    const dayAct = dayActivities.find(a => a.type === 'day');
                    const nightAct = dayActivities.find(a => a.type === 'night');

                    const dayCard = document.createElement('div');
                    dayCard.className = 'day-card';
                    
                    // Build activities HTML
                    const activitiesHtml = renderDayActivities(dateStr, dayActivities);
                    
                    // Build city tags HTML - show all cities for this day
                    let cityTagsHtml = '';
                    if (citiesForDay.length > 0) {
                        // If multiple cities, it's a travel day!
                        const isTravelDay = citiesForDay.length > 1;
                        
                        cityTagsHtml = '<div style="display: flex; flex-wrap: wrap; gap: 5px; margin: 6px 0;">';
                        
                        citiesForDay.forEach(city => {
                            // Use country flag emoji and just city name
                            cityTagsHtml += `
                                <div class="city-tag">
                                    <span class="city-tag-emoji">${city.emoji}</span>
                                    <span>${city.name}</span>
                                </div>
                            `;
                        });
                        
                        // Add travel tag if it's a travel day
                        if (isTravelDay) {
                            cityTagsHtml += `
                                <div class="city-tag travel-tag">
                                    <span class="city-tag-emoji">✈️</span>
                                    <span>${currentLanguage === 'en' ? 'Travel' : 'Viaje'}</span>
                                </div>
                            `;
                        }
                        
                        cityTagsHtml += '</div>';
                    }
                    
                    dayCard.innerHTML = `
                        <div class="day-header">${dayOfWeek} ${dayNum}</div>
                        <div class="day-date">${formatDate(dateStr)}</div>
                        ${cityTagsHtml}
                        <div class="weather-info">${outfit.weather}</div>
                        
                        <div class="day-activities-section">
                            <div class="day-activities-header">
                                <h5>${currentLanguage === 'en' ? 'Activities' : 'Actividades'}</h5>
                                <button class="add-day-activity-btn" onclick="addActivityFromPlanner('${dateStr}')" title="${currentLanguage === 'en' ? 'Add Activity' : 'Agregar Actividad'}">+</button>
                            </div>
                            <div class="day-activities-list" id="activities-${dateStr}">
                                ${activitiesHtml}
                            </div>
                        </div>
                        
                        <div class="outfit-section">
                            <h5>${translations[currentLanguage].dayOutfit}</h5>
                            <div class="outfit-items">
                                ${renderOutfitInputs(dateStr, 'day', outfit.day)}
                            </div>
                        </div>

                        <div class="outfit-section">
                            <h5>${translations[currentLanguage].nightOutfit}</h5>
                            <div class="outfit-items">
                                ${renderOutfitInputs(dateStr, 'night', outfit.night)}
                            </div>
                        </div>
                    `;

                    daysGrid.appendChild(dayCard);
                });

                weekDiv.appendChild(daysGrid);
                container.appendChild(weekDiv);
            });

            saveCurrentTrip();
        }

        function renderDayActivities(dateStr, activities) {
            if (activities.length === 0) {
                return `<p class="no-day-activities">${currentLanguage === 'en' ? 'No activities planned' : 'Sin actividades'}</p>`;
            }
            
            return activities.map(activity => `
                <div class="day-activity-item" data-activity-id="${activity.id}">
                    <span class="day-activity-icon">${activity.type === 'day' ? '☀️' : '🌙'} ${activity.emoji}</span>
                    <span class="day-activity-name">${activity.name}</span>
                    <button class="remove-day-activity-btn" onclick="deleteActivityFromPlanner(${activity.id})" title="${currentLanguage === 'en' ? 'Remove' : 'Eliminar'}">×</button>
                </div>
            `).join('');
        }

        function addActivityFromPlanner(dateStr) {
            if (!currentTrip) return;
            
            // Ensure activities array exists
            if (!currentTrip.activities) {
                currentTrip.activities = [];
            }
            
            // Create a new activity with the selected date
            currentTrip.activities.push({
                id: Date.now(),
                name: '',
                date: dateStr,
                type: 'day',
                emoji: '🎯',
                isEditing: true
            });

            saveCurrentTrip();
            renderActivities(currentTrip);
            renderOutfitPlanner(currentTrip);
            
            // Scroll to the activities section so user can see the new activity
            document.getElementById('activitiesList').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function deleteActivityFromPlanner(activityId) {
            if (!currentTrip) return;
            
            // Ensure activities array exists
            if (!currentTrip.activities) {
                currentTrip.activities = [];
                return;
            }
            
            currentTrip.activities = currentTrip.activities.filter(a => a.id !== activityId);
            saveCurrentTrip();
            renderActivities(currentTrip);
            renderOutfitPlanner(currentTrip);
        }

        function renderOutfitInputs(date, timeOfDay, outfit) {
            const items = ['top', 'bottom', 'jacket', 'accessory', 'shoes'];
            return items.map(item => {
                const isPacked = outfit[`${item}_packed`] || false;
                return `
                    <div class="outfit-item">
                        <input type="checkbox" 
                               id="outfit_${date}_${timeOfDay}_${item}" 
                               class="outfit-checkbox"
                               ${isPacked ? 'checked' : ''}
                               onchange="toggleOutfitPacked('${date}', '${timeOfDay}', '${item}', this.checked)">
                        <label for="outfit_${date}_${timeOfDay}_${item}" class="outfit-item-content ${isPacked ? 'packed' : ''}">
                            <span class="outfit-label">${translations[currentLanguage][item] || item}:</span>
                            <input type="text" value="${outfit[item] || ''}" 
                                   placeholder="${translations[currentLanguage][item] || item}"
                                   oninput="updateOutfit('${date}', '${timeOfDay}', '${item}', this.value)"
                                   class="outfit-input">
                        </label>
                    </div>
                `;
            }).join('');
        }

        function updateOutfit(date, timeOfDay, item, value) {
            if (!currentTrip) return;
            if (!currentTrip.outfits[date]) {
                currentTrip.outfits[date] = {
                    day: { top: '', bottom: '', jacket: '', accessory: '', shoes: '' },
                    night: { top: '', bottom: '', jacket: '', accessory: '', shoes: '' },
                    weather: '☀️ 72°F'
                };
            }
            currentTrip.outfits[date][timeOfDay][item] = value;
            saveCurrentTrip();
        }

        function toggleOutfitPacked(date, timeOfDay, item, isPacked) {
            if (!currentTrip) return;
            if (!currentTrip.outfits[date]) {
                currentTrip.outfits[date] = {
                    day: { top: '', bottom: '', jacket: '', accessory: '', shoes: '' },
                    night: { top: '', bottom: '', jacket: '', accessory: '', shoes: '' },
                    weather: '☀️ 72°F'
                };
            }
            currentTrip.outfits[date][timeOfDay][`${item}_packed`] = isPacked;
            saveCurrentTrip();
            
            // Re-render to show visual update
            renderOutfitPlanner(currentTrip);
        }

        // Emoji data organized by category
        const emojiData = {
            smileys: ['😀', '😃', '😄', '😁', '😆', '😅', '🤣', '😂', '🙂', '🙃', '😉', '😊', '😇', '🥰', '😍', '🤩', '😘', '😗', '😚', '😙', '🥲', '😋', '😛', '😜', '🤪', '😝', '🤑', '🤗', '🤭', '🤫', '🤔', '🤐', '🤨', '😐', '😑', '😶', '😏', '😒', '🙄', '😬', '🤥', '😌', '😔', '😪', '🤤', '😴', '😷', '🤒', '🤕', '🤢', '🤮', '🤧', '🥵', '🥶', '🥴', '😵', '🤯', '🤠', '🥳', '🥸', '😎', '🤓', '🧐'],
            animals: ['🐶', '🐱', '🐭', '🐹', '🐰', '🦊', '🐻', '🐼', '🐨', '🐯', '🦁', '🐮', '🐷', '🐸', '🐵', '🐔', '🐧', '🐦', '🐤', '🐣', '🐥', '🦆', '🦅', '🦉', '🦇', '🐺', '🐗', '🐴', '🦄', '🐝', '🐛', '🦋', '🐌', '🐞', '🐜', '🦟', '🦗', '🕷', '🦂', '🐢', '🐍', '🦎', '🦖', '🦕', '🐙', '🦑', '🦐', '🦞', '🦀', '🐡', '🐠', '🐟', '🐬', '🐳', '🐋', '🦈', '🐊', '🐅', '🐆', '🦓', '🦍', '🦧', '🐘', '🦛', '🦏', '🐪', '🐫', '🦒', '🦘', '🐃', '🐂', '🐄', '🐎', '🐖', '🐏', '🐑', '🦙', '🐐', '🦌', '🐕', '🐩', '🦮', '🐈', '🐓', '🦃', '🦚', '🦜', '🦢', '🦩', '🕊', '🐇', '🦝', '🦨', '🦡', '🦦', '🦥', '🐁', '🐀', '🐿', '🦔'],
            food: ['🍏', '🍎', '🍐', '🍊', '🍋', '🍌', '🍉', '🍇', '🍓', '🫐', '🍈', '🍒', '🍑', '🥭', '🍍', '🥥', '🥝', '🍅', '🍆', '🥑', '🥦', '🥬', '🥒', '🌶', '🫑', '🌽', '🥕', '🫒', '🧄', '🧅', '🥔', '🍠', '🥐', '🥯', '🍞', '🥖', '🥨', '🧀', '🥚', '🍳', '🧈', '🥞', '🧇', '🥓', '🥩', '🍗', '🍖', '🦴', '🌭', '🍔', '🍟', '🍕', '🫓', '🥪', '🥙', '🧆', '🌮', '🌯', '🫔', '🥗', '🥘', '🫕', '🥫', '🍝', '🍜', '🍲', '🍛', '🍣', '🍱', '🥟', '🦪', '🍤', '🍙', '🍚', '🍘', '🍥', '🥠', '🥮', '🍢', '🍡', '🍧', '🍨', '🍦', '🥧', '🧁', '🍰', '🎂', '🍮', '🍭', '🍬', '🍫', '🍿', '🍩', '🍪', '🌰', '🥜', '🍯'],
            activities: ['⚽', '🏀', '🏈', '⚾', '🥎', '🎾', '🏐', '🏉', '🥏', '🎱', '🪀', '🏓', '🏸', '🏒', '🏑', '🥍', '🏏', '🪃', '🥅', '⛳', '🪁', '🏹', '🎣', '🤿', '🥊', '🥋', '🎽', '🛹', '🛼', '🛷', '⛸', '🥌', '🎿', '⛷', '🏂', '🪂', '🏋', '🤼', '🤸', '🤺', '🤾', '🏌', '🏇', '🧘', '🏊', '🤽', '🚣', '🧗', '🚵', '🚴', '🏆', '🥇', '🥈', '🥉', '🏅', '🎖', '🎗', '🎫', '🎟', '🎪', '🤹', '🎭', '🩰', '🎨', '🎬', '🎤', '🎧', '🎼', '🎹', '🥁', '🪘', '🎷', '🎺', '🪗', '🎸', '🪕', '🎻', '🎲', '♟', '🎯', '🎳', '🎮', '🎰', '🧩'],
            travel: ['🚗', '🚕', '🚙', '🚌', '🚎', '🏎', '🚓', '🚑', '🚒', '🚐', '🛻', '🚚', '🚛', '🚜', '🦯', '🦽', '🦼', '🛴', '🚲', '🛵', '🏍', '🛺', '🚨', '🚔', '🚍', '🚘', '🚖', '🚡', '🚠', '🚟', '🚃', '🚋', '🚞', '🚝', '🚄', '🚅', '🚈', '🚂', '🚆', '🚇', '🚊', '🚉', '✈', '🛫', '🛬', '🛩', '💺', '🛰', '🚀', '🛸', '🚁', '🛶', '⛵', '🚤', '🛥', '🛳', '⛴', '🚢', '⚓', '⛽', '🚧', '🚦', '🚥', '🗺', '🗿', '🗽', '🗼', '🏰', '🏯', '🏟', '🎡', '🎢', '🎠', '⛲', '⛱', '🏖', '🏝', '🏜', '🌋', '⛰', '🏔', '🗻', '🏕', '⛺', '🛖', '🏠', '🏡', '🏘', '🏚', '🏗', '🏭', '🏢', '🏬', '🏣', '🏤', '🏥', '🏦', '🏨', '🏪', '🏫', '🏩', '💒', '🏛', '⛪', '🕌', '🕍', '🛕', '🕋'],
            objects: ['⌚', '📱', '📲', '💻', '⌨', '🖥', '🖨', '🖱', '🖲', '🕹', '🗜', '💾', '💿', '📀', '📼', '📷', '📸', '📹', '🎥', '📽', '🎞', '📞', '☎', '📟', '📠', '📺', '📻', '🎙', '🎚', '🎛', '🧭', '⏱', '⏲', '⏰', '🕰', '⌛', '⏳', '📡', '🔋', '🔌', '💡', '🔦', '🕯', '🪔', '🧯', '🛢', '💸', '💵', '💴', '💶', '💷', '🪙', '💰', '💳', '💎', '⚖', '🪜', '🧰', '🪛', '🔧', '🔨', '⚒', '🛠', '⛏', '🪚', '🔩', '⚙', '🪤', '🧱', '⛓', '🧲', '🔫', '💣', '🧨', '🪓', '🔪', '🗡', '⚔', '🛡', '🚬', '⚰', '🪦', '⚱', '🏺', '🔮', '📿', '🧿', '💈', '⚗', '🔭', '🔬', '🕳', '🩹', '🩺', '💊', '💉', '🩸', '🧬', '🦠', '🧫', '🧪', '🌡', '🧹', '🪠', '🧺', '🧻', '🚽', '🚰', '🚿', '🛁', '🛀', '🧼', '🪥', '🪒', '🧽', '🪣', '🧴', '🛎', '🔑', '🗝', '🚪', '🪑', '🛋', '🛏', '🛌', '🧸', '🪆', '🖼', '🪞', '🪟', '🛍', '🎁', '🎈', '🎏', '🎀', '🪄', '🪅', '🎊', '🎉', '🎎', '🏮', '🎐', '🧧', '✉', '📩', '📨', '📧', '💌', '📥', '📤', '📦', '🏷', '🪧', '📪', '📫', '📬', '📭', '📮', '📯', '📜', '📃', '📄', '📑', '🧾', '📊', '📈', '📉', '🗒', '🗓', '📆', '📅', '🗑', '📇', '🗃', '🗳', '🗄', '📋', '📁', '📂', '🗂', '🗞', '📰', '📓', '📔', '📒', '📕', '📗', '📘', '📙', '📚', '📖', '🔖', '🧷', '🔗', '📎', '🖇', '📐', '📏', '🧮', '📌', '📍', '✂', '🖊', '🖋', '✒', '🖌', '🖍', '📝', '✏', '🔍', '🔎', '🔏', '🔐', '🔒', '🔓'],
            symbols: ['❤', '🧡', '💛', '💚', '💙', '💜', '🖤', '🤍', '🤎', '💔', '❣', '💕', '💞', '💓', '💗', '💖', '💘', '💝', '💟', '☮', '✝', '☪', '🕉', '☸', '✡', '🔯', '🕎', '☯', '☦', '🛐', '⛎', '♈', '♉', '♊', '♋', '♌', '♍', '♎', '♏', '♐', '♑', '♒', '♓', '🆔', '⚛', '🉑', '☢', '☣', '📴', '📳', '🈶', '🈚', '🈸', '🈺', '🈷', '✴', '🆚', '💮', '🉐', '㊙', '㊗', '🈴', '🈵', '🈹', '🈲', '🅰', '🅱', '🆎', '🆑', '🅾', '🆘', '❌', '⭕', '🛑', '⛔', '📛', '🚫', '💯', '💢', '♨', '🚷', '🚯', '🚳', '🚱', '🔞', '📵', '🚭', '❗', '❕', '❓', '❔', '‼', '⁉', '🔅', '🔆', '〽', '⚠', '🚸', '🔱', '⚜', '🔰', '♻', '✅', '🈯', '💹', '❇', '✳', '❎', '🌐', '💠', 'Ⓜ', '🌀', '💤', '🏧', '🚾', '♿', '🅿', '🛗', '🈳', '🈂', '🛂', '🛃', '🛄', '🛅', '🚹', '🚺', '🚼', '⚧', '🚻', '🚮', '🎦', '📶', '🈁', '🔣', 'ℹ', '🔤', '🔡', '🔠', '🆖', '🆗', '🆙', '🆒', '🆕', '🆓', '0⃣', '1⃣', '2⃣', '3⃣', '4⃣', '5⃣', '6⃣', '7⃣', '8⃣', '9⃣', '🔟', '🔢', '#⃣', '*⃣', '⏏', '▶', '⏸', '⏯', '⏹', '⏺', '⏭', '⏮', '⏩', '⏪', '⏫', '⏬', '◀', '🔼', '🔽', '➡', '⬅', '⬆', '⬇', '↗', '↘', '↙', '↖', '↕', '↔', '↪', '↩', '⤴', '⤵', '🔀', '🔁', '🔂', '🔄', '🔃', '🎵', '🎶', '➕', '➖', '➗', '✖', '♾', '💲', '💱', '™', '©', '®', '〰', '➰', '➿', '🔚', '🔙', '🔛', '🔝', '🔜', '✔', '☑', '🔘', '🔴', '🟠', '🟡', '🟢', '🔵', '🟣', '⚫', '⚪', '🟤', '🔺', '🔻', '🔸', '🔹', '🔶', '🔷', '🔳', '🔲', '▪', '▫', '◾', '◽', '◼', '◻', '🟥', '🟧', '🟨', '🟩', '🟦', '🟪', '⬛', '⬜', '🟫', '🔈', '🔇', '🔉', '🔊', '🔔', '🔕', '📣', '📢', '👁‍🗨', '💬', '💭', '🗯', '♠', '♣', '♥', '♦', '🃏', '🎴', '🀄', '🕐', '🕑', '🕒', '🕓', '🕔', '🕕', '🕖', '🕗', '🕘', '🕙', '🕚', '🕛', '🕜', '🕝', '🕞', '🕟', '🕠', '🕡', '🕢', '🕣', '🕤', '🕥', '🕦', '🕧'],
            flags: ['🏴', '🏳', '🏳️‍🌈', '🏳️‍⚧️', '🏴‍☠️', '🇦🇨', '🇦🇩', '🇦🇪', '🇦🇫', '🇦🇬', '🇦🇮', '🇦🇱', '🇦🇲', '🇦🇴', '🇦🇶', '🇦🇷', '🇦🇸', '🇦🇹', '🇦🇺', '🇦🇼', '🇦🇽', '🇦🇿', '🇧🇦', '🇧🇧', '🇧🇩', '🇧🇪', '🇧🇫', '🇧🇬', '🇧🇭', '🇧🇮', '🇧🇯', '🇧🇱', '🇧🇲', '🇧🇳', '🇧🇴', '🇧🇶', '🇧🇷', '🇧🇸', '🇧🇹', '🇧🇻', '🇧🇼', '🇧🇾', '🇧🇿', '🇨🇦', '🇨🇨', '🇨🇩', '🇨🇫', '🇨🇬', '🇨🇭', '🇨🇮', '🇨🇰', '🇨🇱', '🇨🇲', '🇨🇳', '🇨🇴', '🇨🇵', '🇨🇷', '🇨🇺', '🇨🇻', '🇨🇼', '🇨🇽', '🇨🇾', '🇨🇿', '🇩🇪', '🇩🇬', '🇩🇯', '🇩🇰', '🇩🇲', '🇩🇴', '🇩🇿', '🇪🇦', '🇪🇨', '🇪🇪', '🇪🇬', '🇪🇭', '🇪🇷', '🇪🇸', '🇪🇹', '🇪🇺', '🇫🇮', '🇫🇯', '🇫🇰', '🇫🇲', '🇫🇴', '🇫🇷', '🇬🇦', '🇬🇧', '🇬🇩', '🇬🇪', '🇬🇫', '🇬🇬', '🇬🇭', '🇬🇮', '🇬🇱', '🇬🇲', '🇬🇳', '🇬🇵', '🇬🇶', '🇬🇷', '🇬🇸', '🇬🇹', '🇬🇺', '🇬🇼', '🇬🇾', '🇭🇰', '🇭🇲', '🇭🇳', '🇭🇷', '🇭🇹', '🇭🇺', '🇮🇨', '🇮🇩', '🇮🇪', '🇮🇱', '🇮🇲', '🇮🇳', '🇮🇴', '🇮🇶', '🇮🇷', '🇮🇸', '🇮🇹', '🇯🇪', '🇯🇲', '🇯🇴', '🇯🇵', '🇰🇪', '🇰🇬', '🇰🇭', '🇰🇮', '🇰🇲', '🇰🇳', '🇰🇵', '🇰🇷', '🇰🇼', '🇰🇾', '🇰🇿', '🇱🇦', '🇱🇧', '🇱🇨', '🇱🇮', '🇱🇰', '🇱🇷', '🇱🇸', '🇱🇹', '🇱🇺', '🇱🇻', '🇱🇾', '🇲🇦', '🇲🇨', '🇲🇩', '🇲🇪', '🇲🇫', '🇲🇬', '🇲🇭', '🇲🇰', '🇲🇱', '🇲🇲', '🇲🇳', '🇲🇴', '🇲🇵', '🇲🇶', '🇲🇷', '🇲🇸', '🇲🇹', '🇲🇺', '🇲🇻', '🇲🇼', '🇲🇽', '🇲🇾', '🇲🇿', '🇳🇦', '🇳🇨', '🇳🇪', '🇳🇫', '🇳🇬', '🇳🇮', '🇳🇱', '🇳🇴', '🇳🇵', '🇳🇷', '🇳🇺', '🇳🇿', '🇴🇲', '🇵🇦', '🇵🇪', '🇵🇫', '🇵🇬', '🇵🇭', '🇵🇰', '🇵🇱', '🇵🇲', '🇵🇳', '🇵🇷', '🇵🇸', '🇵🇹', '🇵🇼', '🇵🇾', '🇶🇦', '🇷🇪', '🇷🇴', '🇷🇸', '🇷🇺', '🇷🇼', '🇸🇦', '🇸🇧', '🇸🇨', '🇸🇩', '🇸🇪', '🇸🇬', '🇸🇭', '🇸🇮', '🇸🇯', '🇸🇰', '🇸🇱', '🇸🇲', '🇸🇳', '🇸🇴', '🇸🇷', '🇸🇸', '🇸🇹', '🇸🇻', '🇸🇽', '🇸🇾', '🇸🇿', '🇹🇦', '🇹🇨', '🇹🇩', '🇹🇫', '🇹🇬', '🇹🇭', '🇹🇯', '🇹🇰', '🇹🇱', '🇹🇲', '🇹🇳', '🇹🇴', '🇹🇷', '🇹🇹', '🇹🇻', '🇹🇼', '🇹🇿', '🇺🇦', '🇺🇬', '🇺🇲', '🇺🇳', '🇺🇸', '🇺🇾', '🇺🇿', '🇻🇦', '🇻🇨', '🇻🇪', '🇻🇬', '🇻🇮', '🇻🇳', '🇻🇺', '🇼🇫', '🇼🇸', '🇽🇰', '🇾🇪', '🇾🇹', '🇿🇦', '🇿🇲', '🇿🇼', '🏴󠁧󠁢󠁥󠁮󠁧󠁿', '🏴󠁧󠁢󠁳󠁣󠁴󠁿', '🏴󠁧󠁢󠁷󠁬󠁳󠁿']
        };

        let allEmojis = [];
        let currentCategory = 'all';
        let filteredEmojis = [];

        function initializeEmojiPicker() {
            // Flatten all emojis
            allEmojis = Object.values(emojiData).flat();
            filteredEmojis = allEmojis;
        }

        function openEmojiPicker() {
            if (!currentTrip) return;
            
            // Ensure emojis are initialized
            if (allEmojis.length === 0) {
                allEmojis = Object.values(emojiData).flat();
            }
            
            emojiPickerContext = 'trip'; // Set context to trip
            
            const modal = document.getElementById('emojiPickerModal');
            modal.classList.remove('hidden');
            
            // Update title based on language
            document.getElementById('emojiPickerTitle').textContent = currentLanguage === 'en' ? 'Choose an Emoji' : 'Elige un Emoji';
            document.getElementById('emojiSearchInput').placeholder = currentLanguage === 'en' ? 'Search emojis...' : 'Buscar emojis...';
            
            // Reset and render
            currentCategory = 'all';
            document.getElementById('emojiSearchInput').value = '';
            updateCategoryButtons();
            renderEmojis(allEmojis);
        }

        function openTripCreationEmojiPicker() {
            // Ensure emojis are initialized
            if (allEmojis.length === 0) {
                allEmojis = Object.values(emojiData).flat();
            }
            
            emojiPickerContext = 'tripCreation'; // Set context to trip creation
            
            const modal = document.getElementById('emojiPickerModal');
            modal.classList.remove('hidden');
            
            // Update title based on language
            document.getElementById('emojiPickerTitle').textContent = currentLanguage === 'en' ? 'Choose Trip Emoji' : 'Elige Emoji del Viaje';
            document.getElementById('emojiSearchInput').placeholder = currentLanguage === 'en' ? 'Search emojis...' : 'Buscar emojis...';
            
            // Reset and render
            currentCategory = 'all';
            document.getElementById('emojiSearchInput').value = '';
            updateCategoryButtons();
            renderEmojis(allEmojis);
        }

        function closeEmojiPicker() {
            const modal = document.getElementById('emojiPickerModal');
            modal.classList.add('hidden');
        }

        function renderEmojis(emojis) {
            const grid = document.getElementById('emojiPickerGrid');
            grid.innerHTML = '';
            
            if (emojis.length === 0) {
                grid.innerHTML = `<div class="emoji-picker-empty">${currentLanguage === 'en' ? 'No emojis found' : 'No se encontraron emojis'}</div>`;
                return;
            }
            
            emojis.forEach(emoji => {
                const button = document.createElement('button');
                button.className = 'emoji-item';
                button.textContent = emoji;
                button.onclick = () => selectEmoji(emoji);
                grid.appendChild(button);
            });
        }

        function selectEmoji(emoji) {
            // Check if we're selecting emoji for trip creation (before a trip exists)
            if (emojiPickerContext === 'tripCreation') {
                tripCreationEmoji = emoji;
                document.getElementById('selectedTripEmoji').textContent = emoji;
                closeEmojiPicker();
                return;
            }
            
            // Check if we're selecting emoji for activity modal (before activity is saved)
            if (emojiPickerContext === 'activityModal') {
                selectedActivityEmoji = emoji;
                document.getElementById('activityEmojiDisplay').textContent = emoji;
                closeEmojiPicker();
                return;
            }
            
            // Check if we're selecting emoji for itinerary modal
            if (emojiPickerContext === 'itinerary') {
                currentItineraryEmoji = emoji;
                document.getElementById('itineraryActivityEmoji').textContent = emoji;
                closeEmojiPicker();
                return;
            }
            
            if (!currentTrip) return;
            
            // Check if we're selecting emoji for an activity or for the trip
            if (emojiPickerContext === 'activity') {
                selectActivityEmoji(emoji);
                return;
            }
            
            // Otherwise, this is for the trip emoji
            currentTrip.emoji = emoji;
            
            // Update the icon immediately
            document.getElementById('tripIcon').textContent = currentTrip.emoji;
            
            // Save to localStorage
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            const tripIndex = users[currentUser].trips.findIndex(t => t.id === currentTrip.id);
            if (tripIndex !== -1) {
                users[currentUser].trips[tripIndex].emoji = currentTrip.emoji;
                localStorage.setItem('users', JSON.stringify(users));
            }
            
            // Refresh sidebar and home page
            loadSidebarTrips();
            loadTrips();
            
            // Close the picker
            closeEmojiPicker();
        }

        function filterEmojiCategory(category) {
            currentCategory = category;
            updateCategoryButtons();
            
            if (category === 'all') {
                filteredEmojis = allEmojis;
            } else {
                filteredEmojis = emojiData[category] || [];
            }
            
            renderEmojis(filteredEmojis);
        }

        function updateCategoryButtons() {
            const buttons = document.querySelectorAll('.emoji-category-btn');
            buttons.forEach(btn => {
                if (btn.dataset.category === currentCategory) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        function searchEmojis(query) {
            if (!query.trim()) {
                filterEmojiCategory(currentCategory);
                return;
            }
            
            const lowerQuery = query.toLowerCase();
            
            // Simple keyword mapping for common searches
            const keywords = {
                'smile': ['😀', '😃', '😄', '😁', '😆', '😊', '🙂', '😸'],
                'happy': ['😀', '😃', '😄', '😁', '😆', '😊', '🥰', '😍', '🤗'],
                'love': ['❤', '💕', '💖', '💗', '💘', '💝', '💞', '💓', '🥰', '😍', '😘', '💏', '💑'],
                'heart': ['❤', '🧡', '💛', '💚', '💙', '💜', '🖤', '🤍', '🤎', '💔', '💕', '💖', '💗', '💘', '💝'],
                'sad': ['😢', '😭', '😔', '😞', '😿'],
                'laugh': ['😂', '🤣', '😆', '😹'],
                'angry': ['😠', '😡', '🤬', '😾'],
                'fire': ['🔥', '🧯'],
                'star': ['⭐', '🌟', '✨', '💫', '🌠'],
                'sun': ['☀', '🌞', '🌅', '🌄'],
                'moon': ['🌙', '🌛', '🌜', '🌚'],
                'food': ['🍕', '🍔', '🍟', '🌮', '🌯', '🍎', '🍌', '🍉', '🍇', '🍓', '🍒', '🍑', '🥑', '🍆', '🥐', '🥖', '🥨', '🧀', '🍖', '🍗', '🥩', '🥓', '🍳', '🥞', '🧇', '🍕', '🍔', '🍟', '🌭', '🍿', '🧈', '🥗', '🍜', '🍲', '🍱', '🍣', '🥟', '🍤', '🍙', '🍚', '🍘', '🍥', '🥠', '🍡', '🍧', '🍨', '🍦', '🥧', '🧁', '🍰', '🎂', '🍮', '🍭', '🍬', '🍫', '🍩', '🍪'],
                'drink': ['☕', '🍵', '🧃', '🥤', '🧋', '🍶', '🍺', '🍻', '🥂', '🍷', '🥃', '🍸', '🍹', '🧉', '🍾', '🧊'],
                'travel': ['✈', '🛫', '🛬', '🧳', '🗺', '📍', '🏨', '🏝', '🗼', '🎒', '🚗', '🚕', '🚙', '🚌', '🚎', '🏎', '🚓', '🚑', '🚒', '🚐', '🚚', '🚛', '🚜', '🛴', '🚲', '🛵', '🏍', '🚁', '🚀', '🛸', '🛶', '⛵', '🚤', '🛥', '🛳', '⛴', '🚢', '🌍', '🌎', '🌏'],
                'trip': ['✈', '🛫', '🛬', '🧳', '🗺', '📍', '🏨', '🏝', '🗼', '🎒', '🌍', '🌎', '🌏', '🗿', '🏛', '🕌', '🛕'],
                'vacation': ['🏖', '🏝', '⛱', '🏄', '🏊', '🤿', '🌊', '☀', '🌞', '🕶', '🩱', '👙', '🍹', '🧳'],
                'luggage': ['🧳', '👜', '🎒', '💼', '👛', '🛄', '🛅'],
                'suitcase': ['🧳', '👜', '💼'],
                'baggage': ['🧳', '👜', '🎒', '💼', '🛄', '🛅'],
                'backpack': ['🎒', '🧳'],
                'plane': ['✈', '🛫', '🛬', '🛩', '🚁', '🛸', '🚀'],
                'car': ['🚗', '🚕', '🚙', '🚌', '🏎', '🚓', '🚔'],
                'hotel': ['🏨', '🛏', '🛎', '🏩'],
                'restaurant': ['🍽', '🍴', '🥄', '🔪', '🥢', '🍽'],
                'shopping': ['🛍', '💳', '💰', '🛒', '💵', '💴', '💶', '💷'],
                'money': ['💰', '💵', '💴', '💶', '💷', '💸', '💳', '🪙', '💎'],
                'music': ['🎵', '🎶', '🎤', '🎧', '🎸', '🎹', '🎺', '🎻', '🥁', '🎷', '🎼'],
                'sport': ['⚽', '🏀', '🏈', '⚾', '🥎', '🎾', '🏐', '🏉', '🎱', '🏓', '🏸', '🥊', '🥋', '🤺', '🏆', '🥇', '🥈', '🥉'],
                'animal': emojiData.animals,
                'dog': ['🐶', '🐕', '🐩', '🐕‍🦺'],
                'cat': ['🐱', '🐈', '🐈‍⬛'],
                'beach': ['🏖', '🏝', '⛱', '🏄', '🏊', '🤿', '🌊'],
                'mountain': ['⛰', '🏔', '🗻', '🏕', '⛺'],
                'weather': ['☀', '⛅', '☁', '🌤', '🌥', '🌦', '🌧', '⛈', '🌩', '🌨', '❄', '☃', '⛄', '🌬', '💨', '🌪', '🌫', '🌈'],
                'rain': ['🌧', '⛈', '🌦', '🌨', '💧', '☔'],
                'snow': ['❄', '☃', '⛄', '🌨'],
                'flower': ['💐', '🌸', '🌺', '🌻', '🌷', '🌹', '🥀', '🏵', '🌼', '💮'],
                'nature': ['🌳', '🌲', '🌴', '🌱', '🍀', '🌿', '🌾', '🌵', '🌾', '🦋', '🐝', '🐛', '🐞', '🦗', '🕷', '🌍', '🌎', '🌏'],
                'tree': ['🌳', '🌲', '🌴', '🌱', '🎄', '🌵'],
                'plant': ['🌱', '🌿', '☘', '🍀', '🎍', '🎋', '🌾', '🌵', '🪴'],
                'garden': ['🌻', '🌺', '🌸', '🌷', '🌹', '💐', '🌼', '🏵', '🌱', '🌿', '🍀'],
                'wedding': ['💍', '👰', '🤵', '💐', '💒', '🎊', '🥂', '🎉', '💕', '💖', '💗', '❤', '🎂', '🍾'],
                'romance': ['❤', '💕', '💖', '💗', '💘', '💝', '💞', '💓', '🥰', '😍', '😘', '💏', '💑', '🌹', '💐'],
                'party': ['🎉', '🎊', '🎈', '🎁', '🎀', '🎂', '🍰', '🧁', '🥳', '🎆', '🎇', '🪅'],
                'celebration': ['🎉', '🎊', '🎈', '🎁', '🎀', '🎆', '🎇', '🥳', '🍾', '🥂', '🎇'],
                'birthday': ['🎂', '🎁', '🎈', '🎉', '🎊', '🥳', '🧁', '🍰', '🎀', '🕯'],
                'christmas': ['🎄', '🎅', '🤶', '🎁', '❄', '⛄', '☃', '🔔', '🎀', '⛷', '🎿'],
                'halloween': ['🎃', '👻', '🦇', '🕷', '🕸', '🧛', '🧟', '💀', '🕯', '🍬', '🍭'],
                'summer': ['☀', '🌞', '🏖', '🏝', '⛱', '🍉', '🕶', '🩱', '👙', '🌊', '🏄', '🏊'],
                'winter': ['❄', '⛄', '☃', '🌨', '🎿', '⛷', '🏂', '⛸', '🧣', '🧤', '🧥'],
                'spring': ['🌸', '🌺', '🌻', '🌷', '🌼', '🦋', '🐝', '🌱', '☀', '🌦', '🌈'],
                'autumn': ['🍂', '🍁', '🎃', '🌾', '🍄', '🦃', '🥧'],
                'fall': ['🍂', '🍁', '🎃', '🌾', '🍄', '🦃', '🥧'],
                'flag': emojiData.flags,
                'check': ['✅', '✔', '☑'],
                'cross': ['❌', '❎', '✖'],
                'arrow': ['➡', '⬅', '⬆', '⬇', '↗', '↘', '↙', '↖', '↕', '↔'],
                'number': ['0⃣', '1⃣', '2⃣', '3⃣', '4⃣', '5⃣', '6⃣', '7⃣', '8⃣', '9⃣', '🔟']
            };
            
            // Check if the query matches any keyword
            let results = [];
            for (const [key, emojis] of Object.entries(keywords)) {
                if (key.includes(lowerQuery) || lowerQuery.includes(key)) {
                    results = results.concat(emojis);
                }
            }
            
            // Remove duplicates
            results = [...new Set(results)];
            
            // If no keyword matches, search in the current category
            if (results.length === 0) {
                const emojisToSearch = currentCategory === 'all' ? allEmojis : emojiData[currentCategory];
                results = emojisToSearch.slice(0, 50); // Show first 50 if no match
            }
            
            renderEmojis(results);
        }

        function changeEmoji() {
            if (!currentTrip) return;
            openEmojiPicker();
        }

        function saveCurrentTrip() {
            if (!currentTrip) return;

            // Update trip name if changed
            const tripNameInput = document.getElementById('tripName');
            if (tripNameInput) {
                currentTrip.name = tripNameInput.value;
            }

            // Update notes if changed
            const tripNotesInput = document.getElementById('tripNotes');
            if (tripNotesInput) {
                currentTrip.notes = tripNotesInput.value;
            }

            // Update custom list name
            const customListNameInput = document.getElementById('customListName');
            if (customListNameInput) {
                currentTrip.checklists.customName = customListNameInput.value;
            }

            const users = JSON.parse(localStorage.getItem('users') || '{}');
            const tripIndex = users[currentUser].trips.findIndex(t => t.id === currentTrip.id);
            
            if (tripIndex !== -1) {
                users[currentUser].trips[tripIndex] = currentTrip;
                localStorage.setItem('users', JSON.stringify(users));
            }
        }

        function deleteTrip() {
            if (!currentTrip) return;

            const confirmMsg = currentLanguage === 'en' 
                ? 'Are you sure you want to delete this trip?' 
                : '¿Estás seguro de que quieres eliminar este viaje?';
            
            if (!confirm(confirmMsg)) return;

            const users = JSON.parse(localStorage.getItem('users') || '{}');
            const tripIndex = users[currentUser].trips.findIndex(t => t.id === currentTrip.id);
            
            if (tripIndex !== -1) {
                users[currentUser].trips.splice(tripIndex, 1);
                localStorage.setItem('users', JSON.stringify(users));
                showLandingPage();
            }
        }

        // Edit Trip Functions
        let editTripStartDate = null;
        let editTripEndDate = null;
        let editTripCalendarMonth = null;

        function openEditTripModal() {
            if (!currentTrip) return;
            
            // Pre-fill with current trip data
            document.getElementById('editDestination').value = currentTrip.destination;
            editTripStartDate = currentTrip.startDate;
            editTripEndDate = currentTrip.endDate;
            
            updateEditDatePickerButton();
            
            // Show modal
            document.getElementById('editTripModal').classList.remove('hidden');
            document.getElementById('overlay').classList.remove('hidden');
        }

        function closeEditTripModal() {
            document.getElementById('editTripModal').classList.add('hidden');
            document.getElementById('overlay').classList.add('hidden');
            editTripStartDate = null;
            editTripEndDate = null;
        }

        function openEditTripCalendar() {
            editTripCalendarMonth = new Date();
            renderEditTripCalendar();
            document.getElementById('editTripCalendar').classList.remove('hidden');
            document.getElementById('editTripModal').classList.add('hidden');
        }

        function closeEditTripCalendar() {
            document.getElementById('editTripCalendar').classList.add('hidden');
            document.getElementById('editTripModal').classList.remove('hidden');
            updateEditDatePickerButton();
        }

        function changeEditTripMonth(direction) {
            editTripCalendarMonth.setMonth(editTripCalendarMonth.getMonth() + direction);
            renderEditTripCalendar();
        }

        function renderEditTripCalendar() {
            const month = editTripCalendarMonth.getMonth();
            const year = editTripCalendarMonth.getFullYear();
            
            // Update month display
            const monthNames = currentLanguage === 'en' 
                ? ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December']
                : ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            document.getElementById('editCalendarMonth').textContent = `${monthNames[month]} ${year}`;
            
            // Render weekdays
            const weekdays = currentLanguage === 'en' 
                ? ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']
                : ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
            const weekdaysContainer = document.getElementById('editCalendarWeekdays');
            weekdaysContainer.innerHTML = '';
            weekdays.forEach(day => {
                const div = document.createElement('div');
                div.textContent = day;
                weekdaysContainer.appendChild(div);
            });
            
            // Render days
            const container = document.getElementById('editCalendarDays');
            container.innerHTML = '';
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Previous month's days
            const prevMonthDays = new Date(year, month, 0).getDate();
            for (let i = firstDay - 1; i >= 0; i--) {
                const day = prevMonthDays - i;
                const date = new Date(year, month - 1, day);
                container.appendChild(createEditDayElement(day, date, true));
            }
            
            // Current month's days
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                container.appendChild(createEditDayElement(day, date, false));
            }
            
            // Next month's days
            const totalCells = container.children.length;
            const remainingCells = 42 - totalCells;
            for (let day = 1; day <= remainingCells; day++) {
                const date = new Date(year, month + 1, day);
                container.appendChild(createEditDayElement(day, date, true));
            }
            
            updateEditSelectedDatesDisplay();
        }

        function createEditDayElement(day, date, isOtherMonth) {
            const div = document.createElement('div');
            div.className = 'calendar-day';
            div.textContent = day;
            
            if (isOtherMonth) {
                div.classList.add('other-month');
            }
            
            const dateStr = dateToString(date);
            
            // Check if selected
            if (editTripStartDate && dateStr === editTripStartDate) {
                div.classList.add('selected-start');
            }
            if (editTripEndDate && dateStr === editTripEndDate) {
                div.classList.add('selected-end');
            }
            
            // Check if in range (compare date strings to avoid timezone issues)
            if (editTripStartDate && editTripEndDate) {
                if (dateStr > editTripStartDate && dateStr < editTripEndDate) {
                    div.classList.add('in-range');
                }
            }
            
            div.onclick = () => selectEditDate(dateStr);
            
            return div;
        }

        function selectEditDate(dateStr) {
            if (!editTripStartDate || (editTripStartDate && editTripEndDate)) {
                // Start new selection
                editTripStartDate = dateStr;
                editTripEndDate = null;
            } else if (editTripStartDate && !editTripEndDate) {
                // Complete selection
                // Compare dates as strings (YYYY-MM-DD format) to avoid timezone issues
                if (dateStr < editTripStartDate) {
                    editTripEndDate = editTripStartDate;
                    editTripStartDate = dateStr;
                } else {
                    editTripEndDate = dateStr;
                }
            }
            
            renderEditTripCalendar();
        }

        function updateEditSelectedDatesDisplay() {
            const textElement = document.getElementById('editSelectedDatesText');
            const rangeElement = document.getElementById('editSelectedDatesRange');
            
            if (!editTripStartDate) {
                textElement.textContent = currentLanguage === 'en' 
                    ? 'Select start and end dates' 
                    : 'Selecciona fechas de inicio y fin';
                rangeElement.textContent = '';
            } else if (editTripStartDate && !editTripEndDate) {
                textElement.textContent = currentLanguage === 'en' 
                    ? 'Select end date' 
                    : 'Selecciona fecha de fin';
                rangeElement.textContent = formatDate(editTripStartDate);
            } else if (editTripStartDate && editTripEndDate) {
                const duration = Math.ceil((new Date(editTripEndDate) - new Date(editTripStartDate)) / (1000 * 60 * 60 * 24)) + 1;
                textElement.textContent = currentLanguage === 'en' 
                    ? `${duration} days trip` 
                    : `Viaje de ${duration} días`;
                rangeElement.textContent = `${formatDate(editTripStartDate)} → ${formatDate(editTripEndDate)}`;
            }
        }

        function updateEditDatePickerButton() {
            const button = document.getElementById('editDatePickerButton');
            const buttonText = document.getElementById('editDatePickerButtonText');
            
            if (editTripStartDate && editTripEndDate) {
                const duration = Math.ceil((new Date(editTripEndDate) - new Date(editTripStartDate)) / (1000 * 60 * 60 * 24)) + 1;
                buttonText.textContent = `${formatDate(editTripStartDate)} → ${formatDate(editTripEndDate)} (${duration} ${translations[currentLanguage].days})`;
                button.classList.add('has-dates');
            } else if (editTripStartDate) {
                buttonText.textContent = formatDate(editTripStartDate);
                button.classList.add('has-dates');
            } else {
                buttonText.textContent = translations[currentLanguage].clickToSelectDates;
                button.classList.remove('has-dates');
            }
        }

        async function saveEditedTrip() {
            if (!currentTrip) return;
            
            const newDestination = document.getElementById('editDestination').value.trim();
            
            if (!newDestination) {
                alert(currentLanguage === 'en' ? 'Please enter a destination' : 'Por favor ingrese un destino');
                return;
            }
            
            if (!editTripStartDate || !editTripEndDate) {
                alert(currentLanguage === 'en' ? 'Please select start and end dates' : 'Por favor seleccione fechas de inicio y fin');
                return;
            }
            
            // Check if dates or destination changed
            const datesChanged = editTripStartDate !== currentTrip.startDate || editTripEndDate !== currentTrip.endDate;
            const destinationChanged = newDestination !== currentTrip.destination;
            
            if (!datesChanged && !destinationChanged) {
                closeEditTripModal();
                return;
            }
            
            // Update trip
            currentTrip.destination = newDestination;
            currentTrip.startDate = editTripStartDate;
            currentTrip.endDate = editTripEndDate;
            
            // If destination changed, fetch new data
            if (destinationChanged) {
                const [countryData, weatherData] = await Promise.all([
                    fetchCountryData(newDestination),
                    fetchWeatherForecast(newDestination, editTripStartDate, editTripEndDate)
                ]);
                
                let socketType = getSocketType(newDestination);
                let voltage = getVoltage(socketType);
                
                if (countryData && countryData.plugTypes) {
                    socketType = `Type ${countryData.plugTypes}`;
                }
                
                currentTrip.socketType = socketType;
                currentTrip.socketIcon = getSocketSVG(socketType);
                currentTrip.weatherData = weatherData;
            }
            
            // If dates changed, update weather data
            if (datesChanged && !destinationChanged) {
                const weatherData = await fetchWeatherForecast(currentTrip.destination, editTripStartDate, editTripEndDate);
                currentTrip.weatherData = weatherData;
            }
            
            // Adjust activities to be within new date range
            if (datesChanged && currentTrip.activities) {
                currentTrip.activities = currentTrip.activities.filter(activity => {
                    // Compare date strings directly (YYYY-MM-DD format) to avoid timezone issues
                    return activity.date >= editTripStartDate && activity.date <= editTripEndDate;
                });
            }
            
            // Save and refresh
            saveCurrentTrip();
            renderTripDetail(currentTrip);
            loadSidebarTrips();
            closeEditTripModal();
            
            alert(currentLanguage === 'en' 
                ? 'Trip updated successfully!' 
                : '¡Viaje actualizado exitosamente!');
        }

        // City Management Functions
        let cityStartDate = null;
        let cityEndDate = null;
        let cityCalendarMonth = new Date();

        function openAddCityModal() {
            if (!currentTrip) return;
            
            document.getElementById('addCityModal').classList.remove('hidden');
            document.getElementById('overlay').classList.remove('hidden');
            
            // Reset form
            document.getElementById('cityDestination').value = '';
            cityStartDate = null;
            cityEndDate = null;
            updateCityDatePickerButton();
            
            // Setup autocomplete for city input
            setupCityAutocomplete();
        }

        function closeAddCityModal() {
            document.getElementById('addCityModal').classList.add('hidden');
            document.getElementById('overlay').classList.add('hidden');
        }

        function openCityCalendar() {
            document.getElementById('addCityModal').classList.add('hidden');
            document.getElementById('cityCalendar').classList.remove('hidden');
            
            // Initialize calendar to trip start date or current month
            cityCalendarMonth = new Date(currentTrip.startDate);
            renderCityCalendar();
        }

        function closeCityCalendar() {
            document.getElementById('cityCalendar').classList.add('hidden');
            document.getElementById('addCityModal').classList.remove('hidden');
            updateCityDatePickerButton();
        }

        function changeCityMonth(direction) {
            cityCalendarMonth.setMonth(cityCalendarMonth.getMonth() + direction);
            renderCityCalendar();
        }

        function renderCityCalendar() {
            const monthNames = currentLanguage === 'en' 
                ? ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December']
                : ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            const year = cityCalendarMonth.getFullYear();
            const month = cityCalendarMonth.getMonth();
            
            document.getElementById('cityCalendarMonth').textContent = `${monthNames[month]} ${year}`;
            
            const weekdaysContainer = document.getElementById('cityCalendarWeekdays');
            const weekdays = currentLanguage === 'en' 
                ? ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']
                : ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
            
            weekdaysContainer.innerHTML = weekdays.map(day => 
                `<div class="calendar-weekday">${day}</div>`
            ).join('');
            
            const daysContainer = document.getElementById('cityCalendarDays');
            daysContainer.innerHTML = '';
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Add empty cells for days before the first day of the month
            for (let i = 0; i < firstDay; i++) {
                daysContainer.appendChild(document.createElement('div'));
            }
            
            // Add day cells
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = createCityDayElement(year, month, day);
                daysContainer.appendChild(dayElement);
            }
            
            updateCitySelectedDatesDisplay();
        }

        function createCityDayElement(year, month, day) {
            const date = new Date(year, month, day);
            const dateStr = dateToString(date);
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';
            dayElement.textContent = day;
            dayElement.onclick = () => selectCityDate(dateStr);
            
            // Check if date is within trip range
            const tripStart = currentTrip.startDate;
            const tripEnd = currentTrip.endDate;
            
            if (dateStr < tripStart || dateStr > tripEnd) {
                dayElement.classList.add('disabled');
                dayElement.onclick = null;
                return dayElement;
            }
            
            // Highlight selected dates
            if (dateStr === cityStartDate) {
                dayElement.classList.add('selected-start');
            }
            if (dateStr === cityEndDate) {
                dayElement.classList.add('selected-end');
            }
            if (cityStartDate && cityEndDate && dateStr > cityStartDate && dateStr < cityEndDate) {
                dayElement.classList.add('in-range');
            }
            
            return dayElement;
        }

        function selectCityDate(dateStr) {
            // Validate date is within trip range
            if (dateStr < currentTrip.startDate || dateStr > currentTrip.endDate) {
                return; // Don't allow selection outside trip dates
            }
            
            if (!cityStartDate || (cityStartDate && cityEndDate)) {
                // Start new selection
                cityStartDate = dateStr;
                cityEndDate = null;
            } else {
                // Set end date
                if (dateStr < cityStartDate) {
                    cityEndDate = cityStartDate;
                    cityStartDate = dateStr;
                } else {
                    cityEndDate = dateStr;
                }
            }
            
            renderCityCalendar();
        }

        function updateCitySelectedDatesDisplay() {
            const selectedDatesText = document.getElementById('citySelectedDatesText');
            const selectedDatesRange = document.getElementById('citySelectedDatesRange');
            
            if (cityStartDate && cityEndDate) {
                selectedDatesText.textContent = currentLanguage === 'en' ? 'Selected dates:' : 'Fechas seleccionadas:';
                selectedDatesRange.textContent = `${formatDate(cityStartDate)} - ${formatDate(cityEndDate)}`;
            } else if (cityStartDate) {
                selectedDatesText.textContent = currentLanguage === 'en' ? 'Select end date' : 'Selecciona fecha de fin';
                selectedDatesRange.textContent = formatDate(cityStartDate);
            } else {
                selectedDatesText.textContent = currentLanguage === 'en' 
                    ? `Select dates within trip (${formatDate(currentTrip.startDate)} - ${formatDate(currentTrip.endDate)})`
                    : `Selecciona fechas dentro del viaje (${formatDate(currentTrip.startDate)} - ${formatDate(currentTrip.endDate)})`;
                selectedDatesRange.textContent = '';
            }
        }

        function updateCityDatePickerButton() {
            const button = document.getElementById('cityDatePickerButton');
            const buttonText = document.getElementById('cityDatePickerButtonText');
            
            if (cityStartDate && cityEndDate) {
                buttonText.textContent = `${formatDate(cityStartDate)} - ${formatDate(cityEndDate)}`;
            } else {
                buttonText.textContent = translations[currentLanguage].clickToSelectDates;
            }
        }

        function setupCityAutocomplete() {
            const cityInput = document.getElementById('cityDestination');
            const suggestionsDiv = document.getElementById('citySuggestions');
            
            cityInput.addEventListener('input', async (e) => {
                const query = e.target.value.trim();
                
                if (query.length < 2) {
                    suggestionsDiv.innerHTML = '';
                    suggestionsDiv.style.display = 'none';
                    return;
                }
                
                const suggestions = await fetchCitySuggestions(query);
                
                if (suggestions.length > 0) {
                    suggestionsDiv.innerHTML = suggestions.map(city => 
                        `<div class="autocomplete-item" onclick="selectCityFromSuggestion('${city.name}', '${city.region}', '${city.country}')">${city.name}, ${city.region !== city.name ? city.region + ', ' : ''}${city.country}</div>`
                    ).join('');
                    suggestionsDiv.style.display = 'block';
                } else {
                    suggestionsDiv.innerHTML = '';
                    suggestionsDiv.style.display = 'none';
                }
            });
        }

        function selectCityFromSuggestion(name, region, country) {
            const fullName = region !== name ? `${name}, ${region}, ${country}` : `${name}, ${country}`;
            document.getElementById('cityDestination').value = fullName;
            document.getElementById('citySuggestions').style.display = 'none';
        }

        async function saveCityToTrip() {
            const destination = document.getElementById('cityDestination').value.trim();
            
            if (!destination) {
                alert(currentLanguage === 'en' ? 'Please enter a city' : 'Por favor ingrese una ciudad');
                return;
            }
            
            if (!cityStartDate || !cityEndDate) {
                alert(currentLanguage === 'en' ? 'Please select dates for this city' : 'Por favor seleccione fechas para esta ciudad');
                return;
            }
            
            // Overlapping dates are allowed - they represent travel days between cities!
            
            // Show loading
            const saveBtn = document.querySelector('#addCityModal .btn');
            const originalText = saveBtn.textContent;
            saveBtn.textContent = currentLanguage === 'en' ? 'Adding city...' : 'Agregando ciudad...';
            saveBtn.disabled = true;
            
            // Fetch weather and socket data
            const [countryData, weatherData] = await Promise.all([
                fetchCountryData(destination),
                fetchWeatherForecast(destination, cityStartDate, cityEndDate)
            ]);
            
            let socketType = getSocketType(destination);
            let voltage = getVoltage(socketType);
            
            if (countryData) {
                if (countryData.plugTypes && countryData.plugTypes !== 'Check local' && countryData.plugTypes !== '') {
                    socketType = `Type ${countryData.plugTypes}`;
                }
                if (countryData.voltage && countryData.voltage !== 'Unknown' && countryData.voltage !== '') {
                    voltage = Array.isArray(countryData.voltage) 
                        ? `${countryData.voltage.join('/')}V` 
                        : `${countryData.voltage}V`;
                }
            }
            
            const city = {
                id: Date.now(),
                name: destination,
                startDate: cityStartDate,
                endDate: cityEndDate,
                socketType: `${socketType} • ${voltage}`,
                socketIcon: getSocketSVG(socketType),
                emoji: getCountryFlagEmoji(destination),
                weatherData: weatherData,
                activities: []
            };
            
            currentTrip.cities.push(city);
            currentTrip.cities.sort((a, b) => a.startDate.localeCompare(b.startDate));
            
            saveCurrentTrip();
            renderCities();
            renderOutfitPlanner(currentTrip);
            
            // Reset button
            saveBtn.textContent = originalText;
            saveBtn.disabled = false;
            
            closeAddCityModal();
        }

        function renderCities() {
            if (!currentTrip) return;
            
            const citiesList = document.getElementById('citiesList');
            
            if (!currentTrip.cities || currentTrip.cities.length === 0) {
                const noCitiesText = translations[currentLanguage] && translations[currentLanguage].noCitiesText 
                    ? translations[currentLanguage].noCitiesText 
                    : 'No cities added yet. Click "Add City" to start planning!';
                citiesList.innerHTML = `<p class="no-cities" id="noCitiesText">${noCitiesText}</p>`;
                return;
            }
            
            const deleteCityText = translations[currentLanguage] && translations[currentLanguage].deleteCityText 
                ? translations[currentLanguage].deleteCityText 
                : 'Delete';
            
            citiesList.innerHTML = currentTrip.cities.map(city => `
                <div class="city-card">
                    <div class="city-card-emoji">${city.emoji}</div>
                    <div class="city-card-content">
                        <div class="city-card-name">${city.name}</div>
                        <div class="city-card-dates">
                            📅 ${formatDate(city.startDate)} - ${formatDate(city.endDate)}
                        </div>
                        <div class="city-card-socket">${city.socketIcon} ${city.socketType}</div>
                    </div>
                    <div class="city-card-actions">
                        <button onclick="deleteCity(${city.id})" title="${deleteCityText}">🗑️</button>
                    </div>
                </div>
            `).join('');
        }

        function deleteCity(cityId) {
            if (!currentTrip) return;
            
            const city = currentTrip.cities.find(c => c.id === cityId);
            if (!city) return;
            
            const confirmMsg = currentLanguage === 'en' 
                ? `Are you sure you want to remove ${city.name} from this trip?` 
                : `¿Estás seguro de que quieres eliminar ${city.name} de este viaje?`;
            
            if (!confirm(confirmMsg)) return;
            
            currentTrip.cities = currentTrip.cities.filter(c => c.id !== cityId);
            
            // Remove activities associated with this city
            if (currentTrip.cities.length === 0) {
                // If no cities left, keep old activities structure (for backward compat)
            }
            
            saveCurrentTrip();
            renderCities();
            renderOutfitPlanner(currentTrip);
        }

        function getCityForDate(cities, dateStr) {
            if (!cities || cities.length === 0) return [];
            
            // Return ALL cities that match this date (overlapping dates = travel days!)
            return cities.filter(city => {
                return dateStr >= city.startDate && dateStr <= city.endDate;
            });
        }

        function switchTripTab(tabName) {
            // Remove active class from all tabs
            document.querySelectorAll('.trip-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.trip-tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to selected tab
            if (tabName === 'itinerary') {
                document.getElementById('itineraryTab').classList.add('active');
                document.getElementById('itineraryTabContent').classList.add('active');
            } else if (tabName === 'packing') {
                document.getElementById('packingTab').classList.add('active');
                document.getElementById('packingTabContent').classList.add('active');
            }
        }

        // Itinerary Timeline
        let selectedItineraryDate = null;
        let selectedItineraryTime = null;
        let selectedItineraryType = 'activity';
        let currentItineraryEmoji = '🎯';

        function renderItineraryTimeline(trip) {
            if (!trip) return;
            
            const grid = document.getElementById('itineraryGrid');
            if (!grid) return;
            
            grid.innerHTML = '';
            
            // Ensure transport array exists
            if (!trip.transport) trip.transport = [];
            if (!trip.activities) trip.activities = [];
            
            // Generate days array
            const [startYear, startMonth, startDay] = trip.startDate.split('-').map(Number);
            const [endYear, endMonth, endDay] = trip.endDate.split('-').map(Number);
            const startDate = new Date(startYear, startMonth - 1, startDay);
            const endDate = new Date(endYear, endMonth - 1, endDay);
            const totalDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
            
            const days = [];
            for (let i = 0; i < totalDays; i++) {
                const date = new Date(startYear, startMonth - 1, startDay + i);
                const dateStr = dateToString(date);
                const citiesForDay = getCityForDate(trip.cities, dateStr);
                
                // Get primary city for display (first one if multiple)
                const primaryCity = citiesForDay[0];
                const cityName = citiesForDay.map(c => c.name).join(' / ') || (currentLanguage === 'en' ? 'No city' : 'Sin ciudad');
                const countryFlag = primaryCity ? primaryCity.emoji : '🌍';
                
                days.push({
                    date: dateStr,
                    dayName: date.toLocaleDateString(currentLanguage === 'en' ? 'en-US' : 'es-ES', { weekday: 'short' }),
                    dayNum: date.getDate(),
                    monthName: date.toLocaleDateString(currentLanguage === 'en' ? 'en-US' : 'es-ES', { month: 'short' }),
                    cityName: cityName,
                    countryFlag: countryFlag
                });
            }
            
            // Create 5 header rows
            // Row 1: Month
            let monthRow = '<div class="itinerary-header-row">';
            monthRow += '<div class="itinerary-header-cell time-column month-row"></div>';
            days.forEach(day => {
                monthRow += `<div class="itinerary-header-cell month-row">${day.monthName}</div>`;
            });
            monthRow += '</div>';
            grid.innerHTML += monthRow;
            
            // Row 2: Date
            let dateRow = '<div class="itinerary-header-row">';
            dateRow += '<div class="itinerary-header-cell time-column date-row"></div>';
            days.forEach(day => {
                dateRow += `<div class="itinerary-header-cell date-row">${day.dayNum}</div>`;
            });
            dateRow += '</div>';
            grid.innerHTML += dateRow;
            
            // Row 3: Day of week
            let dayRow = '<div class="itinerary-header-row">';
            dayRow += '<div class="itinerary-header-cell time-column day-row"></div>';
            days.forEach(day => {
                dayRow += `<div class="itinerary-header-cell day-row">${day.dayName}</div>`;
            });
            dayRow += '</div>';
            grid.innerHTML += dayRow;
            
            // Row 4: Country flag
            let flagRow = '<div class="itinerary-header-row">';
            flagRow += '<div class="itinerary-header-cell time-column flag-row"></div>';
            days.forEach(day => {
                flagRow += `<div class="itinerary-header-cell flag-row">${day.countryFlag}</div>`;
            });
            flagRow += '</div>';
            grid.innerHTML += flagRow;
            
            // Row 5: City name
            let cityRow = '<div class="itinerary-header-row">';
            cityRow += `<div class="itinerary-header-cell time-column city-row">${currentLanguage === 'en' ? 'Time' : 'Hora'}</div>`;
            days.forEach(day => {
                cityRow += `<div class="itinerary-header-cell city-row">${day.cityName}</div>`;
            });
            cityRow += '</div>';
            grid.innerHTML += cityRow;
            
            // Create time rows (24 hours)
            const hours = [];
            for (let h = 0; h < 24; h++) {
                hours.push(h);
            }
            
            // Migrate old activities/transport with single 'time' field
            trip.activities.forEach(a => {
                if (a.time && !a.startTime) {
                    a.startTime = a.time;
                    a.endTime = a.time;
                    delete a.time;
                }
            });
            trip.transport.forEach(t => {
                if (t.time && !t.startTime) {
                    t.startTime = t.time;
                    t.endTime = t.time;
                    delete t.time;
                }
            });
            
            hours.forEach(hour => {
                const time12 = hour === 0 ? '12:00 AM' : hour < 12 ? `${hour}:00 AM` : hour === 12 ? '12:00 PM' : `${hour - 12}:00 PM`;
                const time24 = `${hour.toString().padStart(2, '0')}:00`;
                const currentHour = hour.toString().padStart(2, '0');
                
                let timeRow = '<div class="itinerary-body-row">';
                timeRow += `<div class="time-label">${time12}</div>`;
                
                days.forEach(day => {
                    // Get activities that span this hour
                    const activities = trip.activities.filter(a => {
                        if (!a.startTime || a.date !== day.date) return false;
                        const startHour = parseInt(a.startTime.slice(0, 2));
                        const endHour = parseInt(a.endTime ? a.endTime.slice(0, 2) : a.startTime.slice(0, 2));
                        return hour >= startHour && hour <= endHour;
                    });
                    
                    // Get transport that spans this hour
                    const transports = trip.transport.filter(t => {
                        if (!t.startTime || t.date !== day.date) return false;
                        const startHour = parseInt(t.startTime.slice(0, 2));
                        const endHour = parseInt(t.endTime ? t.endTime.slice(0, 2) : t.startTime.slice(0, 2));
                        return hour >= startHour && hour <= endHour;
                    });
                    
                    // Determine slot class based on what's in it
                    let slotClass = 'time-slot';
                    if (activities.length > 0) slotClass += ' has-activity';
                    if (transports.length > 0) slotClass += ' has-transport';
                    
                    // Only show details in the first slot of the span
                    const itemsHTML = [
                        ...activities.map(a => {
                            const isFirstSlot = currentHour === a.startTime.slice(0, 2);
                            if (!isFirstSlot) return '';
                            const timeRange = a.endTime && a.endTime !== a.startTime 
                                ? `${a.startTime.slice(0, 5)} - ${a.endTime.slice(0, 5)}` 
                                : a.startTime.slice(0, 5);
                            return `
                                <div class="time-slot-item" onclick="event.stopPropagation();">
                                    <span class="time-slot-item-emoji">${a.emoji}</span>
                                    <span>${a.name}</span>
                                    <div style="font-size: 10px; margin-top: 2px; opacity: 0.9;">${timeRange}</div>
                                </div>
                            `;
                        }),
                        ...transports.map(t => {
                            const isFirstSlot = currentHour === t.startTime.slice(0, 2);
                            if (!isFirstSlot) return '';
                            const timeRange = t.endTime && t.endTime !== t.startTime 
                                ? `${t.startTime.slice(0, 5)} - ${t.endTime.slice(0, 5)}` 
                                : t.startTime.slice(0, 5);
                            return `
                                <div class="time-slot-item transport" onclick="event.stopPropagation();">
                                    <span class="time-slot-item-emoji">${getTransportEmoji(t.type)}</span>
                                    <span>${t.from} → ${t.to}</span>
                                    <div style="font-size: 10px; margin-top: 2px; opacity: 0.9;">${timeRange}</div>
                                </div>
                            `;
                        })
                    ].join('');
                    
                    timeRow += `<div class="${slotClass}" onclick="openItineraryModal('${day.date}', '${time24}')">${itemsHTML}</div>`;
                });
                
                timeRow += '</div>';
                grid.innerHTML += timeRow;
            });
        }

        function getTransportEmoji(type) {
            const emojis = {
                flight: '✈️',
                train: '🚄',
                bus: '🚌',
                car: '🚗',
                ferry: '⛴️'
            };
            return emojis[type] || '🚗';
        }

        function openItineraryModal(date, time) {
            selectedItineraryDate = date;
            selectedItineraryTime = time;
            selectedItineraryType = 'activity';
            currentItineraryEmoji = '🎯';
            
            document.getElementById('itineraryModal').classList.remove('hidden');
            document.getElementById('activityTypeBtn').classList.add('active');
            document.getElementById('transportTypeBtn').classList.remove('active');
            document.getElementById('activityForm').style.display = 'block';
            document.getElementById('transportForm').style.display = 'none';
            
            // Clear and pre-fill form
            document.getElementById('itineraryActivityName').value = '';
            document.getElementById('itineraryActivityEmoji').textContent = '🎯';
            document.getElementById('itineraryActivityStartTime').value = time;
            document.getElementById('itineraryActivityEndTime').value = '';
            document.getElementById('itineraryTransportName').value = '';
            document.getElementById('itineraryTransportFrom').value = '';
            document.getElementById('itineraryTransportTo').value = '';
            document.getElementById('itineraryTransportCost').value = '';
            document.getElementById('itineraryTransportStartTime').value = time;
            document.getElementById('itineraryTransportEndTime').value = '';
        }

        function closeItineraryModal() {
            document.getElementById('itineraryModal').classList.add('hidden');
        }

        function selectItineraryType(type) {
            selectedItineraryType = type;
            
            if (type === 'activity') {
                document.getElementById('activityTypeBtn').classList.add('active');
                document.getElementById('transportTypeBtn').classList.remove('active');
                document.getElementById('activityForm').style.display = 'block';
                document.getElementById('transportForm').style.display = 'none';
            } else {
                document.getElementById('transportTypeBtn').classList.add('active');
                document.getElementById('activityTypeBtn').classList.remove('active');
                document.getElementById('transportForm').style.display = 'block';
                document.getElementById('activityForm').style.display = 'none';
            }
        }

        function saveItineraryItem() {
            if (!currentTrip) return;
            
            if (selectedItineraryType === 'activity') {
                const name = document.getElementById('itineraryActivityName').value.trim();
                const startTime = document.getElementById('itineraryActivityStartTime').value;
                
                if (!name) {
                    alert(currentLanguage === 'en' ? 'Please enter an activity name' : 'Por favor ingrese un nombre');
                    return;
                }
                
                if (!startTime) {
                    alert(currentLanguage === 'en' ? 'Please select a start time' : 'Por favor seleccione hora de inicio');
                    return;
                }
                
                const endTime = document.getElementById('itineraryActivityEndTime').value || startTime;
                
                const activity = {
                    id: Date.now(),
                    name: name,
                    date: selectedItineraryDate,
                    startTime: startTime,
                    endTime: endTime,
                    type: document.getElementById('itineraryActivityType').value,
                    emoji: currentItineraryEmoji,
                    isEditing: false
                };
                
                currentTrip.activities.push(activity);
            } else {
                const from = document.getElementById('itineraryTransportFrom').value.trim();
                const to = document.getElementById('itineraryTransportTo').value.trim();
                const startTime = document.getElementById('itineraryTransportStartTime').value;
                
                if (!from || !to) {
                    alert(currentLanguage === 'en' ? 'Please enter from and to locations' : 'Por favor ingrese origen y destino');
                    return;
                }
                
                if (!startTime) {
                    alert(currentLanguage === 'en' ? 'Please select a departure time' : 'Por favor seleccione hora de salida');
                    return;
                }
                
                const endTime = document.getElementById('itineraryTransportEndTime').value || startTime;
                
                if (!currentTrip.transport) currentTrip.transport = [];
                
                const transport = {
                    id: Date.now(),
                    date: selectedItineraryDate,
                    startTime: startTime,
                    endTime: endTime,
                    type: document.getElementById('itineraryTransportType').value,
                    name: document.getElementById('itineraryTransportName').value.trim(),
                    from: from,
                    to: to,
                    cost: parseFloat(document.getElementById('itineraryTransportCost').value) || 0
                };
                
                currentTrip.transport.push(transport);
            }
            
            saveCurrentTrip();
            renderItineraryTimeline(currentTrip);
            renderActivities(currentTrip);
            closeItineraryModal();
        }

        function openItineraryEmojiPicker() {
            emojiPickerContext = 'itinerary';
            openEmojiPicker();
        }

    </script>
</body>
</html>

